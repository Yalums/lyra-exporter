"use strict";(self.webpackChunklyra_exporter=self.webpackChunklyra_exporter||[]).push([[991],{3991:(t,e,n)=>{n.d(e,{PDFExportManager:()=>f});var s=n(9379),i=n(221),o=n(4239);const r={DB_NAME:"LyraFontCache",STORE_NAME:"fonts",DB_VERSION:1,status:{isLoading:!1,isLoaded:!1,error:null,progress:0},cachedFont:null,async openDB(){return new Promise((t,e)=>{const n=indexedDB.open(this.DB_NAME,this.DB_VERSION);n.onerror=()=>e(n.error),n.onsuccess=()=>t(n.result),n.onupgradeneeded=t=>{const e=t.target.result;e.objectStoreNames.contains(this.STORE_NAME)||e.createObjectStore(this.STORE_NAME,{keyPath:"id"})}})},async getFromCache(t){try{const e=await this.openDB();return new Promise((n,s)=>{const i=e.transaction(this.STORE_NAME,"readonly").objectStore(this.STORE_NAME).get(t);i.onerror=()=>s(i.error),i.onsuccess=()=>n(i.result)})}catch(e){return console.warn("[\u5b57\u4f53\u7f13\u5b58] \u8bfb\u53d6\u7f13\u5b58\u5931\u8d25:",e),null}},async saveToCache(t,e){try{const n=await this.openDB();return new Promise((s,i)=>{const o=n.transaction(this.STORE_NAME,"readwrite").objectStore(this.STORE_NAME).put({id:t,data:e,timestamp:Date.now()});o.onerror=()=>i(o.error),o.onsuccess=()=>s(!0)})}catch(n){return console.warn("[\u5b57\u4f53\u7f13\u5b58] \u4fdd\u5b58\u7f13\u5b58\u5931\u8d25:",n),!1}},async isCached(t){const e=await this.getFromCache(t);return null!==e&&void 0!==e}},a="NotoSansSC";const c={windows:[{name:"Microsoft YaHei",family:"Microsoft YaHei, \u5fae\u8f6f\u96c5\u9ed1"},{name:"SimHei",family:"SimHei, \u9ed1\u4f53"},{name:"SimSun",family:"SimSun, \u5b8b\u4f53"},{name:"KaiTi",family:"KaiTi, \u6977\u4f53"}],macos:[{name:"PingFang SC",family:"PingFang SC, \u82f9\u65b9-\u7b80"},{name:"Hiragino Sans GB",family:"Hiragino Sans GB, \u51ac\u9752\u9ed1\u4f53\u7b80\u4f53\u4e2d\u6587"},{name:"Heiti SC",family:"Heiti SC, \u9ed1\u4f53-\u7b80"},{name:"STHeiti",family:"STHeiti, \u534e\u6587\u9ed1\u4f53"}],ios:[{name:"PingFang SC",family:"PingFang SC"},{name:"Heiti SC",family:"Heiti SC"}],android:[{name:"Noto Sans CJK SC",family:"Noto Sans CJK SC"},{name:"Droid Sans Fallback",family:"Droid Sans Fallback"},{name:"Source Han Sans CN",family:"Source Han Sans CN, \u601d\u6e90\u9ed1\u4f53"}],fallback:[{name:"Noto Sans SC",family:"Noto Sans SC"},{name:"Source Han Sans CN",family:"Source Han Sans CN"},{name:"WenQuanYi Micro Hei",family:"WenQuanYi Micro Hei, \u6587\u6cc9\u9a7f\u5fae\u7c73\u9ed1"}]};function h(){var t;const e=navigator.userAgent.toLowerCase(),n=(null===(t=navigator.platform)||void 0===t?void 0:t.toLowerCase())||"";return/iphone|ipad|ipod/.test(e)?"ios":/android/.test(e)?"android":/mac/.test(n)||/macintosh/.test(e)?"macos":/win/.test(n)||/windows/.test(e)?"windows":/linux/.test(n)?"linux":"unknown"}function l(t){try{const e=document.createElement("canvas").getContext("2d"),n="\u6d4b\u8bd5\u5b57\u4f53ABCabc123",s=72;e.font="".concat(s,"px monospace");const i=e.measureText(n).width;e.font="".concat(s,"px ").concat(t,", monospace");return i!==e.measureText(n).width}catch(e){return console.warn("[PDF\u5b57\u4f53] \u5b57\u4f53\u68c0\u6d4b\u5931\u8d25: ".concat(t),e),!1}}function d(){const t=h();console.log("[PDF\u5b57\u4f53] \u68c0\u6d4b\u5230\u64cd\u4f5c\u7cfb\u7edf: ".concat(t));let e=[];switch(t){case"windows":e=[...c.windows,...c.fallback];break;case"macos":e=[...c.macos,...c.fallback];break;case"ios":e=[...c.ios,...c.macos,...c.fallback];break;case"android":e=[...c.android,...c.fallback];break;default:e=[...c.windows,...c.macos,...c.android,...c.fallback]}for(const n of e)if(l(n.family))return console.log("[PDF\u5b57\u4f53] \u2713 \u53d1\u73b0\u53ef\u7528\u7cfb\u7edf\u5b57\u4f53: ".concat(n.name)),{fontFamily:n.family,fontName:n.name};return console.warn("[PDF\u5b57\u4f53] \u2717 \u672a\u68c0\u6d4b\u5230\u53ef\u7528\u7684\u7cfb\u7edf\u4e2d\u6587\u5b57\u4f53"),null}const T={"Microsoft YaHei":{windows:["C:/Windows/Fonts/msyh.ttc","C:/Windows/Fonts/msyh.ttf","C:/Windows/Fonts/msyhbd.ttc","C:/Windows/Fonts/msyhbd.ttf"]},SimHei:{windows:["C:/Windows/Fonts/simhei.ttf"]},SimSun:{windows:["C:/Windows/Fonts/simsun.ttc"]},"PingFang SC":{macos:["/System/Library/Fonts/PingFang.ttc","/Library/Fonts/PingFang.ttc"]},"Hiragino Sans GB":{macos:["/System/Library/Fonts/Hiragino Sans GB.ttc","/Library/Fonts/Hiragino Sans GB.ttc"]},"Noto Sans CJK SC":{android:["/system/fonts/NotoSansCJK-Regular.ttc","/system/fonts/NotoSansSC-Regular.otf"],linux:["/usr/share/fonts/opentype/noto/NotoSansCJK-Regular.ttc","/usr/share/fonts/noto-cjk/NotoSansCJK-Regular.ttc"]},"Droid Sans Fallback":{android:["/system/fonts/DroidSansFallback.ttf"]}};async function p(t){console.log("[PDF\u5b57\u4f53] \u5f00\u59cb\u68c0\u6d4b\u53ef\u7528\u5b57\u4f53...");const e=d();if(e){console.log("[PDF\u5b57\u4f53] \u2713 \u68c0\u6d4b\u5230\u7cfb\u7edf\u5b57\u4f53: ".concat(e.fontName)),console.log("[PDF\u5b57\u4f53] \u5b57\u4f53\u5bb6\u65cf: ".concat(e.fontFamily));const n=await async function(t,e){const n=h(),s=T[e];if(!s)return console.log("[PDF\u5b57\u4f53] \u6ca1\u6709 ".concat(e," \u7684\u7cfb\u7edf\u8def\u5f84\u914d\u7f6e")),null;const i=s[n]||[];if(0===i.length)return console.log("[PDF\u5b57\u4f53] ".concat(n," \u7cfb\u7edf\u6ca1\u6709 ").concat(e," \u7684\u8def\u5f84\u914d\u7f6e")),null;for(const r of i)try{console.log("[PDF\u5b57\u4f53] \u5c1d\u8bd5\u52a0\u8f7d\u7cfb\u7edf\u5b57\u4f53: ".concat(r));const n=await fetch("file://".concat(r)).catch(()=>null);if(!n||!n.ok)continue;const s=await n.arrayBuffer(),i=new DataView(s).getUint32(0,!1);if(1953784678!==i&&65536!==i&&1953658213!==i&&1330926671!==i){console.warn("[PDF\u5b57\u4f53] \u6587\u4ef6\u683c\u5f0f\u4e0d\u6b63\u786e: ".concat(r));continue}const o=new Uint8Array(s);let a="";const c=8192;for(let t=0;t<o.byteLength;t+=c){const e=o.subarray(t,Math.min(t+c,o.byteLength));a+=String.fromCharCode.apply(null,e)}const h=btoa(a),l=r.split("/").pop();return t.addFileToVFS(l,h),t.addFont(l,e,"normal"),t.setFont(e,"normal"),console.log("[PDF\u5b57\u4f53] \u2713 \u7cfb\u7edf\u5b57\u4f53\u52a0\u8f7d\u6210\u529f: ".concat(r)),{fontName:e,availableWeights:["normal"]}}catch(o){continue}return console.log("[PDF\u5b57\u4f53] \u65e0\u6cd5\u4ece\u7cfb\u7edf\u8def\u5f84\u52a0\u8f7d\u5b57\u4f53 ".concat(e)),console.log("[PDF\u5b57\u4f53] \u8fd9\u662f\u9884\u671f\u7684\u884c\u4e3a\uff0c\u6d4f\u89c8\u5668\u65e0\u6cd5\u76f4\u63a5\u8bbf\u95ee\u672c\u5730\u6587\u4ef6\u7cfb\u7edf"),null}(t,e.fontName);if(n)return console.log("[PDF\u5b57\u4f53] \u2713 \u7cfb\u7edf\u5b57\u4f53\u52a0\u8f7d\u6210\u529f: ".concat(n.fontName)),{success:!0,fontName:n.fontName,availableWeights:n.availableWeights,isSystemFont:!0,systemFontInfo:e};console.log("[PDF\u5b57\u4f53] \u26a0 \u65e0\u6cd5\u52a0\u8f7d\u7cfb\u7edf\u5b57\u4f53\u6587\u4ef6\uff0c\u5c06\u56de\u9000\u5230\u9879\u76ee\u5b57\u4f53")}if(r.cachedFont){console.log("[PDF\u5b57\u4f53] \u4f7f\u7528\u9884\u52a0\u8f7d\u7684\u7f13\u5b58\u5b57\u4f53...");try{const e=a,n="".concat(e,".ttf");return t.addFileToVFS(n,r.cachedFont),t.addFont(n,e,"normal"),t.setFont(e,"normal"),console.log("[PDF\u5b57\u4f53] \u2713 \u7f13\u5b58\u5b57\u4f53\u52a0\u8f7d\u6210\u529f: ".concat(e)),{success:!0,fontName:e,availableWeights:["normal"],isSystemFont:!1,isCDNFont:!0}}catch(n){console.error("[PDF\u5b57\u4f53] \u7f13\u5b58\u5b57\u4f53\u52a0\u8f7d\u5931\u8d25:",n)}}return console.error("[PDF\u5b57\u4f53] \u2717 \u5b57\u4f53\u672a\u5c31\u7eea"),console.error("[PDF\u5b57\u4f53] \u8bf7\u7b49\u5f85\u5b57\u4f53\u4e0b\u8f7d\u5b8c\u6210\u540e\u518d\u5bfc\u51fa PDF"),{success:!1,fontName:"helvetica",availableWeights:["normal","bold","italic"],isSystemFont:!1,fontNotReady:!0}}const u={FONT_SIZE_TITLE:20,FONT_SIZE_H1:16,FONT_SIZE_H2:14,FONT_SIZE_SENDER:12,FONT_SIZE_BODY:10,FONT_SIZE_CODE:9,FONT_SIZE_TIMESTAMP:8,FONT_SIZE_HEADER:8,FONT_SIZE_FOOTER:8,COLOR_SENDER_HUMAN:[0,102,204],COLOR_SENDER_ASSISTANT:[102,102,102],COLOR_TIMESTAMP:[150,150,150],COLOR_CODE_BG:[245,245,245],COLOR_SECTION_BG:[250,250,250],COLOR_TEXT:[0,0,0],COLOR_HEADER:[100,100,100],COLOR_FOOTER:[150,150,150],COLOR_BORDER:[200,200,200],MARGIN_LEFT:15,MARGIN_RIGHT:15,MARGIN_TOP:15,MARGIN_BOTTOM:25,LINE_HEIGHT:5,SECTION_SPACING:8,MESSAGE_SPACING:10,FOOTER_HEIGHT:15,PAGE_WIDTH:210,PAGE_HEIGHT:297};class f{constructor(){this.pdf=null,this.currentY=u.MARGIN_TOP,this.config={},this.useChineseFont=!1,this.chineseFontName="helvetica",this.availableFontWeights=[],this.isSystemFont=!1,this.meta=null,this.exportDate=null,this.messageAnchors=[]}safeSetFont(t){let e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"normal";try{if(this.availableFontWeights.includes(e))return this.pdf.setFont(t,e),!0;if(console.warn("[PDF\u5bfc\u51fa] \u5b57\u4f53\u53d8\u4f53 ".concat(e," \u4e0d\u53ef\u7528\uff0c\u5c1d\u8bd5\u56de\u9000...")),("bold"===e||"bolditalic"===e)&&this.availableFontWeights.includes("normal"))return this.pdf.setFont(t,"normal"),console.log("[PDF\u5bfc\u51fa] \u2713 \u56de\u9000\u5230 normal \u5b57\u4f53"),!1;if("italic"===e||"bolditalic"===e){if(this.availableFontWeights.includes("light"))return this.pdf.setFont(t,"light"),console.log("[PDF\u5bfc\u51fa] \u2713 \u659c\u4f53\u56de\u9000\u5230 light \u5b57\u4f53"),!1;if(this.availableFontWeights.includes("normal"))return this.pdf.setFont(t,"normal"),console.log("[PDF\u5bfc\u51fa] \u2713 \u659c\u4f53\u56de\u9000\u5230 normal \u5b57\u4f53"),!1}if(this.availableFontWeights.length>0){const e=this.availableFontWeights[0];return this.pdf.setFont(t,e),console.log("[PDF\u5bfc\u51fa] \u2713 \u56de\u9000\u5230 ".concat(e," \u5b57\u4f53")),!1}return this.pdf.setFont(t,"normal"),console.log("[PDF\u5bfc\u51fa] \u2713 \u56de\u9000\u5230 normal \u5b57\u4f53"),!1}catch(n){return console.error("[PDF\u5bfc\u51fa] \u8bbe\u7f6e\u5b57\u4f53\u5931\u8d25:",n),this.pdf.setFont(t||this.chineseFontName),!1}}cleanText(t){if(!t||"string"!==typeof t)return"";try{let e=t.normalize("NFC");return e=e.replace(/[\x00-\x08\x0B\x0C\x0E-\x1F\x7F-\x9F]/g,""),e=e.replace(/[\u200B-\u200F\u2060\uFEFF]/g,""),e=e.replace(/[\uE000-\uF8FF]/g,""),e}catch(e){return console.error("[PDF\u5bfc\u51fa] \u6587\u672c\u6e05\u7406\u5931\u8d25:",e),t.replace(/[\x00-\x08\x0B\x0C\x0E-\x1F\x7F]/g,"")}}async exportToPDF(t,e){var n,c,h,l,d,T;let f=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};if(console.log("[PDF\u5bfc\u51fa] \u5f00\u59cb\u5bfc\u51fa",{messageCount:t.length,config:f}),!r.status.isLoaded||null===r.cachedFont){const t={isLoading:r.status.isLoading,isLoaded:r.status.isLoaded,progress:r.status.progress,error:r.status.error,fontName:a};let e="PDF \u5b57\u4f53\u5c1a\u672a\u52a0\u8f7d\u5b8c\u6210\uff0c\u65e0\u6cd5\u5bfc\u51fa\u3002\n\n";throw t.isLoading?e+="\u5b57\u4f53\u6b63\u5728\u4e0b\u8f7d\u4e2d (".concat(t.progress,"%)\uff0c\u8bf7\u7a0d\u540e\u518d\u8bd5\u3002"):t.error?e+="\u5b57\u4f53\u4e0b\u8f7d\u5931\u8d25: ".concat(t.error,"\n\n\u8bf7\u68c0\u67e5\u7f51\u7edc\u8fde\u63a5\u540e\u5237\u65b0\u9875\u9762\u91cd\u8bd5\u3002"):e+="\u8bf7\u5237\u65b0\u9875\u9762\u4ee5\u5f00\u59cb\u4e0b\u8f7d\u5b57\u4f53\u3002",new Error(e)}this.meta=e,this.exportDate=o.Nq.formatDateTime(new Date),this.messageAnchors=[],this.config=(0,s.A)({includeThinking:null===(n=f.includeThinking)||void 0===n||n,includeArtifacts:null===(c=f.includeArtifacts)||void 0===c||c,includeTimestamps:null!==(h=f.includeTimestamps)&&void 0!==h&&h,includeTools:null===(l=f.includeTools)||void 0===l||l,includeCitations:null===(d=f.includeCitations)||void 0===d||d,highQuality:null!==(T=f.highQuality)&&void 0!==T&&T},f),this.pdf=new i.uE({orientation:"portrait",unit:"mm",format:"a4",compress:!0});try{console.log("[PDF\u5bfc\u51fa] \u5f00\u59cb\u52a0\u8f7d\u4e2d\u6587\u5b57\u4f53...");const t=await p(this.pdf);if(this.useChineseFont=t.success,this.chineseFontName=t.fontName,this.availableFontWeights=t.availableWeights||[],this.isSystemFont=t.isSystemFont||!1,this.useChineseFont){const e=this.isSystemFont?"\u7cfb\u7edf\u5b57\u4f53":"\u9879\u76ee\u5b57\u4f53";console.log("[PDF\u5bfc\u51fa] \u4e2d\u6587\u5b57\u4f53\u52a0\u8f7d\u6210\u529f: ".concat(this.chineseFontName," (").concat(e,")")),console.log("[PDF\u5bfc\u51fa] \u53ef\u7528\u5b57\u4f53\u53d8\u4f53: ".concat(this.availableFontWeights.join(", "))),t.systemFontInfo&&console.log("[PDF\u5bfc\u51fa] \u7cfb\u7edf\u5b57\u4f53\u4fe1\u606f: ".concat(t.systemFontInfo.fontName))}else console.warn("[PDF\u5bfc\u51fa] \u4e2d\u6587\u5b57\u4f53\u52a0\u8f7d\u5931\u8d25\uff0c\u5c06\u4f7f\u7528\u9ed8\u8ba4\u5b57\u4f53\uff08\u4e2d\u6587\u53ef\u80fd\u663e\u793a\u4e3a\u65b9\u6846\uff09"),t.systemFontAvailable&&(console.warn("[PDF\u5bfc\u51fa] \u63d0\u793a\uff1a\u68c0\u6d4b\u5230\u7cfb\u7edf\u6709\u4e2d\u6587\u5b57\u4f53\uff0c\u4f46\u65e0\u6cd5\u5728\u6d4f\u89c8\u5668\u73af\u5883\u4e2d\u76f4\u63a5\u4f7f\u7528"),console.warn("[PDF\u5bfc\u51fa] \u5efa\u8bae\uff1a\u8bf7\u786e\u4fdd\u9879\u76ee public/fonts/ \u76ee\u5f55\u4e0b\u6709\u4e2d\u6587\u5b57\u4f53\u6587\u4ef6"))}catch(I){console.error("[PDF\u5bfc\u51fa] \u5b57\u4f53\u52a0\u8f7d\u5f02\u5e38:",I),this.useChineseFont=!1,this.chineseFontName="helvetica",this.availableFontWeights=[],this.isSystemFont=!1}this.pdf.setFont(this.chineseFontName),this.renderTitle(e),this.renderMetadata(e),this.currentY+=u.SECTION_SPACING;const E=t.length>1;let _=0;E&&(this.pdf.addPage(),_=this.pdf.internal.getCurrentPageInfo().pageNumber,this.currentY=u.MARGIN_TOP);for(let s=0;s<t.length;s++)E&&0===s&&(this.pdf.addPage(),this.currentY=u.MARGIN_TOP),this.renderMessage(t[s],s+1);E&&(console.log("[PDF\u5bfc\u51fa] \u751f\u6210\u76ee\u5f55..."),this.renderTOCWithLinks(_,t)),console.log("[PDF\u5bfc\u51fa] \u6dfb\u52a0PDF\u4e66\u7b7e..."),this.addBookmarks(),console.log("[PDF\u5bfc\u51fa] \u6dfb\u52a0\u9875\u811a..."),this.addFooters();const g=this.generateFileName(e);return this.pdf.save(g),console.log("[PDF\u5bfc\u51fa] \u5bfc\u51fa\u5b8c\u6210:",g),!0}renderTitle(t){this.pdf.setFontSize(u.FONT_SIZE_TITLE),this.pdf.setTextColor(...u.COLOR_TEXT);const e=t.name||"Conversation",n=this.cleanText(e),s=u.PAGE_WIDTH-u.MARGIN_LEFT-u.MARGIN_RIGHT;let i;try{i=this.pdf.splitTextToSize(n,s)}catch(o){console.error("[PDF\u5bfc\u51fa] \u6807\u9898\u5206\u5272\u5931\u8d25,\u4f7f\u7528\u539f\u59cb\u6807\u9898:",o),i=[n]}i.forEach(t=>{this.checkPageBreak(u.FONT_SIZE_TITLE);const e=this.cleanText(t);e&&e.trim().length>0&&this.pdf.text(e,u.MARGIN_LEFT,this.currentY),this.currentY+=1.5*u.LINE_HEIGHT}),this.currentY+=u.SECTION_SPACING}renderMetadata(t){this.pdf.setFontSize(u.FONT_SIZE_TIMESTAMP),this.pdf.setTextColor(...u.COLOR_TIMESTAMP);const e=[];t.platform&&e.push("Platform: ".concat(t.platform)),t.created_at&&e.push("Created: ".concat(t.created_at)),t.updated_at&&e.push("Updated: ".concat(t.updated_at)),e.push("Exported: ".concat(o.Nq.formatDateTime(new Date))),e.forEach(t=>{this.checkPageBreak(u.FONT_SIZE_TIMESTAMP),this.pdf.text(t,u.MARGIN_LEFT,this.currentY),this.currentY+=u.LINE_HEIGHT})}renderTOCWithLinks(t,e){this.pdf.setPage(t),this.currentY=u.MARGIN_TOP,this.pdf.setFontSize(u.FONT_SIZE_H1),this.pdf.setTextColor(...u.COLOR_TEXT),this.pdf.text("Table of Contents",u.MARGIN_LEFT,this.currentY),this.currentY+=2*u.LINE_HEIGHT,this.pdf.setDrawColor(...u.COLOR_BORDER),this.pdf.setLineWidth(.3),this.pdf.line(u.MARGIN_LEFT,this.currentY,u.PAGE_WIDTH-u.MARGIN_RIGHT,this.currentY),this.currentY+=u.LINE_HEIGHT,this.pdf.setFontSize(u.FONT_SIZE_BODY);this.messageAnchors.forEach((t,n)=>{var s;const i=e[n];if(!i)return;this.checkPageBreak(2*u.FONT_SIZE_BODY);const o="".concat(t.index,"."),r="human"===t.sender?"Human":"Assistant";let a=t.title||"";a=this.cleanText(a),a=a.replace(/\n/g," ").substring(0,50),a.length>=50&&(a+="...");let c="";null!==(s=i.branchInfo)&&void 0!==s&&s.isBranchPoint&&(c=" [Branch ".concat(i.branchInfo.childCount,"]"));const h="".concat(o," ").concat(r).concat(c),l="p.".concat(t.page),d="human"===t.sender?u.COLOR_SENDER_HUMAN:u.COLOR_SENDER_ASSISTANT;this.pdf.setTextColor(...d);const T=this.pdf.getTextWidth(l),p=u.PAGE_WIDTH-u.MARGIN_RIGHT-T,f=this.currentY;this.pdf.textWithLink(h,u.MARGIN_LEFT+5,f,{pageNumber:t.page}),this.pdf.setTextColor(...u.COLOR_TIMESTAMP),this.pdf.textWithLink(l,p,f,{pageNumber:t.page}),a&&(this.pdf.setFontSize(u.FONT_SIZE_TIMESTAMP),this.pdf.setTextColor(...u.COLOR_TIMESTAMP),this.currentY+=u.LINE_HEIGHT,this.checkPageBreak(u.FONT_SIZE_TIMESTAMP),this.pdf.text(a,u.MARGIN_LEFT+10,this.currentY),this.pdf.setFontSize(u.FONT_SIZE_BODY)),this.currentY+=1.5*u.LINE_HEIGHT})}renderMessage(t,e){var n,s,i,o;this.checkPageBreak(u.FONT_SIZE_SENDER+u.MESSAGE_SPACING);const r=this.pdf.internal.getCurrentPageInfo().pageNumber,a=this.currentY;this.messageAnchors.push({index:e,page:r,y:a,sender:t.sender,title:t.display_text?t.display_text.substring(0,50):""}),this.renderSender(t,e),this.config.includeTimestamps&&t.timestamp&&this.renderTimestamp(t.timestamp),t.thinking&&this.config.includeThinking&&"human"!==t.sender&&this.renderThinking(t.thinking),t.display_text&&this.renderBody(t.display_text),(null===(n=t.attachments)||void 0===n?void 0:n.length)>0&&"human"===t.sender&&this.renderAttachments(t.attachments),(null===(s=t.artifacts)||void 0===s?void 0:s.length)>0&&this.config.includeArtifacts&&"human"!==t.sender&&t.artifacts.forEach(t=>{this.renderArtifact(t)}),(null===(i=t.tools)||void 0===i?void 0:i.length)>0&&this.config.includeTools&&t.tools.forEach(t=>{this.renderTool(t)}),(null===(o=t.citations)||void 0===o?void 0:o.length)>0&&this.config.includeCitations&&this.renderCitations(t.citations),this.currentY+=u.MESSAGE_SPACING}renderSender(t,e){var n;this.pdf.setFontSize(u.FONT_SIZE_SENDER);const s="human"===t.sender?u.COLOR_SENDER_HUMAN:u.COLOR_SENDER_ASSISTANT;this.pdf.setTextColor(...s);const i="human"===t.sender?"Human":"Assistant",o="".concat(e,". ").concat(i);let r=o;if(null!==(n=t.branchInfo)&&void 0!==n&&n.isBranchPoint){r=o+" [Branch ".concat(t.branchInfo.childCount,"]")}const a=this.cleanText(r);a&&a.trim().length>0&&this.pdf.text(a,u.MARGIN_LEFT,this.currentY),this.currentY+=1.2*u.LINE_HEIGHT}renderTimestamp(t){this.pdf.setFontSize(u.FONT_SIZE_TIMESTAMP),this.pdf.setTextColor(...u.COLOR_TIMESTAMP),this.pdf.text(t,u.MARGIN_LEFT,this.currentY),this.currentY+=u.LINE_HEIGHT}renderBody(t){this.pdf.setFontSize(u.FONT_SIZE_BODY),this.pdf.setTextColor(...u.COLOR_TEXT);const e=u.PAGE_WIDTH-u.MARGIN_LEFT-u.MARGIN_RIGHT;this.parseTextWithCodeBlocksAndLatex(t).forEach(t=>{"code"===t.type?this.renderCodeBlock(t.content,t.language):"latex-block"===t.type?this.renderLatexBlock(t.content):"latex-inline"===t.type?this.renderLatexInline(t.content,e):this.renderMarkdownText(t.content,e)}),this.currentY+=u.LINE_HEIGHT}renderPlainText(t,e){if(!t||0===t.trim().length)return void(this.currentY+=u.LINE_HEIGHT);const n=this.cleanText(t);if(!n||0===n.trim().length)return console.warn("[PDF\u5bfc\u51fa] \u6587\u672c\u6e05\u7406\u540e\u4e3a\u7a7a\uff0c\u8df3\u8fc7"),void(this.currentY+=u.LINE_HEIGHT);let s;try{s=this.pdf.splitTextToSize(n,e)}catch(i){console.error("[PDF\u5bfc\u51fa] splitTextToSize\u5931\u8d25\uff0c\u4f7f\u7528\u7b80\u5355\u6362\u884c:",i),s=n.split("\n")}s.forEach(t=>{this.checkPageBreak(u.FONT_SIZE_BODY);const e=this.cleanText(t);e&&e.trim().length>0&&this.pdf.text(e,u.MARGIN_LEFT,this.currentY),this.currentY+=u.LINE_HEIGHT})}renderCodeBlock(t){let e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"";this.checkPageBreak(u.FONT_SIZE_CODE+2*u.SECTION_SPACING);const n=u.PAGE_WIDTH-u.MARGIN_LEFT-u.MARGIN_RIGHT,s=n-8-8,i=this.cleanText(t),o=this.cleanText(e);if(o){this.pdf.setFontSize(u.FONT_SIZE_TIMESTAMP),this.pdf.setTextColor(100,100,100);const t=o.toUpperCase(),e=this.pdf.getTextWidth(t)+4;this.pdf.setFillColor(220,220,220),this.pdf.roundedRect(u.MARGIN_LEFT,this.currentY-3,e,5,1,1,"F"),this.pdf.text(t,u.MARGIN_LEFT+2,this.currentY),this.currentY+=1.2*u.LINE_HEIGHT}this.pdf.setFontSize(u.FONT_SIZE_CODE),this.pdf.setFont(this.chineseFontName);const r=i.split("\n"),a=[];r.forEach(t=>{if(!t)return void a.push({text:"",lineNumber:a.length+1});const e=this.cleanText(t);if(e)try{this.pdf.splitTextToSize(e,s).forEach((t,e)=>{a.push({text:t,lineNumber:0===e?a.length+1:null})})}catch(n){a.push({text:e,lineNumber:a.length+1})}else a.push({text:"",lineNumber:a.length+1})});const c=this.currentY,h=this.pdf.internal.getCurrentPageInfo().pageNumber;let l=!0;const d=Math.min(a.length*u.LINE_HEIGHT+6,u.PAGE_HEIGHT-u.MARGIN_BOTTOM-this.currentY);this.pdf.setFillColor(248,248,248),this.pdf.rect(u.MARGIN_LEFT,c-3,n,d,"F"),this.currentY=c,a.forEach((t,e)=>{let{text:s,lineNumber:i}=t;if(this.currentY+u.FONT_SIZE_CODE>u.PAGE_HEIGHT-u.MARGIN_BOTTOM){this.pdf.setDrawColor(200,200,200),this.pdf.setLineWidth(.3);const t=this.currentY;this.pdf.line(u.MARGIN_LEFT,c-3,u.MARGIN_LEFT,t),this.pdf.line(u.MARGIN_LEFT+n,c-3,u.MARGIN_LEFT+n,t),this.pdf.addPage(),this.currentY=u.MARGIN_TOP;const s=a.length-e,i=Math.min(s*u.LINE_HEIGHT+3,u.PAGE_HEIGHT-u.MARGIN_BOTTOM-this.currentY);this.pdf.setFillColor(248,248,248),this.pdf.rect(u.MARGIN_LEFT,this.currentY-3,n,i,"F"),l=!1}if(null!==i){this.pdf.setFontSize(u.FONT_SIZE_CODE-1),this.pdf.setTextColor(150,150,150);const t=String(i).padStart(3," ");this.pdf.text(t,u.MARGIN_LEFT+1,this.currentY)}this.pdf.setFontSize(u.FONT_SIZE_CODE),this.pdf.setTextColor(50,50,50);const o=this.cleanText(s);null!==o&&void 0!==o&&this.pdf.text(o,u.MARGIN_LEFT+8+2,this.currentY),this.currentY+=u.LINE_HEIGHT});const T=this.pdf.internal.getCurrentPageInfo().pageNumber;for(let p=h;p<=T;p++){this.pdf.setPage(p);const t=p===h,e=p===T;let s,i;t&&e?(s=c-3,i=this.currentY+3):t?(s=c-3,i=u.PAGE_HEIGHT-u.MARGIN_BOTTOM):e?(s=u.MARGIN_TOP-3,i=this.currentY+3):(s=u.MARGIN_TOP-3,i=u.PAGE_HEIGHT-u.MARGIN_BOTTOM),this.pdf.setDrawColor(200,200,200),this.pdf.setLineWidth(.3),t&&e?this.pdf.roundedRect(u.MARGIN_LEFT,s,n,i-s,1.5,1.5,"S"):(this.pdf.line(u.MARGIN_LEFT,s,u.MARGIN_LEFT,i),this.pdf.line(u.MARGIN_LEFT+n,s,u.MARGIN_LEFT+n,i),t&&this.pdf.line(u.MARGIN_LEFT,s,u.MARGIN_LEFT+n,s),e&&this.pdf.line(u.MARGIN_LEFT,i,u.MARGIN_LEFT+n,i)),this.pdf.setDrawColor(220,220,220),this.pdf.setLineWidth(.2),this.pdf.line(u.MARGIN_LEFT+8,s,u.MARGIN_LEFT+8,i)}this.pdf.setPage(T),this.pdf.setFont(this.chineseFontName),this.pdf.setTextColor(...u.COLOR_TEXT),this.currentY+=u.SECTION_SPACING}groupCodeLinesByPage(t){const e=[];let n=null;const s=u.PAGE_HEIGHT-u.MARGIN_BOTTOM;let i=this.currentY,o=this.pdf.internal.getCurrentPageInfo().pageNumber;return t.forEach(t=>{i+u.FONT_SIZE_CODE>s&&(o++,i=u.MARGIN_TOP,n=null),n&&n.page===o||(n={page:o,startY:i,lines:[]},e.push(n)),n.lines.push(t),i+=u.LINE_HEIGHT}),e}renderLatexBlock(t){this.checkPageBreak(u.FONT_SIZE_BODY+2*u.SECTION_SPACING);const e=u.PAGE_WIDTH-u.MARGIN_LEFT-u.MARGIN_RIGHT,n=this.cleanText(t),s=this.convertLatexToUnicode(n);this.pdf.setFontSize(u.FONT_SIZE_TIMESTAMP),this.pdf.setTextColor(70,130,180);const i="MATH",o=this.pdf.getTextWidth(i)+4;let r;this.pdf.setFillColor(230,240,250),this.pdf.roundedRect(u.MARGIN_LEFT,this.currentY-3,o,5,1,1,"F"),this.pdf.text(i,u.MARGIN_LEFT+2,this.currentY),this.currentY+=1.2*u.LINE_HEIGHT,this.pdf.setFontSize(u.FONT_SIZE_BODY),this.pdf.setFont(this.chineseFontName);try{r=this.pdf.splitTextToSize(s,e-8)}catch(d){r=s.split("\n")}const a=this.currentY,c=this.pdf.internal.getCurrentPageInfo().pageNumber,h=Math.min(r.length*u.LINE_HEIGHT+6,u.PAGE_HEIGHT-u.MARGIN_BOTTOM-this.currentY);this.pdf.setFillColor(245,250,255),this.pdf.rect(u.MARGIN_LEFT,a-3,e,h,"F"),this.currentY=a,r.forEach((t,n)=>{if(this.currentY+u.FONT_SIZE_BODY>u.PAGE_HEIGHT-u.MARGIN_BOTTOM){this.pdf.addPage(),this.currentY=u.MARGIN_TOP;const t=r.length-n,s=Math.min(t*u.LINE_HEIGHT+3,u.PAGE_HEIGHT-u.MARGIN_BOTTOM-this.currentY);this.pdf.setFillColor(245,250,255),this.pdf.rect(u.MARGIN_LEFT,this.currentY-3,e,s,"F")}this.pdf.setTextColor(30,60,120);const s=this.cleanText(t);s&&s.trim().length>0&&this.pdf.text(s,u.MARGIN_LEFT+4,this.currentY),this.currentY+=u.LINE_HEIGHT});const l=this.pdf.internal.getCurrentPageInfo().pageNumber;for(let T=c;T<=l;T++){this.pdf.setPage(T);const t=T===c,n=T===l;let s,i;t&&n?(s=a-3,i=this.currentY+3):t?(s=a-3,i=u.PAGE_HEIGHT-u.MARGIN_BOTTOM):n?(s=u.MARGIN_TOP-3,i=this.currentY+3):(s=u.MARGIN_TOP-3,i=u.PAGE_HEIGHT-u.MARGIN_BOTTOM),this.pdf.setDrawColor(180,210,240),this.pdf.setLineWidth(.4),t&&n?this.pdf.roundedRect(u.MARGIN_LEFT,s,e,i-s,1.5,1.5,"S"):(this.pdf.line(u.MARGIN_LEFT,s,u.MARGIN_LEFT,i),this.pdf.line(u.MARGIN_LEFT+e,s,u.MARGIN_LEFT+e,i),t&&this.pdf.line(u.MARGIN_LEFT,s,u.MARGIN_LEFT+e,s),n&&this.pdf.line(u.MARGIN_LEFT,i,u.MARGIN_LEFT+e,i))}this.pdf.setPage(l),this.pdf.setTextColor(...u.COLOR_TEXT),this.currentY+=u.SECTION_SPACING}groupLatexLinesByPage(t){const e=[];let n=null;const s=u.PAGE_HEIGHT-u.MARGIN_BOTTOM;let i=this.currentY,o=this.pdf.internal.getCurrentPageInfo().pageNumber;return t.forEach(t=>{i+u.FONT_SIZE_BODY>s&&(o++,i=u.MARGIN_TOP,n=null),n&&n.page===o||(n={page:o,startY:i,lines:[]},e.push(n)),n.lines.push(t),i+=u.LINE_HEIGHT}),e}renderLatexInline(t,e){const n=this.cleanText(t),s=this.convertLatexToUnicode(n);this.pdf.setFontSize(u.FONT_SIZE_BODY);const i="\u27e8".concat(s,"\u27e9");this.pdf.setTextColor(70,130,180);try{this.pdf.splitTextToSize(i,e).forEach(t=>{this.checkPageBreak(u.FONT_SIZE_BODY);const e=this.cleanText(t);e&&e.trim().length>0&&this.pdf.text(e,u.MARGIN_LEFT,this.currentY),this.currentY+=u.LINE_HEIGHT})}catch(o){this.pdf.text(i,u.MARGIN_LEFT,this.currentY),this.currentY+=u.LINE_HEIGHT}this.pdf.setTextColor(...u.COLOR_TEXT)}renderThinking(t){this.renderSection("\ud83d\udcad Thinking",t,u.COLOR_SECTION_BG)}renderArtifact(t){const e="\ud83d\udcc4 Artifact: ".concat(t.title||"Untitled"),n=t.content||"";this.renderSection(e,n,u.COLOR_SECTION_BG)}renderTool(t){const e="\ud83d\udd27 Tool: ".concat(t.name||"Unknown"),n="Input: ".concat(JSON.stringify(t.input,null,2),"\n\nOutput: ").concat(t.output||"N/A");this.renderSection(e,n,u.COLOR_SECTION_BG)}renderCitations(t){const e=t.map((t,e)=>"[".concat(e+1,"] ").concat(t.title||t.url||"Unknown")).join("\n");this.renderSection("\ud83d\udcda Citations",e,u.COLOR_SECTION_BG)}renderAttachments(t){const e=t.map((t,e)=>"[".concat(e+1,"] ").concat(t.file_name||t.name||"file"," (").concat(t.file_type||t.type||"unknown",")")).join("\n");this.renderSection("\ud83d\udcce Attachments",e,u.COLOR_SECTION_BG)}renderSection(t,e,n){this.checkPageBreak(u.FONT_SIZE_H2+2*u.SECTION_SPACING);const s=u.PAGE_WIDTH-u.MARGIN_LEFT-u.MARGIN_RIGHT,i=this.cleanText(t),o=this.cleanText(e);let r;try{r=this.pdf.splitTextToSize(o,s-4)}catch(c){console.error("[PDF\u5bfc\u51fa] \u533a\u5757\u5185\u5bb9\u5206\u5272\u5931\u8d25:",c),r=o.split("\n")}const a=u.LINE_HEIGHT*(r.length+2);this.pdf.setFillColor(...n),this.pdf.rect(u.MARGIN_LEFT,this.currentY-3,s,a,"F"),this.pdf.setFontSize(u.FONT_SIZE_H2),this.pdf.setTextColor(...u.COLOR_TEXT),i&&i.trim().length>0&&this.pdf.text(i,u.MARGIN_LEFT+2,this.currentY),this.currentY+=1.2*u.LINE_HEIGHT,this.pdf.setFontSize(u.FONT_SIZE_BODY),r.forEach(t=>{this.checkPageBreak(u.FONT_SIZE_BODY);const e=this.cleanText(t);e&&e.trim().length>0&&this.pdf.text(e,u.MARGIN_LEFT+2,this.currentY),this.currentY+=u.LINE_HEIGHT}),this.currentY+=u.SECTION_SPACING}renderFooter(t,e){const n=this.currentY,s=this.pdf.internal.getFontSize();this.pdf.setFontSize(u.FONT_SIZE_FOOTER),this.pdf.setTextColor(...u.COLOR_FOOTER);const i=u.PAGE_HEIGHT-10;this.pdf.setDrawColor(...u.COLOR_BORDER),this.pdf.setLineWidth(.1),this.pdf.line(u.MARGIN_LEFT,u.PAGE_HEIGHT-u.FOOTER_HEIGHT,u.PAGE_WIDTH-u.MARGIN_RIGHT,u.PAGE_HEIGHT-u.FOOTER_HEIGHT);const o="Exported: ".concat(this.exportDate);this.pdf.text(o,u.MARGIN_LEFT,i);const r="".concat(t," / ").concat(e),a=this.pdf.getTextWidth(r);this.pdf.text(r,u.PAGE_WIDTH-u.MARGIN_RIGHT-a,i),this.pdf.setFontSize(s),this.pdf.setTextColor(...u.COLOR_TEXT),this.currentY=n}addBookmarks(){if(0!==this.messageAnchors.length)try{this.messageAnchors.forEach(t=>{const e="human"===t.sender?"Human":"Assistant",n="".concat(t.index,". ").concat(e);this.pdf.outline&&this.pdf.outline.add(null,n,{pageNumber:t.page})})}catch(t){console.warn("[PDF\u5bfc\u51fa] \u4e66\u7b7e\u6dfb\u52a0\u5931\u8d25\uff08\u53ef\u80fd\u4e0d\u652f\u6301\uff09:",t)}}addFooters(){const t=this.pdf.internal.getNumberOfPages();for(let e=1;e<=t;e++)this.pdf.setPage(e),this.renderFooter(e,t)}checkPageBreak(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:20;const e=u.PAGE_HEIGHT-u.MARGIN_BOTTOM;this.currentY+t>e&&(this.pdf.addPage(),this.currentY=u.MARGIN_TOP)}parseTextWithCodeBlocksAndLatex(t){const e=[],n=[],s=/```(\w*)\n([\s\S]*?)```/g;let i,o=0;for(;null!==(i=s.exec(t));)n.push({start:i.index,end:i.index+i[0].length,type:"code",language:i[1]||"",content:i[2]});const r=/\$\$([\s\S]*?)\$\$/g;for(;null!==(i=r.exec(t));){n.some(t=>i.index>=t.start&&i.index<t.end||i.index+i[0].length>t.start&&i.index+i[0].length<=t.end)||n.push({start:i.index,end:i.index+i[0].length,type:"latex-block",content:i[1].trim()})}const a=/(?<!\$)\$(?!\$)((?:\\.|[^$\\])+?)\$(?!\$)/g;for(;null!==(i=a.exec(t));){n.some(t=>i.index>=t.start&&i.index<t.end||i.index+i[0].length>t.start&&i.index+i[0].length<=t.end)||n.push({start:i.index,end:i.index+i[0].length,type:"latex-inline",content:i[1].trim()})}if(n.sort((t,e)=>t.start-e.start),o=0,n.forEach(n=>{if(n.start>o){const s=t.substring(o,n.start);s.trim()&&e.push({type:"text",content:s})}e.push(n),o=n.end}),o<t.length){const n=t.substring(o);n.trim()&&e.push({type:"text",content:n})}return 0===e.length&&e.push({type:"text",content:t}),e}parseTextWithCodeBlocks(t){return this.parseTextWithCodeBlocksAndLatex(t)}renderMarkdownText(t,e){if(!t||0===t.trim().length)return void(this.currentY+=u.LINE_HEIGHT);const n=this.cleanText(t);if(!n||0===n.trim().length)return void(this.currentY+=u.LINE_HEIGHT);n.split("\n").forEach(t=>{this.checkPageBreak(u.FONT_SIZE_BODY),""===t.trim()?this.currentY+=u.LINE_HEIGHT:t.match(/^#{1,6}\s/)?this.renderMarkdownHeading(t,e):t.match(/^>\s/)?this.renderMarkdownQuote(t,e):t.match(/^[-*+]\s/)||t.match(/^\d+\.\s/)?this.renderMarkdownList(t,e):this.renderMarkdownInlineFormats(t,e)})}renderMarkdownHeading(t,e){const n=t.match(/^(#{1,6})\s+(.+)$/);if(!n)return void this.renderPlainText(t,e);const s=n[1].length,i=n[2],o=u.FONT_SIZE_BODY+2*(7-s),r=this.pdf.internal.getFontSize();this.pdf.setFontSize(o),this.safeSetFont(this.chineseFontName,"bold");try{this.pdf.splitTextToSize(i,e).forEach(t=>{this.checkPageBreak(o);const e=this.cleanText(t);e&&e.trim().length>0&&this.pdf.text(e,u.MARGIN_LEFT,this.currentY),this.currentY+=1.2*u.LINE_HEIGHT})}catch(a){console.error("[PDF\u5bfc\u51fa] \u6807\u9898\u6e32\u67d3\u5931\u8d25:",a),this.pdf.text(i,u.MARGIN_LEFT,this.currentY),this.currentY+=1.2*u.LINE_HEIGHT}this.pdf.setFontSize(r),this.safeSetFont(this.chineseFontName,"normal"),this.currentY+=.5*u.LINE_HEIGHT}renderMarkdownQuote(t,e){const n=t.replace(/^>\s*/,""),s=e-8,i=u.MARGIN_LEFT+6;this.pdf.setDrawColor(150,150,150),this.pdf.setLineWidth(.5);const o=this.currentY-2;this.pdf.setFontSize(u.FONT_SIZE_BODY),this.pdf.setTextColor(100,100,100);try{this.pdf.splitTextToSize(n,s).forEach(t=>{this.checkPageBreak(u.FONT_SIZE_BODY);const e=this.cleanText(t);e&&e.trim().length>0&&this.pdf.text(e,i,this.currentY),this.currentY+=u.LINE_HEIGHT}),this.pdf.line(u.MARGIN_LEFT+2,o,u.MARGIN_LEFT+2,this.currentY-2)}catch(r){console.error("[PDF\u5bfc\u51fa] \u5f15\u7528\u6e32\u67d3\u5931\u8d25:",r),this.pdf.text(n,i,this.currentY),this.currentY+=u.LINE_HEIGHT}this.pdf.setTextColor(...u.COLOR_TEXT)}renderMarkdownList(t,e){let n="",s="";const i=t.match(/^([-*+])\s+(.+)$/),o=t.match(/^(\d+)\.\s+(.+)$/);if(i)n="\u2022",s=i[2];else{if(!o)return void this.renderPlainText(t,e);n=o[1]+".",s=o[2]}const r=this.pdf.getTextWidth(n+"  "),a=e-r,c=u.MARGIN_LEFT+r;this.pdf.setFontSize(u.FONT_SIZE_BODY),this.pdf.text(n,u.MARGIN_LEFT+2,this.currentY);try{this.pdf.splitTextToSize(s,a).forEach((t,e)=>{e>0&&this.checkPageBreak(u.FONT_SIZE_BODY);const n=this.cleanText(t);n&&n.trim().length>0&&this.pdf.text(n,c,this.currentY),this.currentY+=u.LINE_HEIGHT})}catch(h){console.error("[PDF\u5bfc\u51fa] \u5217\u8868\u6e32\u67d3\u5931\u8d25:",h),this.pdf.text(s,c,this.currentY),this.currentY+=u.LINE_HEIGHT}}renderMarkdownInlineFormats(t,e){if(!t||0===t.trim().length)return void(this.currentY+=u.LINE_HEIGHT);const n=this.parseInlineMarkdown(t);this.renderInlineSegments(n,e)}parseInlineMarkdown(t){const e=[];const n=[];[{type:"code",regex:/`([^`]+)`/g},{type:"bold-italic",regex:/\*\*\*(.+?)\*\*\*/g},{type:"bold-italic",regex:/___(.+?)___/g},{type:"bold",regex:/\*\*(.+?)\*\*/g},{type:"bold",regex:/__(.+?)__/g},{type:"italic",regex:/\*(.+?)\*/g},{type:"italic",regex:/_(.+?)_/g},{type:"link",regex:/\[([^\]]+)\]\(([^)]+)\)/g}].forEach(e=>{let s;const i=new RegExp(e.regex.source,"g");for(;null!==(s=i.exec(t));)n.push({type:e.type,start:s.index,end:i.lastIndex,text:s[1],url:s[2]})}),n.sort((t,e)=>t.start-e.start);const s=[];n.forEach(t=>{s.some(e=>t.start>=e.start&&t.start<e.end||t.end>e.start&&t.end<=e.end)||s.push(t)});let i=0;return s.forEach(n=>{n.start>i&&e.push({type:"normal",text:t.substring(i,n.start)}),e.push({type:n.type,text:n.text,url:n.url}),i=n.end}),i<t.length&&e.push({type:"normal",text:t.substring(i)}),0===e.length&&e.push({type:"normal",text:t}),e}renderInlineSegments(t,e){let n=u.MARGIN_LEFT,i=[];t.forEach((t,e)=>{const o=this.cleanText(t.text||"");if(!o)return;this.applySegmentStyle(t.type);const r=this.pdf.getTextWidth(o);n+r>u.PAGE_WIDTH-u.MARGIN_RIGHT&&i.length>0&&(this.renderSegmentLine(i),this.currentY+=u.LINE_HEIGHT,this.checkPageBreak(u.FONT_SIZE_BODY),n=u.MARGIN_LEFT,i=[]),i.push((0,s.A)((0,s.A)({},t),{},{x:n,text:o})),n+=r}),i.length>0&&(this.renderSegmentLine(i),this.currentY+=u.LINE_HEIGHT),this.pdf.setFont(this.chineseFontName,"normal"),this.pdf.setTextColor(...u.COLOR_TEXT)}renderSegmentLine(t){t.forEach(t=>{if(this.applySegmentStyle(t.type),"link"===t.type){this.pdf.textWithLink(t.text,t.x,this.currentY,{url:t.url||"#"});const e=this.pdf.getTextWidth(t.text);this.pdf.line(t.x,this.currentY+.5,t.x+e,this.currentY+.5)}else if("code"===t.type){const e=this.pdf.getTextWidth(t.text),n=1;this.pdf.setFillColor(245,245,245),this.pdf.rect(t.x-n,this.currentY-3,e+2*n,4,"F"),this.pdf.setTextColor(220,50,50),this.pdf.text(t.text,t.x,this.currentY)}else this.pdf.text(t.text,t.x,this.currentY)})}applySegmentStyle(t){switch(this.pdf.setFontSize(u.FONT_SIZE_BODY),this.pdf.setTextColor(...u.COLOR_TEXT),t){case"bold":this.safeSetFont(this.chineseFontName,"bold");break;case"italic":this.safeSetFont(this.chineseFontName,"italic")||this.pdf.setTextColor(70,130,180);break;case"bold-italic":this.safeSetFont(this.chineseFontName,"bolditalic")||(this.safeSetFont(this.chineseFontName,"bold"),this.pdf.setTextColor(70,130,180));break;case"code":this.pdf.setFont("courier","normal"),this.pdf.setFontSize(u.FONT_SIZE_CODE),this.pdf.setTextColor(220,50,50);break;case"link":this.safeSetFont(this.chineseFontName,"normal"),this.pdf.setTextColor(0,102,204);break;default:this.safeSetFont(this.chineseFontName,"normal")}}convertLatexToUnicode(t){if(!t)return"";let e=t;const n={"\\alpha":"\u03b1","\\Alpha":"\u0391","\\beta":"\u03b2","\\Beta":"\u0392","\\gamma":"\u03b3","\\Gamma":"\u0393","\\delta":"\u03b4","\\Delta":"\u0394","\\epsilon":"\u03b5","\\Epsilon":"\u0395","\\varepsilon":"\u03b5","\\zeta":"\u03b6","\\Zeta":"\u0396","\\eta":"\u03b7","\\Eta":"\u0397","\\theta":"\u03b8","\\Theta":"\u0398","\\vartheta":"\u03d1","\\iota":"\u03b9","\\Iota":"\u0399","\\kappa":"\u03ba","\\Kappa":"\u039a","\\lambda":"\u03bb","\\Lambda":"\u039b","\\mu":"\u03bc","\\Mu":"\u039c","\\nu":"\u03bd","\\Nu":"\u039d","\\xi":"\u03be","\\Xi":"\u039e","\\omicron":"\u03bf","\\Omicron":"\u039f","\\pi":"\u03c0","\\Pi":"\u03a0","\\rho":"\u03c1","\\Rho":"\u03a1","\\sigma":"\u03c3","\\Sigma":"\u03a3","\\tau":"\u03c4","\\Tau":"\u03a4","\\upsilon":"\u03c5","\\Upsilon":"\u03a5","\\phi":"\u03c6","\\Phi":"\u03a6","\\varphi":"\u03d5","\\chi":"\u03c7","\\Chi":"\u03a7","\\psi":"\u03c8","\\Psi":"\u03a8","\\omega":"\u03c9","\\Omega":"\u03a9"},s={"\\leq":"\u2264","\\le":"\u2264","\\geq":"\u2265","\\ge":"\u2265","\\neq":"\u2260","\\ne":"\u2260","\\approx":"\u2248","\\equiv":"\u2261","\\sim":"\u223c","\\simeq":"\u2243","\\cong":"\u2245","\\propto":"\u221d","\\ll":"\u226a","\\gg":"\u226b","\\subset":"\u2282","\\supset":"\u2283","\\subseteq":"\u2286","\\supseteq":"\u2287","\\in":"\u2208","\\notin":"\u2209","\\ni":"\u220b","\\emptyset":"\u2205","\\rightarrow":"\u2192","\\to":"\u2192","\\leftarrow":"\u2190","\\leftrightarrow":"\u2194","\\Rightarrow":"\u21d2","\\Leftarrow":"\u21d0","\\Leftrightarrow":"\u21d4","\\uparrow":"\u2191","\\downarrow":"\u2193","\\mapsto":"\u21a6","\\times":"\xd7","\\div":"\xf7","\\pm":"\xb1","\\mp":"\u2213","\\cdot":"\xb7","\\ast":"\u2217","\\star":"\u22c6","\\circ":"\u2218","\\bullet":"\u2022","\\oplus":"\u2295","\\ominus":"\u2296","\\otimes":"\u2297","\\odot":"\u2299","\\oslash":"\u2298","\\cup":"\u222a","\\cap":"\u2229","\\vee":"\u2228","\\wedge":"\u2227","\\partial":"\u2202","\\nabla":"\u2207","\\infty":"\u221e","\\int":"\u222b","\\iint":"\u222c","\\iiint":"\u222d","\\oint":"\u222e","\\sum":"\u2211","\\prod":"\u220f","\\coprod":"\u2210","\\forall":"\u2200","\\exists":"\u2203","\\nexists":"\u2204","\\neg":"\xac","\\lnot":"\xac","\\land":"\u2227","\\lor":"\u2228","\\implies":"\u21d2","\\iff":"\u21d4","\\angle":"\u2220","\\degree":"\xb0","\\prime":"\u2032","\\dprime":"\u2033","\\infty":"\u221e","\\aleph":"\u2135","\\hbar":"\u210f","\\ell":"\u2113","\\wp":"\u2118","\\Re":"\u211c","\\Im":"\u2111","\\bot":"\u22a5","\\top":"\u22a4","\\perp":"\u22a5","\\parallel":"\u2225","\\triangle":"\u25b3","\\square":"\u25a1","\\checkmark":"\u2713","\\dots":"\u2026","\\ldots":"\u2026","\\cdots":"\u22ef","\\vdots":"\u22ee","\\ddots":"\u22f1","\\langle":"\u27e8","\\rangle":"\u27e9","\\lfloor":"\u230a","\\rfloor":"\u230b","\\lceil":"\u2308","\\rceil":"\u2309"};return e=e.replace(/\^{([^}]+)}/g,"^($1)"),e=e.replace(/_{([^}]+)}/g,"_($1)"),e=e.replace(/\\frac{([^}]+)}{([^}]+)}/g,"($1)/($2)"),e=e.replace(/\\sqrt{([^}]+)}/g,"\u221a($1)"),e=e.replace(/\\sqrt\[(\d+)\]{([^}]+)}/g,"[$1]\u221a($2)"),Object.keys(n).forEach(t=>{const s=new RegExp(t.replace(/\\/g,"\\\\"),"g");e=e.replace(s,n[t])}),Object.keys(s).forEach(t=>{const n=new RegExp(t.replace(/\\/g,"\\\\"),"g");e=e.replace(n,s[t])}),e=e.replace(/\\text{([^}]+)}/g,"$1"),e=e.replace(/\\mathrm{([^}]+)}/g,"$1"),e=e.replace(/\\mathbf{([^}]+)}/g,"$1"),e=e.replace(/\\mathit{([^}]+)}/g,"$1"),e=e.replace(/\\mathcal{([^}]+)}/g,"$1"),e=e.replace(/\\mathbb{([^}]+)}/g,"$1"),e=e.replace(/\\\\(?:\[[^\]]*\])?/g,"\n"),e=e.replace(/&/g," "),e=e.replace(/\\,/g," "),e=e.replace(/\\;/g," "),e=e.replace(/\\quad/g,"  "),e=e.replace(/\\qquad/g,"    "),e=e.replace(/\\ /g," "),e=e.replace(/{([^{}]+)}/g,"$1"),e=e.replace(/\s+/g," ").trim(),e}generateFileName(t){const e=o.Nq.getCurrentDate(),n=(t.name||"conversation").replace(/[^a-zA-Z0-9\u4e00-\u9fa5]/g,"_");return"".concat(n,"_").concat(e,".pdf")}getPlatformPrefix(t){const e=(t||"").toLowerCase();return e.includes("chatgpt")?"chatgpt":e.includes("gemini")?"gemini":e.includes("notebooklm")?"notebooklm":e.includes("aistudio")?"aistudio":e.includes("sillytavern")?"sillytavern":"claude"}}new f}}]);
//# sourceMappingURL=991.5654018c.chunk.js.map