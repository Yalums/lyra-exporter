"use strict";(self.webpackChunklyra_exporter=self.webpackChunklyra_exporter||[]).push([[843],{843:(e,t,n)=>{n.d(t,{handleExport:()=>h});var a=n(555),i=n(224),o=n(144),r=n(529),s=(n(362),n(185));const c={includeThinking:!0,includeTools:!0,includeArtifacts:!0,includeCitations:!0,includeAttachments:!0,includeTimestamps:!1,exportObsidianMetadata:!1,exportMarkedOnly:!1,excludeDeleted:!0,includeCompleted:!1,includeImportant:!1,obsidianProperties:[],obsidianTags:[]};class l{constructor(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};this.config=(0,a.A)((0,a.A)({},c),e)}generate(e){return[this.generateMetadata(e),this.generateHeader(e),this.generateMessages(e),this.generateFooter(e)].filter(Boolean).join("\n")}generateMetadata(e){var t,n,a;if(!this.config.exportObsidianMetadata)return"";const o=["---","title: ".concat((null===(t=e.meta_info)||void 0===t?void 0:t.title)||"\u5bf9\u8bdd\u8bb0\u5f55"),"date: ".concat(i.Nq.getCurrentDate()),"export_time: ".concat(i.Nq.formatDateTime(new Date))];return(null===(n=this.config.obsidianProperties)||void 0===n?void 0:n.length)>0&&this.config.obsidianProperties.forEach(e=>{if(e.value.includes(",")){const t=e.value.split(",").map(e=>e.trim());o.push("".concat(e.name,":")),t.forEach(e=>o.push("  - ".concat(e)))}else o.push("".concat(e.name,": ").concat(e.value))}),(null===(a=this.config.obsidianTags)||void 0===a?void 0:a.length)>0&&(o.push("tags:"),this.config.obsidianTags.forEach(e=>o.push("  - ".concat(e)))),o.push("---",""),o.join("\n")}generateHeader(e){const{meta_info:t={}}=e,n=["# ".concat(t.title||"\u5bf9\u8bdd\u8bb0\u5f55"),"*\u521b\u5efa\u65f6\u95f4: ".concat(t.created_at||"\u672a\u77e5","*"),"*\u5bfc\u51fa\u65f6\u95f4: ".concat(i.Nq.formatDateTime(new Date),"*")];if(this.config.excludeDeleted||this.config.includeCompleted||this.config.includeImportant){const e=this.getFilterDescription();e&&n.push("*\u7b5b\u9009\u6761\u4ef6: ".concat(e,"*"))}return n.push("","---",""),n.join("\n")}generateMessages(e){const{chat_history:t=[]}=e,n=this.filterMessages(t);return 0===n.length?"*\u6ca1\u6709\u7b26\u5408\u6761\u4ef6\u7684\u6d88\u606f*\n":n.map((e,t)=>this.formatMessage(e,t+1)).join("\n---\n\n")}generateFooter(e){const{chat_history:t=[]}=e,n=this.filterMessages(t),a=t.length;return n.length<a?"\n*\u6839\u636e\u7b5b\u9009\u6761\u4ef6\uff0c\u4ece ".concat(a," \u6761\u6d88\u606f\u4e2d\u5bfc\u51fa\u4e86 ").concat(n.length," \u6761\u6d88\u606f*"):""}filterMessages(e){let t=[...e];const n=this.config.marks||{completed:new Set,important:new Set,deleted:new Set};return this.config.excludeDeleted&&(t=t.filter(e=>!n.deleted.has(e.index))),this.config.includeCompleted&&!this.config.includeImportant&&(t=t.filter(e=>n.completed.has(e.index))),this.config.includeImportant&&!this.config.includeCompleted&&(t=t.filter(e=>n.important.has(e.index))),this.config.includeCompleted&&this.config.includeImportant&&(t=t.filter(e=>n.completed.has(e.index)&&n.important.has(e.index))),t}formatMessage(e,t){var n,a,i,o;const r=[],s=this.getBranchMarker(e),c=this.formatMessageTitle(e,t,s);return r.push(c),this.config.includeTimestamps&&e.timestamp&&r.push("*".concat(e.timestamp,"*")),r.push(""),e.display_text&&r.push(e.display_text,""),(null===(n=e.attachments)||void 0===n?void 0:n.length)>0&&this.config.includeAttachments&&"human"===e.sender&&r.push(this.formatAttachments(e.attachments)),e.thinking&&this.config.includeThinking&&"human"!==e.sender&&r.push(this.formatThinking(e.thinking)),(null===(a=e.artifacts)||void 0===a?void 0:a.length)>0&&this.config.includeArtifacts&&"human"!==e.sender&&e.artifacts.forEach(e=>{r.push(this.formatArtifact(e))}),(null===(i=e.tools)||void 0===i?void 0:i.length)>0&&this.config.includeTools&&e.tools.forEach(e=>{r.push(this.formatTool(e))}),(null===(o=e.citations)||void 0===o?void 0:o.length)>0&&this.config.includeCitations&&r.push(this.formatCitations(e.citations)),r.join("\n")}formatThinking(e){return["<details>","<summary>\ud83d\udcad \u601d\u8003\u8fc7\u7a0b</summary>","","```",e,"```","</details>",""].join("\n")}formatAttachments(e){const t=["<details>","<summary>\ud83d\udcce \u9644\u52a0\u6587\u4ef6</summary>",""];return e.forEach(e=>{const n=this.formatFileSize(e.file_size);if(t.push("- **".concat(e.file_name,"** (").concat(n,")")),e.file_type&&t.push("  - \u7c7b\u578b: ".concat(e.file_type)),e.extracted_content){const n=e.extracted_content.substring(0,200),a=n.length<e.extracted_content.length?"".concat(n,"..."):n;t.push("  - \u5185\u5bb9\u9884\u89c8: ".concat(a))}}),t.push("","</details>",""),t.join("\n")}formatFileSize(e){if(0===e)return"0 Bytes";const t=Math.floor(Math.log(e)/Math.log(1024));return parseFloat((e/Math.pow(1024,t)).toFixed(2))+" "+["Bytes","KB","MB","GB"][t]}formatArtifact(e){const t=["<details>","<summary>\ud83d\udd27 Artifact: ".concat(e.title||"\u65e0\u6807\u9898","</summary>"),"","**\u7c7b\u578b**: `".concat(e.type||"\u672a\u77e5","`"),""];return"create"===e.command&&e.content&&(e.language&&t.push("**\u8bed\u8a00**: `".concat(e.language,"`")),t.push("","**\u5185\u5bb9**:"),t.push("```".concat(e.language||"")),t.push(e.content),t.push("```")),t.push("</details>",""),t.join("\n")}formatTool(e){var t;const n=["<details>","<summary>\ud83d\udd0d \u5de5\u5177: ".concat(e.name,"</summary>"),""];return e.query&&n.push("**\u641c\u7d22\u67e5\u8be2**: `".concat(e.query,"`"),""),null!==(t=e.result)&&void 0!==t&&t.content&&"web_search"===e.name&&(n.push("**\u641c\u7d22\u7ed3\u679c**:",""),e.result.content.slice(0,5).forEach((e,t)=>{n.push("".concat(t+1,". [").concat(e.title||"\u65e0\u6807\u9898","](").concat(e.url||"#",")"))})),n.push("</details>",""),n.join("\n")}formatCitations(e){const t=["<details>","<summary>\ud83d\udcce \u5f15\u7528\u6765\u6e90</summary>","","| \u6807\u9898 | \u6765\u6e90 |","| --- | --- |"];return e.forEach(e=>{const n=e.title||"\u672a\u77e5\u6765\u6e90",a=e.url||"#",i=a.includes("/")?a.split("/")[2]:"\u672a\u77e5\u7f51\u7ad9";t.push("| [".concat(n,"](").concat(a,") | ").concat(i," |"))}),t.push("</details>",""),t.join("\n")}getBranchMarker(e){return e.is_branch_point?" \ud83d\udd00":e.branch_level>0?" \u21b3".concat(e.branch_level):""}formatMessageTitle(e,t,n){let a="";if(this.config.includeHeaderPrefix&&(a+="#".repeat(this.config.headerLevel||2)+" "),this.config.includeNumbering){const e=this.config.numberingFormat||"numeric";"numeric"===e?a+="".concat(t,". "):"letter"===e?a+="".concat(this.toExcelColumn(t),". "):"roman"===e&&(a+="".concat(this.toRoman(t),". "))}return a+=this.getSenderLabel(e)+n,a}getSenderLabel(e){const t="human"===e.sender||"\u4eba\u7c7b"===e.sender_label||"Human"===e.sender_label;return this.config.humanLabel&&this.config.assistantLabel?t?this.config.humanLabel:this.config.assistantLabel:e.sender_label||(t?"\u4eba\u7c7b":"Claude")}toExcelColumn(e){let t="";for(;e>0;)e--,t=String.fromCharCode(65+e%26)+t,e=Math.floor(e/26);return t}toRoman(e){if(e<=0||e>=4e3)return e.toString();const t=[1e3,900,500,400,100,90,50,40,10,9,5,4,1],n=["M","CM","D","CD","C","XC","L","XL","X","IX","V","IV","I"];let a="";for(let i=0;i<t.length;i++)for(;e>=t[i];)a+=n[i],e-=t[i];return a}getFilterDescription(){const e=[];return this.config.excludeDeleted&&e.push("\u6392\u9664\u5df2\u5220\u9664"),this.config.includeCompleted&&this.config.includeImportant?e.push("\u4ec5\u5df2\u5b8c\u6210\u4e14\u91cd\u8981\u7684\u6d88\u606f"):this.config.includeCompleted?e.push("\u4ec5\u5df2\u5b8c\u6210\u7684\u6d88\u606f"):this.config.includeImportant&&e.push("\u4ec5\u91cd\u8981\u7684\u6d88\u606f"),e.join("\uff0c")}}class u{static saveTextFile(e,t){try{const n=new Blob([e],{type:"text/markdown;charset=utf-8"}),a=URL.createObjectURL(n),i=document.createElement("a");return i.href=a,i.download=t,document.body.appendChild(i),i.click(),document.body.removeChild(i),URL.revokeObjectURL(a),!0}catch(n){return console.error("\u4fdd\u5b58\u6587\u4ef6\u5931\u8d25:",n),alert("\u4fdd\u5b58\u6587\u4ef6\u5931\u8d25\uff0c\u8bf7\u91cd\u8bd5"),!1}}static async exportSingleFile(e){const t=new l(arguments.length>1&&void 0!==arguments[1]?arguments[1]:{}).generate(e),n=this.generateFileName(e,"single");return this.saveTextFile(t,n)}static async exportMultipleFiles(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};const n=e.map((e,n)=>{const i=(0,a.A)((0,a.A)({},t),{},{marks:{completed:new Set,important:new Set,deleted:new Set}});return new l(i).generate(e)}).join("\n\n---\n---\n\n"),i=this.generateFileName(null,"multiple");return this.saveTextFile(n,i)}static generateFileName(e){var t;let n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"single";const a=i.Nq.getCurrentDate();if("single"===n&&null!==e&&void 0!==e&&null!==(t=e.meta_info)&&void 0!==t&&t.title){const t=e.meta_info.title.replace(/[^a-zA-Z0-9\u4e00-\u9fa5]/g,"_");return"".concat(t,"_").concat(a,".md")}return"export_".concat(a,".md")}}async function h(e){let{exportOptions:t,processedData:n,sortManagerRef:c,sortedMessages:l,markManagerRef:h,currentBranchState:d,operatedFiles:m,files:g,currentFileIndex:f}=e;try{const e=i.bu.getLocalStorage("export-config",{includeNumbering:!0,numberingFormat:"numeric",senderFormat:"default",humanLabel:"\u4eba\u7c7b",assistantLabel:"Claude",includeHeaderPrefix:!0,headerLevel:2});let f=[];switch(t.scope){case"current":if(n){var p;const e=null!==c&&void 0!==c&&null!==(p=c.current)&&void 0!==p&&p.hasCustomSort()?l:n.chat_history||[];f=[(0,a.A)((0,a.A)({},n),{},{chat_history:e})]}break;case"currentBranch":if(n&&d&&!d.showAllBranches){var v;let e=n.chat_history||[];d.currentBranchIndexes&&d.currentBranchIndexes.size>0&&(e=e.filter(e=>{if(!e.is_branch_point)return!0;const t=d.currentBranchIndexes.get(e.uuid);return void 0===t||(e.branch_id===t||null===e.branch_id)}));const t=null!==c&&void 0!==c&&null!==(v=c.current)&&void 0!==v&&v.hasCustomSort()?c.current.getSortedMessages().filter(t=>e.some(e=>e.uuid===t.uuid)):e;f=[(0,a.A)((0,a.A)({},n),{},{chat_history:t})]}break;case"operated":const e=new Set;for(const t of m){const n=(0,o.Xw)(t);let i=-1,c=!1,l=null;if(n.conversationUuid?(c=!0,l=n.conversationUuid,i=n.fileIndex):i=g.findIndex((e,n)=>(0,o.zj)(n,e)===t||t.includes((0,o.wr)(e))),-1!==i&&!e.has(i)){const n=g[i];try{const u=await n.text(),h=JSON.parse(u);let d=(0,r.uE)(h,n.name);if(d=(0,r.IQ)(d),"claude_full_export"===d.format&&c&&l){var _,x;const e=null===(_=d.views)||void 0===_||null===(x=_.conversationList)||void 0===x?void 0:x.find(e=>e.uuid===l);if(e){var y;const t=(null===(y=d.chat_history)||void 0===y?void 0:y.filter(e=>e.conversation_uuid===l&&!e.is_conversation_header))||[],r=(0,o.mE)(i,l,n),c=new s.k(t,r).getSortedMessages();f.push((0,a.A)((0,a.A)({},d),{},{meta_info:(0,a.A)((0,a.A)({},d.meta_info),{},{title:e.name||"\u672a\u547d\u540d\u5bf9\u8bdd"}),chat_history:c,views:{conversationList:[e]}}))}}else{const n=new s.k(d.chat_history||[],t).getSortedMessages();f.push((0,a.A)((0,a.A)({},d),{},{chat_history:n})),e.add(i)}}catch(b){console.error("\u65e0\u6cd5\u5904\u7406\u6587\u4ef6 ".concat(n.name,":"),b)}}}break;case"all":for(let t=0;t<g.length;t++){const e=g[t];try{const n=await e.text(),i=JSON.parse(n);let c=(0,r.uE)(i,e.name);c=(0,r.IQ)(c);const l=(0,o.zj)(t,e),u=new s.k(c.chat_history||[],l).getSortedMessages();f.push((0,a.A)((0,a.A)({},c),{},{chat_history:u}))}catch(b){console.error("\u65e0\u6cd5\u5904\u7406\u6587\u4ef6 ".concat(e.name,":"),b)}}}if(0===f.length)return alert("\u6ca1\u6709\u53ef\u5bfc\u51fa\u7684\u6570\u636e"),!1;return await async function(e){const{scope:t="current",data:n=null,dataList:a=[],config:i={}}=e;try{switch(t){case"current":if(!n)throw new Error("\u6ca1\u6709\u53ef\u5bfc\u51fa\u7684\u6570\u636e");return u.exportSingleFile(n,i);case"multiple":if(0===a.length)throw new Error("\u6ca1\u6709\u53ef\u5bfc\u51fa\u7684\u6570\u636e");return u.exportMultipleFiles(a,i);default:throw new Error("\u672a\u77e5\u7684\u5bfc\u51fa\u8303\u56f4: ".concat(t))}}catch(o){return console.error("\u5bfc\u51fa\u5931\u8d25:",o),alert("\u5bfc\u51fa\u5931\u8d25: ".concat(o.message)),!1}}({scope:1===f.length?"current":"multiple",data:1===f.length?f[0]:null,dataList:f,config:(0,a.A)((0,a.A)((0,a.A)({},t),e),{},{marks:null!==h&&void 0!==h&&h.current?h.current.getMarks():{completed:new Set,important:new Set,deleted:new Set}})})}catch(w){return console.error("\u5bfc\u51fa\u5931\u8d25:",w),alert("\u5bfc\u51fa\u5931\u8d25\uff1a"+w.message),!1}}}}]);
//# sourceMappingURL=843.57d009a5.chunk.js.map