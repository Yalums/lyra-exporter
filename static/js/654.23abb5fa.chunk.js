"use strict";(self.webpackChunklyra_exporter=self.webpackChunklyra_exporter||[]).push([[654],{4654:(t,e,n)=>{n.d(e,{PDFExportManager:()=>N});var s=n(9379),i=n(221),r=n(4239);async function o(t,e){let n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:"CustomFont",s=arguments.length>3&&void 0!==arguments[3]?arguments[3]:"normal";try{console.log("[PDF\u5b57\u4f53] \u6b63\u5728\u52a0\u8f7d\u5b57\u4f53: ".concat(e));const{arrayBuffer:r,base64:o}=await h(e);if(!a.has(e)){const t=function(t){try{const e=new DataView(t).getUint32(0,!1);65536!==e&&1953658213!==e&&console.warn("[PDF\u5b57\u4f53] \u53ef\u80fd\u4e0d\u662f\u6807\u51c6TTF\u683c\u5f0f");const n=new Uint8Array(t),s=[99,109,97,112];for(let t=0;t<Math.min(n.length-4,1e3);t++)if(n[t]===s[0]&&n[t+1]===s[1]&&n[t+2]===s[2]&&n[t+3]===s[3])return console.log("[PDF\u5b57\u4f53] \u627e\u5230 cmap \u8868"),!0;return console.warn("[PDF\u5b57\u4f53] \u672a\u627e\u5230 cmap \u8868\u7279\u5f81"),!1}catch(e){return console.error("[PDF\u5b57\u4f53] cmap \u68c0\u67e5\u5931\u8d25:",e),!1}}(r);t||console.warn("[PDF\u5b57\u4f53] \u8b66\u544a: \u5b57\u4f53\u53ef\u80fd\u7f3a\u5c11 Unicode cmap \u8868")}const c=e.split("/").pop();try{return t.addFileToVFS(c,o),t.addFont(c,n,s),console.log("[PDF\u5b57\u4f53] \u2713 \u5b57\u4f53\u6ce8\u518c\u6210\u529f: ".concat(n,"-").concat(s)),!0}catch(i){return console.error("[PDF\u5b57\u4f53] addFont \u5931\u8d25:",i.message),console.error("[PDF\u5b57\u4f53] \u8fd9\u901a\u5e38\u610f\u5473\u7740\u5b57\u4f53\u4e0d\u517c\u5bb9 jsPDF"),!1}}catch(r){return console.error("[PDF\u5b57\u4f53] \u5b57\u4f53\u52a0\u8f7d\u5931\u8d25:",r),!1}}const a=new Map;async function h(t){if(a.has(t)){const e=a.get(t);return console.log("[PDF\u5b57\u4f53] \u2713 \u4f7f\u7528\u5185\u5b58\u7f13\u5b58: ".concat(t)),{arrayBuffer:e.arrayBuffer,base64:e.base64}}try{const e=await c(t);if(e)return console.log("[PDF\u5b57\u4f53] \u2713 \u4f7f\u7528 IndexedDB \u7f13\u5b58: ".concat(t)),a.set(t,{arrayBuffer:e.arrayBuffer,base64:e.base64,timestamp:Date.now()}),e}catch(s){console.warn("[PDF\u5b57\u4f53] IndexedDB \u8bfb\u53d6\u5931\u8d25: ".concat(s.message))}console.log("[PDF\u5b57\u4f53] \u4ece\u7f51\u7edc\u4e0b\u8f7d: ".concat(t));const e=new AbortController,n=setTimeout(()=>e.abort(),1e4);try{const i=await fetch(t,{signal:e.signal,cache:"force-cache"});if(clearTimeout(n),!i.ok)throw new Error("HTTP ".concat(i.status));const r=i.headers.get("content-type");if(r&&r.includes("text/html"))throw new Error("\u8fd4\u56de\u4e86HTML\u800c\u4e0d\u662f\u5b57\u4f53\u6587\u4ef6");const o=await i.arrayBuffer(),h=(o.byteLength/1024/1024).toFixed(2);console.log("[PDF\u5b57\u4f53] \u4e0b\u8f7d\u5b8c\u6210: ".concat(h," MB"));const c=new DataView(o).getUint32(0,!1);if(65536!==c&&1953658213!==c)throw new Error("\u65e0\u6548\u7684TTF\u6587\u4ef6\uff0c\u9b54\u6570: 0x".concat(c.toString(16)));if(o.byteLength<512e3)throw new Error("\u5b57\u4f53\u6587\u4ef6\u5f02\u5e38\u5c0f (".concat(h," MB)"));const l=new Uint8Array(o);let d="";const p=8192;for(let t=0;t<l.length;t+=p){const e=l.subarray(t,Math.min(t+p,l.length));d+=String.fromCharCode.apply(null,e)}const f=btoa(d),u={arrayBuffer:o,base64:f};return a.set(t,{arrayBuffer:o,base64:f,timestamp:Date.now()}),async function(t,e){return new Promise((n,i)=>{const r=indexedDB.open("LyraFontCache",1);r.onerror=()=>i(r.error),r.onupgradeneeded=t=>{const e=t.target.result;e.objectStoreNames.contains("fonts")||e.createObjectStore("fonts",{keyPath:"path"})},r.onsuccess=()=>{const o=r.result;try{const s=o.transaction(["fonts"],"readwrite");s.objectStore("fonts").put({path:t,arrayBuffer:e.arrayBuffer,base64:e.base64,timestamp:Date.now()}),s.oncomplete=()=>{console.log("[PDF\u5b57\u4f53] \u2713 \u5df2\u7f13\u5b58\u5230 IndexedDB: ".concat(t)),n()},s.onerror=()=>i(s.error)}catch(s){i(s)}finally{o.close()}}})}(t,u).catch(t=>{console.warn("[PDF\u5b57\u4f53] IndexedDB \u4fdd\u5b58\u5931\u8d25: ".concat(t.message))}),u}catch(i){if(clearTimeout(n),"AbortError"===i.name)throw new Error("\u4e0b\u8f7d\u8d85\u65f6");throw i}}async function c(t){return new Promise((e,n)=>{const s=indexedDB.open("LyraFontCache",1);s.onerror=()=>n(s.error),s.onupgradeneeded=t=>{const e=t.target.result;e.objectStoreNames.contains("fonts")||e.createObjectStore("fonts",{keyPath:"path"})},s.onsuccess=()=>{const n=s.result;try{const s=n.transaction(["fonts"],"readonly"),i=s.objectStore("fonts").get(t);i.onsuccess=()=>{const t=i.result;t&&t.arrayBuffer&&t.base64?e({arrayBuffer:t.arrayBuffer,base64:t.base64}):e(null)},i.onerror=()=>e(null)}catch(i){e(null)}finally{n.close()}}})}function l(t){if(!t||"string"!==typeof t)return"";try{let e=t.normalize("NFC");e=e.replace(/[\x00-\x08\x0B\x0C\x0E-\x1F\x7F-\x9F]/g,"");const n={"\ufb00":"ff","\ufb01":"fi","\ufb02":"fl","\ufb03":"ffi","\ufb04":"ffl","\ufb05":"st","\ufb06":"st","\xc6":"AE","\xe6":"ae","\u0152":"OE","\u0153":"oe","\xdf":"ss","\u1e9e":"SS"};for(const[t,i]of Object.entries(n))e=e.replace(new RegExp(t,"g"),i);e=e.replace(/[\u200B-\u200F\u2060\uFEFF]/g,"");const s={"\u201c":'"',"\u201d":'"',"\u2018":"'","\u2019":"'","\u2033":'"',"\u2032":"'","\u2014":"--","\u2013":"-","\u2026":"...","\u2022":"\xb7","\xb7":"\xb7","\u2217":"*","\u2731":"*","\u2732":"*","\u2605":"*","\u2606":"*","\u2795":"+","\uff0b":"+"};for(const[t,i]of Object.entries(s))e=e.replace(new RegExp(t,"g"),i);return e=e.replace(/[\uFF10-\uFF19]/g,t=>String.fromCharCode(t.charCodeAt(0)-65248)),e=e.replace(/[\uFF21-\uFF3A]/g,t=>String.fromCharCode(t.charCodeAt(0)-65248)),e=e.replace(/[\uFF41-\uFF5A]/g,t=>String.fromCharCode(t.charCodeAt(0)-65248)),e=e.replace(/\u3000/g," "),e}catch(e){return console.error("[PDF\u5bfc\u51fa] \u6587\u672c\u6e05\u7406\u5931\u8d25:",e),t.replace(/[\x00-\x08\x0B\x0C\x0E-\x1F\x7F]/g,"")}}function d(t){const e=[],n=[],s=/```([^\n]*?)\s*\n([\s\S]*?)```/g;let i,r=0;for(;null!==(i=s.exec(t));){const t=(i[1]||"").trim().toLowerCase(),e=i[2];"latex"===t||"math"===t?(console.log("[\u89e3\u6790] \u68c0\u6d4b\u5230LaTeX\u4ee3\u7801\u5757:",t),n.push({start:i.index,end:i.index+i[0].length,type:"latex-display",content:e.trim()})):n.push({start:i.index,end:i.index+i[0].length,type:"code",language:t,content:e})}const o=/\$\$\n?([\s\S]*?)\n?\$\$/g;for(;null!==(i=o.exec(t));)n.push({start:i.index,end:i.index+i[0].length,type:"latex-display",content:i[1].trim()});const a=/\\\[([\s\S]*?)\\\]/g;for(;null!==(i=a.exec(t));)n.push({start:i.index,end:i.index+i[0].length,type:"latex-display",content:i[1].trim()});n.sort((t,e)=>t.start-e.start);const h=[];if(n.forEach(t=>{h.some(e=>t.start>=e.start&&t.start<e.end||t.end>e.start&&t.end<=e.end||t.start<=e.start&&t.end>=e.end)||h.push(t)}),r=0,h.forEach(n=>{if(n.start>r){const s=t.substring(r,n.start);s.trim()&&e.push({type:"text",content:s})}e.push(n),r=n.end}),r<t.length){const n=t.substring(r);n.trim()&&e.push({type:"text",content:n})}return 0===e.length&&e.push({type:"text",content:t}),e}function p(t){const e=[],n=[];[{type:"latex-inline",regex:/\$([^\$\n]+?)\$/g},{type:"latex-inline",regex:/\\\(([^)]*?)\\\)/g},{type:"code",regex:/`([^`]+)`/g},{type:"bold-italic",regex:/\*\*\*(.+?)\*\*\*/g},{type:"bold-italic",regex:/___(.+?)___/g},{type:"bold",regex:/\*\*([^*]+?)\*\*/g},{type:"bold",regex:/__([^_]+?)__/g},{type:"italic",regex:/\*([^*]+?)\*/g},{type:"italic",regex:/_([^_]+?)_/g},{type:"link",regex:/\[([^\]]+)\]\(([^)]+)\)/g}].forEach(e=>{let s;const i=new RegExp(e.regex.source,"g");for(;null!==(s=i.exec(t));){const t="latex-inline"===e.type;n.push({type:e.type,start:s.index,end:i.lastIndex,text:t?s[1]:l(s[1]),url:s[2],rawText:s[1]}),"bold"===e.type?console.log("[PDF\u5bfc\u51fa] \u53d1\u73b0\u7c97\u4f53\u6587\u672c [".concat(s.index,"-").concat(i.lastIndex,"]:"),s[1]):"latex-inline"===e.type&&console.log("[PDF\u5bfc\u51fa] \u53d1\u73b0LaTeX inline [".concat(s.index,"-").concat(i.lastIndex,"]:"),s[1])}}),n.sort((t,e)=>t.start-e.start);const s=[];n.forEach(t=>{s.some(e=>t.start>=e.start&&t.start<e.end||t.end>e.start&&t.end<=e.end)?"bold"===t.type&&console.warn("[PDF\u5bfc\u51fa] \u26a0 \u7c97\u4f53\u6587\u672c\u88ab\u8fc7\u6ee4\uff08\u91cd\u53e0\uff09[".concat(t.start,"-").concat(t.end,"]:"),t.rawText):s.push(t)});let i=0;return s.forEach(n=>{n.start>i&&e.push({type:"normal",text:l(t.substring(i,n.start))}),e.push({type:n.type,text:n.text,url:n.url}),i=n.end}),i<t.length&&e.push({type:"normal",text:l(t.substring(i))}),0===e.length&&e.push({type:"normal",text:l(t)}),e.forEach(t=>{"normal"===t.type&&t.text&&(t.text=t.text.replace(/\*\*(?!\*)/g,""),t.text=t.text.replace(/(?<!\*)\*\*/g,""),t.text=t.text.replace(/(?<!\*)\*(?!\*)/g,""),t.text=t.text.replace(/(?<!_)__(?!_)/g,""),t.text=t.text.replace(/(?<!_)_(?!_)/g,""))}),e}function f(t){if(!t||t.length<=1)return t;const e=/^[\u3002\uff0c\u3001\uff1b\uff1a\uff01\uff1f\uff09\u300b\u300d\u300f\u3011"',.;:!?)}\]]/,n=/[\uff08\u300a\u300c\u300e\u3010"'(\[{]$/,s=[];let i=t[0];for(let r=1;r<t.length;r++){const o=t[r];if(e.test(o)){i+=o[0],t[r]=o.substring(1);continue}if(n.test(i)){const e=i[i.length-1];i=i.substring(0,i.length-1),t[r]=e+o}s.push(i),i=t[r]}return s.push(i),s}function u(t){const e=[],n=t.match(/^(#{1,6})\s+(.+)$/);if(n){const t=n[1].length,s=n[2],i=/\*\*([^*]+?)\*\*/g;let r,o=0;for(;null!==(r=i.exec(s));)r.index>o&&e.push({text:s.substring(o,r.index),bold:!1,heading:t}),e.push({text:r[1],bold:!0,heading:t}),o=i.lastIndex;return o<s.length&&e.push({text:s.substring(o),bold:!1,heading:t}),0===e.length&&e.push({text:s,bold:!1,heading:t}),e}const s=/\*\*([^*]+?)\*\*/g;let i,r=0;for(;null!==(i=s.exec(t));)i.index>r&&e.push({text:t.substring(r,i.index),bold:!1}),e.push({text:i[1],bold:!0}),r=s.lastIndex;return r<t.length&&e.push({text:t.substring(r),bold:!1}),0===e.length&&e.push({text:t,bold:!1}),e}function T(t,e){let n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:"normal",s=arguments.length>3&&void 0!==arguments[3]?arguments[3]:[];try{if(s.includes(n))return t.setFont(e,n),!0;if(console.warn("[PDF\u5bfc\u51fa] \u5b57\u4f53\u53d8\u4f53 ".concat(n," \u4e0d\u53ef\u7528\uff0c\u5c1d\u8bd5\u56de\u9000...")),("bold"===n||"bolditalic"===n)&&s.includes("normal"))return t.setFont(e,"normal"),console.log("[PDF\u5bfc\u51fa] \u2713 \u56de\u9000\u5230 normal \u5b57\u4f53"),!1;if("italic"===n||"bolditalic"===n){if(s.includes("light"))return t.setFont(e,"light"),console.log("[PDF\u5bfc\u51fa] \u2713 \u659c\u4f53\u56de\u9000\u5230 light \u5b57\u4f53"),!1;if(s.includes("normal"))return t.setFont(e,"normal"),console.log("[PDF\u5bfc\u51fa] \u2713 \u659c\u4f53\u56de\u9000\u5230 normal \u5b57\u4f53"),!1}if(s.length>0){const n=s[0];return t.setFont(e,n),console.log("[PDF\u5bfc\u51fa] \u2713 \u56de\u9000\u5230 ".concat(n," \u5b57\u4f53")),!1}return t.setFont(e,"normal"),console.log("[PDF\u5bfc\u51fa] \u2713 \u56de\u9000\u5230 normal \u5b57\u4f53"),!1}catch(i){return console.error("[PDF\u5bfc\u51fa] \u8bbe\u7f6e\u5b57\u4f53\u5931\u8d25:",i),t.setFont(e||"helvetica"),!1}}function g(t,e){let n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:"helvetica";if(!e||"string"!==typeof e)return 0;try{const s=t.getFont();if(!s.metadata||!s.metadata.Unicode){const i=s.fontStyle||"normal";if(console.warn("[PDF\u5bfc\u51fa] \u5f53\u524d\u5b57\u4f53 (".concat(i,") \u7f3a\u5c11 Unicode \u5143\u6570\u636e")),"normal"!==i)return console.log("[PDF\u5bfc\u51fa] \u56de\u9000\u5230 normal \u5b57\u4f53"),T(t,n,"normal"),t.getTextWidth(e);{console.warn("[PDF\u5bfc\u51fa] normal \u5b57\u4f53\u4e5f\u7f3a\u5c11\u5143\u6570\u636e\uff0c\u4f7f\u7528\u8fd1\u4f3c\u8ba1\u7b97");const n=t.getFontSize();return e.length*n*.5}}return t.getTextWidth(e)}catch(s){console.error("[PDF\u5bfc\u51fa] getTextWidth \u5931\u8d25:",s);const n=t.getFontSize();return e.length*n*.5}}const F={alpha:"\u03b1",beta:"\u03b2",gamma:"\u03b3",delta:"\u03b4",epsilon:"\u03b5",varepsilon:"\u03b5",zeta:"\u03b6",eta:"\u03b7",theta:"\u03b8",vartheta:"\u03d1",iota:"\u03b9",kappa:"\u03ba",lambda:"\u03bb",mu:"\u03bc",nu:"\u03bd",xi:"\u03be",pi:"\u03c0",varpi:"\u03d6",rho:"\u03c1",varrho:"\u03f1",sigma:"\u03c3",varsigma:"\u03c2",tau:"\u03c4",upsilon:"\u03c5",phi:"\u03c6",varphi:"\u03c6",chi:"\u03c7",psi:"\u03c8",omega:"\u03c9",Alpha:"\u0391",Beta:"\u0392",Gamma:"\u0393",Delta:"\u0394",Epsilon:"\u0395",Zeta:"\u0396",Eta:"\u0397",Theta:"\u0398",Iota:"\u0399",Kappa:"\u039a",Lambda:"\u039b",Mu:"\u039c",Nu:"\u039d",Xi:"\u039e",Pi:"\u03a0",Rho:"\u03a1",Sigma:"\u03a3",Tau:"\u03a4",Upsilon:"\u03a5",Phi:"\u03a6",Chi:"\u03a7",Psi:"\u03a8",Omega:"\u03a9",pm:"\xb1",mp:"\u2213",times:"\xd7",div:"\xf7",cdot:"\xb7",ast:"\u2217",star:"\u22c6",circ:"\u2218",bullet:"\u2022",oplus:"\u2295",ominus:"\u2296",otimes:"\u2297",oslash:"\u2298",odot:"\u2299",dagger:"\u2020",ddagger:"\u2021",leq:"\u2264",le:"\u2264",geq:"\u2265",ge:"\u2265",neq:"\u2260",ne:"\u2260",approx:"\u2248",equiv:"\u2261",sim:"\u223c",simeq:"\u2243",propto:"\u221d",perp:"\u22a5",parallel:"\u2225",subset:"\u2282",supset:"\u2283",subseteq:"\u2286",supseteq:"\u2287",in:"\u2208",notin:"\u2209",leftarrow:"\u2190",rightarrow:"\u2192",uparrow:"\u2191",downarrow:"\u2193",leftrightarrow:"\u2194",updownarrow:"\u2195",Leftarrow:"\u21d0",Rightarrow:"\u21d2",Uparrow:"\u21d1",Downarrow:"\u21d3",Leftrightarrow:"\u21d4",Updownarrow:"\u21d5",mapsto:"\u21a6",to:"\u2192",gets:"\u2190",infty:"\u221e",partial:"\u2202",nabla:"\u2207",forall:"\u2200",exists:"\u2203",nexists:"\u2204",emptyset:"\u2205",varnothing:"\u2205",complement:"\u2201",neg:"\xac",wedge:"\u2227",vee:"\u2228",cap:"\u2229",cup:"\u222a",int:"\u222b",iint:"\u222c",iiint:"\u222d",oint:"\u222e",sum:"\u2211",prod:"\u220f",coprod:"\u2210",bigcap:"\u22c2",bigcup:"\u22c3",bigvee:"\u22c1",bigwedge:"\u22c0",bigoplus:"\u2a01",bigotimes:"\u2a02",bigodot:"\u2a00",biguplus:"\u2a04",langle:"\u27e8",rangle:"\u27e9",lfloor:"\u230a",rfloor:"\u230b",lceil:"\u2308",rceil:"\u2309",vert:"|",Vert:"\u2016",dots:"\u2026",cdots:"\u22ef",vdots:"\u22ee",ddots:"\u22f1",ldots:"\u2026",therefore:"\u2234",because:"\u2235",angle:"\u2220",measuredangle:"\u2221",sphericalangle:"\u2222",prime:"\u2032",backprime:"\u2035",degree:"\xb0"},E={0:"\u2070",1:"\xb9",2:"\xb2",3:"\xb3",4:"\u2074",5:"\u2075",6:"\u2076",7:"\u2077",8:"\u2078",9:"\u2079","+":"\u207a","-":"\u207b","=":"\u207c","(":"\u207d",")":"\u207e",n:"\u207f",i:"\u2071",a:"\u1d43",b:"\u1d47",c:"\u1d9c",d:"\u1d48",e:"\u1d49",f:"\u1da0",g:"\u1d4d",h:"\u02b0",j:"\u02b2",k:"\u1d4f",l:"\u02e1",m:"\u1d50",o:"\u1d52",p:"\u1d56",r:"\u02b3",s:"\u02e2",t:"\u1d57",u:"\u1d58",v:"\u1d5b",w:"\u02b7",x:"\u02e3",y:"\u02b8",z:"\u1dbb"},_={0:"\u2080",1:"\u2081",2:"\u2082",3:"\u2083",4:"\u2084",5:"\u2085",6:"\u2086",7:"\u2087",8:"\u2088",9:"\u2089","+":"\u208a","-":"\u208b","=":"\u208c","(":"\u208d",")":"\u208e",a:"\u2090",e:"\u2091",h:"\u2095",i:"\u1d62",j:"\u2c7c",k:"\u2096",l:"\u2097",m:"\u2098",n:"\u2099",o:"\u2092",p:"\u209a",r:"\u1d63",s:"\u209b",t:"\u209c",u:"\u1d64",v:"\u1d65",x:"\u2093"};class I{constructor(t){let e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};this.pdf=t,this.config=(0,s.A)({fontSize:e.fontSize||10,color:e.color||[0,0,0],useUnicode:!1!==e.useUnicode},e)}renderInlineLaTeX(t,e,n,s){const i=this.simplifyLaTeX(t);if(this.hasComplexStructure(t))return this.renderComplexLaTeX(t,e,n,s,!0);this.pdf.setFontSize(this.config.fontSize),this.pdf.setTextColor(...this.config.color);try{this.pdf.setFont(this.pdf.getFont().fontName,"italic")}catch(o){}this.pdf.text(i,e,n);const r=this.pdf.getTextWidth(i);try{this.pdf.setFont(this.pdf.getFont().fontName,"normal")}catch(o){}return r}renderDisplayLaTeX(t,e,n,s){const i=e+s/2;if(this.hasComplexStructure(t))return this.renderComplexLaTeX(t,i,n,s,!1);const r=this.simplifyLaTeX(t),o=1.2*this.config.fontSize;this.pdf.setFontSize(o),this.pdf.setTextColor(...this.config.color);const a=this.pdf.getTextWidth(r),h=i-a/2;return this.pdf.setFillColor(250,250,250),this.pdf.rect(h-5,n-.8*o,a+10,1.5*o,"F"),this.pdf.text(r,h,n),{width:a+10,height:1.5*o}}simplifyLaTeX(t){let e=t;return e=e.replace(/\s+/g," ").trim(),e=e.replace(/\^{([^}]+)}/g,(t,e)=>this.convertToSuperscript(e)),e=e.replace(/\^(\w)/g,(t,e)=>this.convertToSuperscript(e)),e=e.replace(/_{([^}]+)}/g,(t,e)=>this.convertToSubscript(e)),e=e.replace(/_(\w)/g,(t,e)=>this.convertToSubscript(e)),Object.keys(F).forEach(t=>{const n=new RegExp("\\\\".concat(t,"(?![a-zA-Z])"),"g");e=e.replace(n,F[t])}),e=e.replace(/\\([a-zA-Z]+)/g,"$1"),e=e.replace(/\\(.)/g,"$1"),e=e.replace(/[{}]/g,""),e}convertToSuperscript(t){return t.split("").map(t=>E[t]||t).join("")}convertToSubscript(t){return t.split("").map(t=>_[t]||t).join("")}hasComplexStructure(t){return[/\\frac\{/,/\\sqrt[\[\{]/,/\\begin\{/,/\\left/,/\\right/,/\\sum/,/\\int/,/\\prod/,/\\lim/,/\\mathbb/,/\\mathcal/,/\\boldsymbol/,/\\overline/,/\\underline/,/\\vec/,/\\hat/,/\\tilde/,/\\dot/,/\\ddot/].some(e=>e.test(t))}renderComplexLaTeX(t,e,n,s,i){const r=i?this.config.fontSize:1.2*this.config.fontSize,o=this.parseComplexLaTeX(t);let a=0;this.pdf.setFontSize(r),o.forEach(t=>{switch(t.type){case"text":a+=this.pdf.getTextWidth(t.content);break;case"fraction":const e=.75*r;this.pdf.setFontSize(e);const n=this.pdf.getTextWidth(t.numerator),s=this.pdf.getTextWidth(t.denominator);a+=Math.max(n,s)+4,this.pdf.setFontSize(r);break;case"sqrt":a+=this.pdf.getTextWidth(t.content)+8;break;case"superscript":case"subscript":a+=this.pdf.getTextWidth(t.base||"");const i=.7*r;this.pdf.setFontSize(i),a+=this.pdf.getTextWidth(t.exponent||t.subscript||""),this.pdf.setFontSize(r);break;default:a+=this.pdf.getTextWidth(t.raw||"")}});let h=i?e:e-a/2,c=r,l=!1;return o.forEach(t=>{switch(t.type){case"text":this.pdf.setFontSize(r),this.pdf.text(t.content,h,n);const e=this.pdf.getTextWidth(t.content);h+=e;break;case"fraction":const s=this.renderFraction(t.numerator,t.denominator,h,n,r);h+=s,l=!0;break;case"sqrt":const i=this.renderSquareRoot(t.content,h,n,r);h+=i;break;case"superscript":const o=this.renderSuperscript(t.base,t.exponent,h,n,r);h+=o;break;case"subscript":const a=this.renderSubscript(t.base,t.subscript,h,n,r);h+=a;break;default:const c=t.raw||"";this.pdf.setFontSize(r),this.pdf.text(c,h,n);const d=this.pdf.getTextWidth(c);h+=d}}),c=l?1.2*r:r,i?a:{width:a,height:c}}parseComplexLaTeX(t){const e=[];let n=t;const s=/\\frac\{([^}]*)\}\{([^}]*)\}/;for(;n.length>0;){const t=n.match(s);if(!t){const t=this.simplifyLaTeX(n);t&&e.push({type:"text",content:t});break}if(t.index>0){const s=n.substring(0,t.index),i=this.simplifyLaTeX(s);i&&e.push({type:"text",content:i})}e.push({type:"fraction",numerator:this.simplifyLaTeX(t[1]),denominator:this.simplifyLaTeX(t[2]),raw:t[0]}),n=n.substring(t.index+t[0].length)}return e}renderFraction(t,e,n,s,i){const r=.75*i;this.pdf.setFontSize(r);const o=this.pdf.getTextWidth(t),a=this.pdf.getTextWidth(e),h=Math.max(o,a)+4,c=.17*r,l=.5*r,d=n+(h-o)/2;this.pdf.text(t,d,s-c),this.pdf.setLineWidth(.3),this.pdf.setDrawColor(0,0,0),this.pdf.line(n,s,n+h,s);const p=n+(h-a)/2;return this.pdf.text(e,p,s+l),this.pdf.setFontSize(i),h}renderSquareRoot(t,e,n,s){const i=this.pdf.getTextWidth(t)+8,r=1.2*s;return this.pdf.setLineWidth(.3),this.pdf.line(e,n-r/3,e+2,n),this.pdf.line(e+2,n,e+4,n-r),this.pdf.line(e+4,n-r,e+i,n-r),this.pdf.setFontSize(s),this.pdf.text(t,e+6,n),i}renderSuperscript(t,e,n,s,i){this.pdf.setFontSize(i),this.pdf.text(t,n,s);const r=this.pdf.getTextWidth(t),o=.7*i;this.pdf.setFontSize(o);const a=this.simplifyLaTeX(e);this.pdf.text(a,n+r,s-.3*i);const h=this.pdf.getTextWidth(a);return this.pdf.setFontSize(i),r+h}renderSubscript(t,e,n,s,i){this.pdf.setFontSize(i),this.pdf.text(t,n,s);const r=this.pdf.getTextWidth(t),o=.7*i;this.pdf.setFontSize(o);const a=this.simplifyLaTeX(e);this.pdf.text(a,n+r,s+.3*i);const h=this.pdf.getTextWidth(a);return this.pdf.setFontSize(i),r+h}}const x={FONT_SIZE_TITLE:20,FONT_SIZE_H1:16,FONT_SIZE_H2:14,FONT_SIZE_SENDER:12,FONT_SIZE_BODY:10,FONT_SIZE_CODE:9,FONT_SIZE_TIMESTAMP:8,FONT_SIZE_HEADER:8,FONT_SIZE_FOOTER:8,COLOR_SENDER_HUMAN:[0,102,204],COLOR_SENDER_ASSISTANT:[102,102,102],COLOR_TIMESTAMP:[150,150,150],COLOR_CODE_BG:[245,245,245],COLOR_SECTION_BG:[250,250,250],COLOR_TEXT:[0,0,0],COLOR_HEADER:[100,100,100],COLOR_FOOTER:[150,150,150],COLOR_BORDER:[200,200,200],MARGIN_LEFT:15,MARGIN_RIGHT:15,MARGIN_TOP:15,MARGIN_BOTTOM:25,LINE_HEIGHT:5,SECTION_SPACING:8,MESSAGE_SPACING:10,FOOTER_HEIGHT:15,PAGE_WIDTH:210,PAGE_HEIGHT:297};class m{constructor(t){this.manager=t,this.latexRenderer=null}get pdf(){return this.manager.pdf}get currentY(){return this.manager.currentY}set currentY(t){this.manager.currentY=t}get config(){return this.manager.config}get chineseFontName(){return this.manager.chineseFontName}get availableFontWeights(){return this.manager.availableFontWeights}safeSetFont(t,e){return this.manager.safeSetFont(t,e)}safeGetTextWidth(t){return this.manager.safeGetTextWidth(t)}safeRenderText(t,e,n,s){return this.manager.safeRenderText(t,e,n,s)}checkPageBreak(t){return this.manager.checkPageBreak(t)}renderTitle(t){this.pdf.setFontSize(x.FONT_SIZE_TITLE),this.pdf.setTextColor(...x.COLOR_TEXT);const e=l(t.name||"Conversation"),n=x.PAGE_WIDTH-x.MARGIN_LEFT-x.MARGIN_RIGHT;let s;try{s=this.pdf.splitTextToSize(e,n)}catch(i){console.error("[PDF\u5bfc\u51fa] \u6807\u9898\u5206\u5272\u5931\u8d25,\u4f7f\u7528\u539f\u59cb\u6807\u9898:",i),s=[e]}s.forEach(t=>{this.checkPageBreak(x.FONT_SIZE_TITLE);const e=l(t);e&&e.trim().length>0&&this.pdf.text(e,x.MARGIN_LEFT,this.currentY),this.currentY+=1.5*x.LINE_HEIGHT}),this.currentY+=x.SECTION_SPACING}renderMetadata(t){this.pdf.setFontSize(x.FONT_SIZE_TIMESTAMP),this.pdf.setTextColor(...x.COLOR_TIMESTAMP);const e=[];t.platform&&e.push("Platform: ".concat(t.platform)),t.created_at&&e.push("Created: ".concat(t.created_at)),t.updated_at&&e.push("Updated: ".concat(t.updated_at)),e.push("Exported: ".concat(this.manager.exportDate)),e.forEach(t=>{this.checkPageBreak(x.FONT_SIZE_TIMESTAMP),this.pdf.text(t,x.MARGIN_LEFT,this.currentY),this.currentY+=x.LINE_HEIGHT})}renderMessage(t,e){var n,s,i,r;this.checkPageBreak(x.FONT_SIZE_SENDER+x.MESSAGE_SPACING);const o=this.pdf.internal.getCurrentPageInfo().pageNumber,a=this.currentY;this.manager.messageAnchors.push({index:e,page:o,y:a,sender:t.sender,title:t.display_text?t.display_text.substring(0,50):""}),this.renderSender(t,e),this.config.includeTimestamps&&t.timestamp&&this.renderTimestamp(t.timestamp),t.thinking&&this.config.includeThinking&&"human"!==t.sender&&this.renderThinking(t.thinking),t.display_text&&this.renderBody(t.display_text),(null===(n=t.attachments)||void 0===n?void 0:n.length)>0&&"human"===t.sender&&this.renderAttachments(t.attachments),(null===(s=t.artifacts)||void 0===s?void 0:s.length)>0&&this.config.includeArtifacts&&"human"!==t.sender&&t.artifacts.forEach(t=>{this.renderArtifact(t)}),(null===(i=t.tools)||void 0===i?void 0:i.length)>0&&this.config.includeTools&&t.tools.forEach(t=>{this.renderTool(t)}),(null===(r=t.citations)||void 0===r?void 0:r.length)>0&&this.config.includeCitations&&this.renderCitations(t.citations),this.currentY+=x.MESSAGE_SPACING}renderSender(t,e){var n;this.pdf.setFontSize(x.FONT_SIZE_SENDER);const s="human"===t.sender?x.COLOR_SENDER_HUMAN:x.COLOR_SENDER_ASSISTANT;this.pdf.setTextColor(...s);const i="human"===t.sender?"Human":"Assistant",r="".concat(e,". ").concat(i);let o=r;if(null!==(n=t.branchInfo)&&void 0!==n&&n.isBranchPoint){o=r+" [Branch ".concat(t.branchInfo.childCount,"]")}const a=l(o);a&&a.trim().length>0&&this.pdf.text(a,x.MARGIN_LEFT,this.currentY),this.currentY+=1.2*x.LINE_HEIGHT}renderTimestamp(t){this.pdf.setFontSize(x.FONT_SIZE_TIMESTAMP),this.pdf.setTextColor(...x.COLOR_TIMESTAMP),this.pdf.text(t,x.MARGIN_LEFT,this.currentY),this.currentY+=x.LINE_HEIGHT}renderBody(t){this.pdf.setFontSize(x.FONT_SIZE_BODY),this.pdf.setTextColor(...x.COLOR_TEXT);const e=x.PAGE_WIDTH-x.MARGIN_LEFT-x.MARGIN_RIGHT,n=this.manager.parseTextWithCodeBlocksAndLatex(t);for(const s of n)"code"===s.type?this.renderCodeBlock(s.content,s.language):"latex-display"===s.type?this.renderLatexDisplay(s):this.renderMarkdownText(s.content,e);this.currentY+=.3*x.LINE_HEIGHT}getLatexRenderer(){return this.latexRenderer||(this.latexRenderer=new I(this.pdf,{fontSize:x.FONT_SIZE_BODY,color:x.COLOR_TEXT})),this.latexRenderer}renderLatexDisplay(t){const e=x.PAGE_WIDTH-x.MARGIN_LEFT-x.MARGIN_RIGHT;this.checkPageBreak(x.FONT_SIZE_BODY+30);try{const n=this.getLatexRenderer().renderDisplayLaTeX(t.content,x.MARGIN_LEFT,this.currentY+x.FONT_SIZE_BODY,e);this.currentY+=n.height+.05*x.LINE_HEIGHT}catch(n){console.warn("[PDF\u5bfc\u51fa] LaTeX\u6e32\u67d3\u5931\u8d25\uff0c\u56de\u9000\u5230\u6e90\u7801\u663e\u793a:",n),this.renderLatexDisplayAsSource(t,e)}}renderLatexDisplayAsSource(t,e){this.pdf.setFillColor(240,248,255),this.pdf.rect(x.MARGIN_LEFT,this.currentY-3,e,3*x.LINE_HEIGHT,"F"),this.pdf.setDrawColor(100,150,200),this.pdf.setLineWidth(.5),this.pdf.roundedRect(x.MARGIN_LEFT,this.currentY-3,e,3*x.LINE_HEIGHT,1.5,1.5,"S"),this.pdf.setFontSize(x.FONT_SIZE_BODY),this.pdf.setTextColor(70,130,180),this.pdf.text("[LaTeX]",x.MARGIN_LEFT+2,this.currentY),this.currentY+=x.LINE_HEIGHT,this.pdf.setFont("courier","normal"),this.pdf.setFontSize(x.FONT_SIZE_CODE),this.pdf.setTextColor(50,50,50);this.pdf.splitTextToSize(t.content,e-4).forEach(t=>{this.pdf.text(t,x.MARGIN_LEFT+2,this.currentY),this.currentY+=x.LINE_HEIGHT}),this.pdf.setFont(this.chineseFontName,"normal"),this.pdf.setTextColor(...x.COLOR_TEXT),this.currentY+=x.SECTION_SPACING}renderPlainText(t,e){if(!t||0===t.trim().length)return void(this.currentY+=x.LINE_HEIGHT);const n=l(t);if(!n||0===n.trim().length)return console.warn("[PDF\u5bfc\u51fa] \u6587\u672c\u6e05\u7406\u540e\u4e3a\u7a7a\uff0c\u8df3\u8fc7"),void(this.currentY+=x.LINE_HEIGHT);let s;try{s=this.pdf.splitTextToSize(n,e)}catch(i){console.error("[PDF\u5bfc\u51fa] splitTextToSize\u5931\u8d25\uff0c\u4f7f\u7528\u7b80\u5355\u6362\u884c:",i),s=n.split("\n")}s.forEach(t=>{this.checkPageBreak(x.FONT_SIZE_BODY);const e=l(t);e&&e.trim().length>0&&this.pdf.text(e,x.MARGIN_LEFT,this.currentY),this.currentY+=x.LINE_HEIGHT})}renderCodeBlock(t){let e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"";this.checkPageBreak(x.FONT_SIZE_CODE+2*x.SECTION_SPACING);const n=x.PAGE_WIDTH-x.MARGIN_LEFT-x.MARGIN_RIGHT,s=n-8-8,i=l(t),r=l(e);if(r){this.pdf.setFontSize(x.FONT_SIZE_TIMESTAMP),this.pdf.setTextColor(100,100,100);const t=r.toUpperCase(),e=this.safeGetTextWidth(t)+4;this.pdf.setFillColor(220,220,220),this.pdf.roundedRect(x.MARGIN_LEFT,this.currentY-3,e,5,1,1,"F"),this.pdf.text(t,x.MARGIN_LEFT+2,this.currentY),this.currentY+=1.2*x.LINE_HEIGHT}this.pdf.setFontSize(x.FONT_SIZE_CODE),this.pdf.setFont(this.chineseFontName);const o=i.split("\n"),a=[];o.forEach(t=>{if(!t)return void a.push({text:"",lineNumber:a.length+1});const e=l(t);if(e)try{this.pdf.splitTextToSize(e,s).forEach((t,e)=>{a.push({text:t,lineNumber:0===e?a.length+1:null})})}catch(n){a.push({text:e,lineNumber:a.length+1})}else a.push({text:"",lineNumber:a.length+1})});const h=this.currentY,c=this.pdf.internal.getCurrentPageInfo().pageNumber,d=Math.min(a.length*x.LINE_HEIGHT+6,x.PAGE_HEIGHT-x.MARGIN_BOTTOM-this.currentY);this.pdf.setFillColor(248,248,248),this.pdf.rect(x.MARGIN_LEFT,h-3,n,d,"F"),this.currentY=h,a.forEach((t,e)=>{let{text:s,lineNumber:i}=t;if(this.currentY+x.FONT_SIZE_CODE>x.PAGE_HEIGHT-x.MARGIN_BOTTOM){this.pdf.setDrawColor(200,200,200),this.pdf.setLineWidth(.3);const t=this.currentY;this.pdf.line(x.MARGIN_LEFT,h-3,x.MARGIN_LEFT,t),this.pdf.line(x.MARGIN_LEFT+n,h-3,x.MARGIN_LEFT+n,t),this.pdf.addPage(),this.currentY=x.MARGIN_TOP;const s=a.length-e,i=Math.min(s*x.LINE_HEIGHT+3,x.PAGE_HEIGHT-x.MARGIN_BOTTOM-this.currentY);this.pdf.setFillColor(248,248,248),this.pdf.rect(x.MARGIN_LEFT,this.currentY-3,n,i,"F")}if(null!==i){this.pdf.setFontSize(x.FONT_SIZE_CODE-1),this.pdf.setTextColor(150,150,150);const t=String(i).padStart(3," ");this.pdf.text(t,x.MARGIN_LEFT+1,this.currentY)}const r=l(s);if(null!==r&&void 0!==r){const t=u(r);if(t.some(t=>t.heading)){const e=t[0].heading,n=[14,13,12,11,10,10];this.pdf.setFontSize(n[e-1]||x.FONT_SIZE_CODE),this.pdf.setTextColor(20,20,20)}else this.pdf.setFontSize(x.FONT_SIZE_CODE),this.pdf.setTextColor(50,50,50);let e=x.MARGIN_LEFT+8+2;t.forEach(t=>{(t.heading||t.bold)&&this.availableFontWeights.includes("bold")?this.pdf.setFont(this.chineseFontName,"bold"):this.pdf.setFont(this.chineseFontName,"normal"),this.pdf.text(t.text,e,this.currentY),e+=this.safeGetTextWidth(t.text)}),this.pdf.setFont(this.chineseFontName,"normal"),this.pdf.setFontSize(x.FONT_SIZE_CODE),this.pdf.setTextColor(50,50,50)}this.currentY+=x.LINE_HEIGHT});const p=this.pdf.internal.getCurrentPageInfo().pageNumber;for(let l=c;l<=p;l++){this.pdf.setPage(l);const t=l===c,e=l===p;let s,i;t&&e?(s=h-3,i=this.currentY+3):t?(s=h-3,i=x.PAGE_HEIGHT-x.MARGIN_BOTTOM):e?(s=x.MARGIN_TOP-3,i=this.currentY+3):(s=x.MARGIN_TOP-3,i=x.PAGE_HEIGHT-x.MARGIN_BOTTOM),this.pdf.setDrawColor(200,200,200),this.pdf.setLineWidth(.3),t&&e?this.pdf.roundedRect(x.MARGIN_LEFT,s,n,i-s,1.5,1.5,"S"):(this.pdf.line(x.MARGIN_LEFT,s,x.MARGIN_LEFT,i),this.pdf.line(x.MARGIN_LEFT+n,s,x.MARGIN_LEFT+n,i),t&&this.pdf.line(x.MARGIN_LEFT,s,x.MARGIN_LEFT+n,s),e&&this.pdf.line(x.MARGIN_LEFT,i,x.MARGIN_LEFT+n,i)),this.pdf.setDrawColor(220,220,220),this.pdf.setLineWidth(.2),this.pdf.line(x.MARGIN_LEFT+8,s,x.MARGIN_LEFT+8,i)}this.pdf.setPage(p),this.pdf.setFont(this.chineseFontName),this.pdf.setTextColor(...x.COLOR_TEXT),this.currentY+=x.SECTION_SPACING}renderMarkdownText(t,e){if(!t||0===t.trim().length)return void(this.currentY+=x.LINE_HEIGHT);const n=l(t);if(!n||0===n.trim().length)return void(this.currentY+=x.LINE_HEIGHT);const s=n.split("\n");for(const i of s)this.checkPageBreak(x.FONT_SIZE_BODY),""===i.trim()?this.currentY+=x.LINE_HEIGHT:i.match(/^#{1,6}\s/)?this.renderMarkdownHeading(i,e):i.match(/^(---|___|\*\*\*)$/)?this.renderHorizontalRule(e):i.match(/^>\s/)?this.renderMarkdownQuote(i,e):i.match(/^[-*+]\s/)||i.match(/^\d+\.\s/)?this.renderMarkdownList(i,e):this.renderMarkdownInlineFormats(i,e)}renderHorizontalRule(t){this.currentY+=.8*x.LINE_HEIGHT;const e=this.currentY;this.pdf.setDrawColor(230,230,230),this.pdf.setLineWidth(.2),this.pdf.line(x.MARGIN_LEFT,e,x.MARGIN_LEFT+t,e),this.currentY+=4*x.LINE_HEIGHT}renderMarkdownHeading(t,e){const n=t.match(/^(#{1,6})\s+(.+)$/);if(!n)return void this.renderPlainText(t,e);const s=n[1].length,i=n[2],r=x.FONT_SIZE_BODY+2*(7-s),o=this.pdf.internal.getFontSize();this.pdf.setFontSize(r),this.safeSetFont(this.chineseFontName,"bold");try{this.pdf.splitTextToSize(i,e).forEach(t=>{this.checkPageBreak(r);const e=l(t);e&&e.trim().length>0&&this.pdf.text(e,x.MARGIN_LEFT,this.currentY),this.currentY+=1.2*x.LINE_HEIGHT})}catch(a){console.error("[PDF\u5bfc\u51fa] \u6807\u9898\u6e32\u67d3\u5931\u8d25:",a),this.pdf.text(i,x.MARGIN_LEFT,this.currentY),this.currentY+=1.2*x.LINE_HEIGHT}this.pdf.setFontSize(o),this.safeSetFont(this.chineseFontName,"normal"),this.currentY+=.5*x.LINE_HEIGHT}renderMarkdownQuote(t,e){const n=t.replace(/^>\s*/,""),s=e-8,i=x.MARGIN_LEFT+6;this.pdf.setDrawColor(150,150,150),this.pdf.setLineWidth(.5);const r=this.currentY-2;this.pdf.setFontSize(x.FONT_SIZE_BODY),this.pdf.setTextColor(100,100,100);try{this.pdf.splitTextToSize(n,s).forEach(t=>{this.checkPageBreak(x.FONT_SIZE_BODY);const e=l(t);e&&e.trim().length>0&&this.pdf.text(e,i,this.currentY),this.currentY+=x.LINE_HEIGHT}),this.pdf.line(x.MARGIN_LEFT+2,r,x.MARGIN_LEFT+2,this.currentY-2)}catch(o){console.error("[PDF\u5bfc\u51fa] \u5f15\u7528\u6e32\u67d3\u5931\u8d25:",o),this.pdf.text(n,i,this.currentY),this.currentY+=x.LINE_HEIGHT}this.pdf.setTextColor(...x.COLOR_TEXT)}renderMarkdownList(t,e){let n="",s="";const i=t.match(/^([-*+])\s+(.+)$/),r=t.match(/^(\d+)\.\s+(.+)$/);if(i)n="\u2022",s=i[2];else{if(!r)return void this.renderPlainText(t,e);n=r[1]+".",s=r[2]}const o=this.safeGetTextWidth(n+"  "),a=e-o,h=x.MARGIN_LEFT+o;this.pdf.setFontSize(x.FONT_SIZE_BODY),this.pdf.text(n,x.MARGIN_LEFT+2,this.currentY);try{const t=p(s),e=x.MARGIN_LEFT;x.MARGIN_LEFT=h,this.renderInlineSegments(t,a),x.MARGIN_LEFT=e}catch(c){console.error("[PDF\u5bfc\u51fa] \u5217\u8868\u6e32\u67d3\u5931\u8d25:",c),this.pdf.text(s,h,this.currentY),this.currentY+=x.LINE_HEIGHT}}renderMarkdownInlineFormats(t,e){if(!t||0===t.trim().length)return void(this.currentY+=x.LINE_HEIGHT);const n=p(t);this.renderInlineSegments(n,e)}renderInlineSegments(t,e){let n=x.MARGIN_LEFT,i=[];t.forEach((t,r)=>{let o,a;if("latex-inline"===t.type){o=this.getLatexRenderer().simplifyLaTeX(t.text),this.applySegmentStyle(t.type),a=this.safeGetTextWidth(o)}else{if(o=l(t.text||""),!o)return;this.applySegmentStyle(t.type),a=this.safeGetTextWidth(o)}if(a>x.PAGE_WIDTH-x.MARGIN_RIGHT-n&&0===i.length){if("latex-inline"===t.type){console.warn("[PDF\u5bfc\u51fa] LaTeX\u516c\u5f0f\u8fc7\u957f\uff0c\u4fdd\u6301\u5b8c\u6574\u6e32\u67d3:",t.text);const e=(0,s.A)((0,s.A)({},t),{},{x:n});return i.push(e),void(n+=a)}try{const e=x.PAGE_WIDTH-x.MARGIN_LEFT-x.MARGIN_RIGHT;let r=this.pdf.splitTextToSize(o,e);r=f(r);for(let n=0;n<r.length-1;n++)this.checkPageBreak(x.FONT_SIZE_BODY),i=[(0,s.A)((0,s.A)({},t),{},{x:x.MARGIN_LEFT,text:r[n]})],this.renderSegmentLine(i),this.currentY+=x.LINE_HEIGHT;const a=r[r.length-1],h=this.safeGetTextWidth(a);i=[(0,s.A)((0,s.A)({},t),{},{x:x.MARGIN_LEFT,text:a})],n=x.MARGIN_LEFT+h}catch(c){console.warn("[PDF\u5bfc\u51fa] \u6587\u672c\u62c6\u5206\u5931\u8d25\uff0c\u5f3a\u5236\u6362\u884c:",c);const e=(0,s.A)((0,s.A)({},t),{},{x:n});"latex-inline"!==t.type&&(e.text=o),i.push(e),n+=a}return}if(n+a>x.PAGE_WIDTH-x.MARGIN_RIGHT&&i.length>0&&(this.checkPageBreak(x.FONT_SIZE_BODY),this.renderSegmentLine(i),this.currentY+=x.LINE_HEIGHT,n=x.MARGIN_LEFT,i=[],a>e)){if("latex-inline"===t.type)return console.warn("[PDF\u5bfc\u51fa] LaTeX\u516c\u5f0f\u8fc7\u957f\uff08\u6362\u884c\u540e\u4ecd\u8d85\u5bbd\uff09\uff0c\u4fdd\u6301\u5b8c\u6574\u6e32\u67d3:",t.text),i=[(0,s.A)((0,s.A)({},t),{},{x:x.MARGIN_LEFT})],void(n=x.MARGIN_LEFT+a);try{let r=this.pdf.splitTextToSize(o,e);r=f(r);for(let e=0;e<r.length-1;e++){this.checkPageBreak(x.FONT_SIZE_BODY);const n=[(0,s.A)((0,s.A)({},t),{},{x:x.MARGIN_LEFT,text:r[e]})];this.renderSegmentLine(n),this.currentY+=x.LINE_HEIGHT}const a=r[r.length-1],h=this.safeGetTextWidth(a);i=[(0,s.A)((0,s.A)({},t),{},{x:x.MARGIN_LEFT,text:a})],n=x.MARGIN_LEFT+h}catch(c){console.warn("[PDF\u5bfc\u51fa] \u6587\u672c\u62c6\u5206\u5931\u8d25:",c);const e=(0,s.A)((0,s.A)({},t),{},{x:n});"latex-inline"!==t.type&&(e.text=o),i.push(e),n+=a}return}const h=(0,s.A)((0,s.A)({},t),{},{x:n});"latex-inline"!==t.type&&(h.text=o),i.push(h),n+=a}),i.length>0&&(this.checkPageBreak(x.FONT_SIZE_BODY),this.renderSegmentLine(i),this.currentY+=x.LINE_HEIGHT),this.pdf.setFont(this.chineseFontName,"normal"),this.pdf.setTextColor(...x.COLOR_TEXT)}renderSegmentLine(t){t.forEach(t=>{if(this.applySegmentStyle(t.type),"latex-inline"===t.type)try{this.getLatexRenderer().renderInlineLaTeX(t.text,t.x,this.currentY,x.PAGE_WIDTH-x.MARGIN_RIGHT-t.x)}catch(e){console.warn("[PDF\u5bfc\u51fa] \u884c\u5185LaTeX\u6e32\u67d3\u5931\u8d25\uff0c\u663e\u793a\u6e90\u7801:",e),this.pdf.text(t.text,t.x,this.currentY)}else if("link"===t.type){this.pdf.textWithLink(t.text,t.x,this.currentY,{url:t.url||"#"});const e=this.safeGetTextWidth(t.text);this.pdf.line(t.x,this.currentY+.5,t.x+e,this.currentY+.5)}else if("code"===t.type){const e=this.safeGetTextWidth(t.text),n=1;this.pdf.setFillColor(245,245,245),this.pdf.rect(t.x-n,this.currentY-3,e+2*n,4,"F"),this.pdf.text(t.text,t.x,this.currentY)}else this.pdf.text(t.text,t.x,this.currentY)})}applySegmentStyle(t){switch(this.pdf.setFontSize(x.FONT_SIZE_BODY),this.pdf.setTextColor(...x.COLOR_TEXT),t){case"latex-inline":try{this.pdf.setFont(this.chineseFontName,"italic")}catch(e){this.pdf.setFont(this.chineseFontName,"normal")}this.pdf.setFontSize(x.FONT_SIZE_BODY),this.pdf.setTextColor(50,50,50);break;case"latex-display":break;case"bold":console.log("[PDF\u5bfc\u51fa] \u5e94\u7528\u7c97\u4f53\u6837\u5f0f, \u5b57\u4f53:",this.chineseFontName,"\u53ef\u7528\u53d8\u4f53:",this.availableFontWeights);const t=this.safeSetFont(this.chineseFontName,"bold");console.log("[PDF\u5bfc\u51fa] safeSetFont \u8fd4\u56de:",t),t?console.log("[PDF\u5bfc\u51fa] \u4f7f\u7528\u5b57\u4f53\u7c97\u4f53\u53d8\u4f53"):(console.warn("[PDF\u5bfc\u51fa] \u7c97\u4f53\u5b57\u4f53\u4e0d\u53ef\u7528\uff0c\u4f7f\u7528\u89c6\u89c9\u56de\u9000\u65b9\u6848: \u6df1\u84dd\u8272 RGB(20,20,150) + \u5b57\u4f53\u5927\u5c0f",x.FONT_SIZE_BODY+1),this.pdf.setTextColor(20,20,150),this.pdf.setFontSize(x.FONT_SIZE_BODY+1));break;case"italic":this.safeSetFont(this.chineseFontName,"light")||this.pdf.setTextColor(70,130,180);break;case"bold-italic":if(!this.safeSetFont(this.chineseFontName,"bolditalic")){this.safeSetFont(this.chineseFontName,"bold")?this.pdf.setTextColor(70,130,180):(this.pdf.setTextColor(30,60,120),this.pdf.setFontSize(x.FONT_SIZE_BODY+.5))}break;case"code":this.pdf.setFont("courier","normal"),this.pdf.setFontSize(x.FONT_SIZE_CODE),this.pdf.setTextColor(220,50,50);break;case"link":this.safeSetFont(this.chineseFontName,"light")||this.safeSetFont(this.chineseFontName,"normal"),this.pdf.setTextColor(0,102,204);break;default:this.safeSetFont(this.chineseFontName,"normal")}}renderThinking(t){this.renderSection("\ud83d\udcad Thinking",t,x.COLOR_SECTION_BG)}renderArtifact(t){const e="\ud83d\udcc4 Artifact: ".concat(t.title||"Untitled"),n=t.content||"";this.renderSection(e,n,x.COLOR_SECTION_BG)}renderTool(t){const e="\ud83d\udd27 Tool: ".concat(t.name||"Unknown"),n="Input: ".concat(JSON.stringify(t.input,null,2),"\n\nOutput: ").concat(t.output||"N/A");this.renderSection(e,n,x.COLOR_SECTION_BG)}renderCitations(t){const e=t.map((t,e)=>"[".concat(e+1,"] ").concat(t.title||t.url||"Unknown")).join("\n");this.renderSection("\ud83d\udcda Citations",e,x.COLOR_SECTION_BG)}renderAttachments(t){const e=t.map((t,e)=>"[".concat(e+1,"] ").concat(t.file_name||t.name||"file"," (").concat(t.file_type||t.type||"unknown",")")).join("\n");this.renderSection("\ud83d\udcce Attachments",e,x.COLOR_SECTION_BG)}renderSection(t,e,n){this.checkPageBreak(x.FONT_SIZE_H2+2*x.SECTION_SPACING);const s=x.PAGE_WIDTH-x.MARGIN_LEFT-x.MARGIN_RIGHT,i=l(t),r=l(e);let o;try{o=this.pdf.splitTextToSize(r,s-4)}catch(h){console.error("[PDF\u5bfc\u51fa] \u533a\u5757\u5185\u5bb9\u5206\u5272\u5931\u8d25:",h),o=r.split("\n")}const a=x.LINE_HEIGHT*(o.length+2);this.pdf.setFillColor(...n),this.pdf.rect(x.MARGIN_LEFT,this.currentY-3,s,a,"F"),this.pdf.setFontSize(x.FONT_SIZE_H2),this.pdf.setTextColor(...x.COLOR_TEXT),i&&i.trim().length>0&&this.pdf.text(i,x.MARGIN_LEFT+2,this.currentY),this.currentY+=1.2*x.LINE_HEIGHT,this.pdf.setFontSize(x.FONT_SIZE_BODY),o.forEach(t=>{this.checkPageBreak(x.FONT_SIZE_BODY);const e=l(t);e&&e.trim().length>0&&this.pdf.text(e,x.MARGIN_LEFT+2,this.currentY),this.currentY+=x.LINE_HEIGHT}),this.currentY+=x.SECTION_SPACING}renderTOCWithLinks(t,e){this.pdf.setPage(t),this.currentY=x.MARGIN_TOP,this.pdf.setFontSize(x.FONT_SIZE_H1),this.pdf.setTextColor(...x.COLOR_TEXT),this.pdf.text("Table of Contents",x.MARGIN_LEFT,this.currentY),this.currentY+=2*x.LINE_HEIGHT,this.pdf.setDrawColor(...x.COLOR_BORDER),this.pdf.setLineWidth(.3),this.pdf.line(x.MARGIN_LEFT,this.currentY,x.PAGE_WIDTH-x.MARGIN_RIGHT,this.currentY),this.currentY+=x.LINE_HEIGHT,this.pdf.setFontSize(x.FONT_SIZE_BODY);x.PAGE_WIDTH,x.MARGIN_LEFT,x.MARGIN_RIGHT;this.manager.messageAnchors.forEach((t,n)=>{var s;const i=e[n];if(!i)return;this.checkPageBreak(2*x.FONT_SIZE_BODY);const r="".concat(t.index,"."),o="human"===t.sender?"Human":"Assistant";let a=t.title||"";a=l(a),a=a.replace(/\n/g," ").substring(0,50),a.length>=50&&(a+="...");let h="";null!==(s=i.branchInfo)&&void 0!==s&&s.isBranchPoint&&(h=" [Branch ".concat(i.branchInfo.childCount,"]"));const c="".concat(r," ").concat(o).concat(h),d="p.".concat(t.page),p="human"===t.sender?x.COLOR_SENDER_HUMAN:x.COLOR_SENDER_ASSISTANT;this.pdf.setTextColor(...p);const f=this.safeGetTextWidth(d),u=x.PAGE_WIDTH-x.MARGIN_RIGHT-f,T=this.currentY;this.pdf.textWithLink(c,x.MARGIN_LEFT+5,T,{pageNumber:t.page}),this.pdf.setTextColor(...x.COLOR_TIMESTAMP),this.pdf.textWithLink(d,u,T,{pageNumber:t.page}),a&&(this.pdf.setFontSize(x.FONT_SIZE_TIMESTAMP),this.pdf.setTextColor(...x.COLOR_TIMESTAMP),this.currentY+=x.LINE_HEIGHT,this.checkPageBreak(x.FONT_SIZE_TIMESTAMP),this.pdf.text(a,x.MARGIN_LEFT+10,this.currentY),this.pdf.setFontSize(x.FONT_SIZE_BODY)),this.currentY+=1.5*x.LINE_HEIGHT})}renderFooter(t,e){const n=this.currentY,s=this.pdf.internal.getFontSize();this.pdf.setFontSize(x.FONT_SIZE_FOOTER),this.pdf.setTextColor(...x.COLOR_FOOTER);const i=x.PAGE_HEIGHT-10;this.pdf.setDrawColor(...x.COLOR_BORDER),this.pdf.setLineWidth(.1),this.pdf.line(x.MARGIN_LEFT,x.PAGE_HEIGHT-x.FOOTER_HEIGHT,x.PAGE_WIDTH-x.MARGIN_RIGHT,x.PAGE_HEIGHT-x.FOOTER_HEIGHT);const r="Exported: ".concat(this.manager.exportDate);this.pdf.text(r,x.MARGIN_LEFT,i);const o="".concat(t," / ").concat(e),a=this.safeGetTextWidth(o);this.pdf.text(o,x.PAGE_WIDTH-x.MARGIN_RIGHT-a,i),this.pdf.setFontSize(s),this.pdf.setTextColor(...x.COLOR_TEXT),this.currentY=n}}class N{constructor(){this.pdf=null,this.currentY=x.MARGIN_TOP,this.config={},this.useChineseFont=!1,this.chineseFontName="helvetica",this.availableFontWeights=[],this.isSystemFont=!1,this.meta=null,this.exportDate=null,this.messageAnchors=[],this.contentRenderer=null,this.cleanText=l,this.parseTextWithCodeBlocksAndLatex=d,this.parseInlineMarkdown=p,this.applyCJKPunctuationRules=f,this.parseCodeLineBold=u}safeSetFont(t){let e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"normal";return T(this.pdf,t,e,this.availableFontWeights)}safeGetTextWidth(t){return g(this.pdf,t,this.chineseFontName)}safeRenderText(t,e,n){let s=arguments.length>3&&void 0!==arguments[3]?arguments[3]:null;return function(t,e,n,s){let i=arguments.length>4&&void 0!==arguments[4]?arguments[4]:null;if(!e||"string"!==typeof e)return;const r=l(e);if(r){if(i&&g(t,r)>i){console.warn("[PDF\u5bfc\u51fa] \u6587\u672c\u8fc7\u957f\uff0c\u5c06\u88ab\u622a\u65ad:",r.substring(0,50));try{const e=t.splitTextToSize(r,i);e.length>0&&t.text(e[0],n,s)}catch(o){let e=r;for(;g(t,e+"...")>i&&e.length>0;)e=e.substring(0,e.length-1);t.text(e+"...",n,s)}return}t.text(r,n,s)}}(this.pdf,t,e,n,s)}async exportToPDF(t,e){var n,a,h,c,l,d;let p=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};console.log("[PDF\u5bfc\u51fa] \u5f00\u59cb\u5bfc\u51fa",{messageCount:t.length,config:p}),this.meta=e,this.exportDate=r.Nq.formatDateTime(new Date),this.messageAnchors=[],this.config=(0,s.A)({includeThinking:null===(n=p.includeThinking)||void 0===n||n,includeArtifacts:null===(a=p.includeArtifacts)||void 0===a||a,includeTimestamps:null!==(h=p.includeTimestamps)&&void 0!==h&&h,includeTools:null===(c=p.includeTools)||void 0===c||c,includeCitations:null===(l=p.includeCitations)||void 0===l||l,highQuality:null!==(d=p.highQuality)&&void 0!==d&&d},p),this.pdf=new i.uE({orientation:"portrait",unit:"mm",format:"a4",compress:!0});try{console.log("[PDF\u5bfc\u51fa] \u5f00\u59cb\u52a0\u8f7d\u4e2d\u6587\u5b57\u4f53..."),console.log("[PDF\u5bfc\u51fa] \u8c03\u7528 addChineseFontSupport(this.pdf)...");const t=await async function(t){console.log("[PDF\u5b57\u4f53] \u5f00\u59cb\u52a0\u8f7d ARUDJingxihei \u5b57\u4f53\u5bb6\u65cf...");const e=[{path:"/lyra-exporter/fonts/ARUDJingxihei-Regular.ttf",name:"ARUDJingxihei",style:"normal",weight:400,description:"Regular (\u6b63\u5e38)"},{path:"/lyra-exporter/fonts/ARUDJingxihei-Bold.ttf",name:"ARUDJingxihei",style:"bold",weight:700,description:"Bold (\u7c97\u4f53)"},{path:"/lyra-exporter/fonts/ARUDJingxihei-Light.ttf",name:"ARUDJingxihei",style:"light",weight:300,description:"Light (\u7ec6\u4f53)"}];let n=0,s="helvetica";const i=[];for(const a of e)try{await o(t,a.path,a.name,a.style)&&(n++,s=a.name,i.push(a.style),console.log("[PDF\u5b57\u4f53] \u2713 \u52a0\u8f7d\u6210\u529f: ".concat(a.name,"-").concat(a.style," (").concat(a.description,")")))}catch(r){console.warn("[PDF\u5b57\u4f53] \u2717 \u8df3\u8fc7: ".concat(a.path," - ").concat(r.message))}if(0===n)return console.warn("[PDF\u5b57\u4f53] \u2717 \u672a\u80fd\u52a0\u8f7d\u4efb\u4f55 ARUDJingxihei \u5b57\u4f53"),console.warn("[PDF\u5b57\u4f53] \u5c06\u4f7f\u7528 helvetica \u9ed8\u8ba4\u5b57\u4f53 (\u4e2d\u6587\u53ef\u80fd\u663e\u793a\u4e3a\u65b9\u5757)"),t.setFont("helvetica"),{success:!1,fontName:"helvetica",availableWeights:[]};console.log("[PDF\u5b57\u4f53] \u2713 \u6210\u529f\u52a0\u8f7d ".concat(n," \u4e2a\u5b57\u4f53\u53d8\u4f53: ").concat(i.join(", ")));try{t.setFont(s,"normal")}catch(r){console.warn("[PDF\u5b57\u4f53] \u26a0 \u8bbe\u7f6e\u9ed8\u8ba4\u5b57\u4f53\u5931\u8d25\uff0c\u4f7f\u7528\u7b2c\u4e00\u4e2a\u53ef\u7528\u5b57\u91cd"),t.setFont(s,i[0]||"normal")}return{success:!0,fontName:s,availableWeights:i}}(this.pdf);if(console.log("[PDF\u5bfc\u51fa] addChineseFontSupport \u8fd4\u56de\u7ed3\u679c:",t),this.useChineseFont=t.success,this.chineseFontName=t.fontName,this.availableFontWeights=t.availableWeights||[],this.isSystemFont=t.isSystemFont||!1,this.useChineseFont){const e=this.isSystemFont?"\u7cfb\u7edf\u5b57\u4f53":"\u9879\u76ee\u5b57\u4f53";console.log("[PDF\u5bfc\u51fa] \u2705 \u4e2d\u6587\u5b57\u4f53\u52a0\u8f7d\u6210\u529f: ".concat(this.chineseFontName," (").concat(e,")")),console.log("[PDF\u5bfc\u51fa] \u53ef\u7528\u5b57\u4f53\u53d8\u4f53: ".concat(this.availableFontWeights.join(", "))),t.systemFontInfo&&console.log("[PDF\u5bfc\u51fa] \u7cfb\u7edf\u5b57\u4f53\u4fe1\u606f: ".concat(t.systemFontInfo.fontName))}else console.warn("[PDF\u5bfc\u51fa] \u26a0\ufe0f \u4e2d\u6587\u5b57\u4f53\u52a0\u8f7d\u5931\u8d25\uff0c\u5c06\u4f7f\u7528\u9ed8\u8ba4\u5b57\u4f53\uff08\u4e2d\u6587\u53ef\u80fd\u663e\u793a\u4e3a\u65b9\u6846\uff09"),console.warn("[PDF\u5bfc\u51fa] fontLoadResult\u8be6\u60c5:",JSON.stringify(t,null,2)),t.systemFontAvailable&&(console.warn("[PDF\u5bfc\u51fa] \u63d0\u793a\uff1a\u68c0\u6d4b\u5230\u7cfb\u7edf\u6709\u4e2d\u6587\u5b57\u4f53\uff0c\u4f46\u65e0\u6cd5\u5728\u6d4f\u89c8\u5668\u73af\u5883\u4e2d\u76f4\u63a5\u4f7f\u7528"),console.warn("[PDF\u5bfc\u51fa] \u5efa\u8bae\uff1a\u8bf7\u786e\u4fdd\u9879\u76ee public/fonts/ \u76ee\u5f55\u4e0b\u6709\u4e2d\u6587\u5b57\u4f53\u6587\u4ef6"))}catch(u){console.error("[PDF\u5bfc\u51fa] \u274c \u5b57\u4f53\u52a0\u8f7d\u5f02\u5e38:",u),console.error("[PDF\u5bfc\u51fa] \u9519\u8bef\u5806\u6808:",u.stack),this.useChineseFont=!1,this.chineseFontName="helvetica",this.availableFontWeights=[],this.isSystemFont=!1}this.pdf.setFont(this.chineseFontName),this.contentRenderer=new m(this),this.contentRenderer.renderTitle(e),this.contentRenderer.renderMetadata(e),this.currentY+=x.SECTION_SPACING;for(let s=0;s<t.length;s++){const e=t[s];s>0&&"human"===e.sender&&(this.pdf.addPage(),this.currentY=x.MARGIN_TOP),this.contentRenderer.renderMessage(e,s+1)}if(t.length>1){console.log("[PDF\u5bfc\u51fa] \u751f\u6210\u76ee\u5f55\uff08\u4f4d\u4e8e\u6587\u6863\u672b\u5c3e\uff09..."),this.pdf.addPage();const e=this.pdf.internal.getCurrentPageInfo().pageNumber;this.currentY=x.MARGIN_TOP,this.contentRenderer.renderTOCWithLinks(e,t)}console.log("[PDF\u5bfc\u51fa] \u6dfb\u52a0PDF\u4e66\u7b7e..."),this.addBookmarks(),console.log("[PDF\u5bfc\u51fa] \u6dfb\u52a0\u9875\u811a..."),this.addFooters();const f=this.generateFileName(e);return this.pdf.save(f),console.log("[PDF\u5bfc\u51fa] \u5bfc\u51fa\u5b8c\u6210:",f),!0}addBookmarks(){if(0!==this.messageAnchors.length)try{this.messageAnchors.forEach(t=>{const e="human"===t.sender?"Human":"Assistant",n="".concat(t.index,". ").concat(e);this.pdf.outline&&this.pdf.outline.add(null,n,{pageNumber:t.page})})}catch(t){console.warn("[PDF\u5bfc\u51fa] \u4e66\u7b7e\u6dfb\u52a0\u5931\u8d25\uff08\u53ef\u80fd\u4e0d\u652f\u6301\uff09:",t)}}addFooters(){const t=this.pdf.internal.getNumberOfPages();for(let e=1;e<=t;e++)this.pdf.setPage(e),this.contentRenderer.renderFooter(e,t)}checkPageBreak(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:20;const e=x.PAGE_HEIGHT-x.MARGIN_BOTTOM;this.currentY+t>e&&(this.pdf.addPage(),this.currentY=x.MARGIN_TOP)}groupCodeLinesByPage(t){const e=[];let n=null;const s=x.PAGE_HEIGHT-x.MARGIN_BOTTOM;let i=this.currentY,r=this.pdf.internal.getCurrentPageInfo().pageNumber;return t.forEach(t=>{i+x.FONT_SIZE_CODE>s&&(r++,i=x.MARGIN_TOP,n=null),n&&n.page===r||(n={page:r,startY:i,lines:[]},e.push(n)),n.lines.push(t),i+=x.LINE_HEIGHT}),e}generateFileName(t){const e=r.Nq.getCurrentDate(),n=(t.name||"conversation").replace(/[^a-zA-Z0-9\u4e00-\u9fa5]/g,"_");return"".concat(n,"_").concat(e,".pdf")}getPlatformPrefix(t){const e=(t||"").toLowerCase();return e.includes("chatgpt")?"chatgpt":e.includes("gemini")?"gemini":e.includes("notebooklm")?"notebooklm":e.includes("aistudio")?"aistudio":e.includes("sillytavern")?"sillytavern":"claude"}}new N}}]);
//# sourceMappingURL=654.23abb5fa.chunk.js.map