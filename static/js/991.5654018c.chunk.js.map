{"version":3,"file":"static/js/991.5654018c.chunk.js","mappings":"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","sources":["utils/export/pdfFontHelper.js","utils/export/pdfExportManager.js"],"sourcesContent":["// utils/export/pdfFontHelper.js\n// PDF中文字体支持 - 预加载字体方案\n//\n// 当前实现：\n// - 首次进入网站时后台预加载字体\n// - 使用 IndexedDB 缓存字体数据\n// - 导出 PDF 时检查字体是否就绪\n// - 支持多字重变体，可正确渲染粗体标题和强调文本\n\n/**\n * 字体缓存管理器\n * 使用 IndexedDB 存储字体数据\n */\nconst FontCache = {\n  DB_NAME: 'LyraFontCache',\n  STORE_NAME: 'fonts',\n  DB_VERSION: 1,\n\n  // 字体加载状态\n  status: {\n    isLoading: false,\n    isLoaded: false,\n    error: null,\n    progress: 0,\n  },\n\n  // 缓存的字体数据\n  cachedFont: null,\n\n  /**\n   * 打开数据库\n   */\n  async openDB() {\n    return new Promise((resolve, reject) => {\n      const request = indexedDB.open(this.DB_NAME, this.DB_VERSION);\n\n      request.onerror = () => reject(request.error);\n      request.onsuccess = () => resolve(request.result);\n\n      request.onupgradeneeded = (event) => {\n        const db = event.target.result;\n        if (!db.objectStoreNames.contains(this.STORE_NAME)) {\n          db.createObjectStore(this.STORE_NAME, { keyPath: 'id' });\n        }\n      };\n    });\n  },\n\n  /**\n   * 从缓存获取字体\n   */\n  async getFromCache(fontId) {\n    try {\n      const db = await this.openDB();\n      return new Promise((resolve, reject) => {\n        const transaction = db.transaction(this.STORE_NAME, 'readonly');\n        const store = transaction.objectStore(this.STORE_NAME);\n        const request = store.get(fontId);\n\n        request.onerror = () => reject(request.error);\n        request.onsuccess = () => resolve(request.result);\n      });\n    } catch (error) {\n      console.warn('[字体缓存] 读取缓存失败:', error);\n      return null;\n    }\n  },\n\n  /**\n   * 保存字体到缓存\n   */\n  async saveToCache(fontId, fontData) {\n    try {\n      const db = await this.openDB();\n      return new Promise((resolve, reject) => {\n        const transaction = db.transaction(this.STORE_NAME, 'readwrite');\n        const store = transaction.objectStore(this.STORE_NAME);\n        const request = store.put({\n          id: fontId,\n          data: fontData,\n          timestamp: Date.now()\n        });\n\n        request.onerror = () => reject(request.error);\n        request.onsuccess = () => resolve(true);\n      });\n    } catch (error) {\n      console.warn('[字体缓存] 保存缓存失败:', error);\n      return false;\n    }\n  },\n\n  /**\n   * 检查字体是否已缓存\n   */\n  async isCached(fontId) {\n    const cached = await this.getFromCache(fontId);\n    return cached !== null && cached !== undefined;\n  }\n};\n\n/**\n * CDN 字体配置 - 使用国际 CDN\n */\nconst CDN_FONT_CONFIG = {\n  id: 'NotoSansSC',\n  name: 'NotoSansSC',\n  style: 'normal',\n  // 使用国际 CDN 源\n  urls: [\n    // Google Fonts CDN (最可靠)\n    'https://fonts.gstatic.com/s/notosanssc/v37/k3kCo84MPvpLmixcA63oeAL7Iqp5IZJF9bmaG9_FnYxNbPzS5HE.ttf',\n    // jsDelivr (GitHub CDN)\n    'https://cdn.jsdelivr.net/gh/AkiTobep/Noto-Sans-SC@main/fonts/NotoSansSC-Regular.otf',\n    // Cloudflare CDNJS\n    'https://cdnjs.cloudflare.com/ajax/libs/source-han-sans-cn/1.004/SourceHanSansCN-Regular.otf',\n  ]\n};\n\n/**\n * 预加载字体（在网站首次加载时调用）\n * @returns {Promise<boolean>} - 是否成功\n */\nexport async function preloadFont() {\n  // 如果已经在加载或已加载完成，直接返回\n  if (FontCache.status.isLoading) {\n    console.log('[字体预加载] 正在加载中...');\n    return false;\n  }\n\n  if (FontCache.status.isLoaded && FontCache.cachedFont) {\n    console.log('[字体预加载] 字体已就绪');\n    return true;\n  }\n\n  // 检查 IndexedDB 缓存\n  try {\n    const cached = await FontCache.getFromCache(CDN_FONT_CONFIG.id);\n    if (cached && cached.data) {\n      console.log('[字体预加载] 从缓存加载字体');\n      FontCache.cachedFont = cached.data;\n      FontCache.status.isLoaded = true;\n      FontCache.status.progress = 100;\n      return true;\n    }\n  } catch (error) {\n    console.warn('[字体预加载] 缓存检查失败:', error);\n  }\n\n  // 开始从 CDN 下载\n  FontCache.status.isLoading = true;\n  FontCache.status.progress = 0;\n  console.log('[字体预加载] 开始从 CDN 下载字体...');\n\n  for (const url of CDN_FONT_CONFIG.urls) {\n    try {\n      console.log(`[字体预加载] 尝试: ${url}`);\n\n      const response = await fetch(url, {\n        mode: 'cors',\n        cache: 'force-cache'\n      });\n\n      if (!response.ok) {\n        console.warn(`[字体预加载] 请求失败: ${response.status}`);\n        continue;\n      }\n\n      // 获取文件大小用于进度显示\n      const contentLength = response.headers.get('content-length');\n      const total = contentLength ? parseInt(contentLength, 10) : 0;\n\n      // 读取数据并跟踪进度\n      const reader = response.body.getReader();\n      const chunks = [];\n      let received = 0;\n\n      while (true) {\n        const { done, value } = await reader.read();\n        if (done) break;\n\n        chunks.push(value);\n        received += value.length;\n\n        if (total > 0) {\n          FontCache.status.progress = Math.round((received / total) * 100);\n        }\n      }\n\n      // 合并数据\n      const arrayBuffer = new Uint8Array(received);\n      let position = 0;\n      for (const chunk of chunks) {\n        arrayBuffer.set(chunk, position);\n        position += chunk.length;\n      }\n\n      // 验证字体格式\n      const dataView = new DataView(arrayBuffer.buffer);\n      const magic = dataView.getUint32(0, false);\n      const isTTF = magic === 0x00010000 || magic === 0x74727565;\n      const isOTF = magic === 0x4F54544F;\n\n      if (!isTTF && !isOTF) {\n        console.warn(`[字体预加载] 文件格式不正确`);\n        continue;\n      }\n\n      // 转换为 base64 并缓存\n      let binary = '';\n      const chunkSize = 8192;\n      for (let i = 0; i < arrayBuffer.length; i += chunkSize) {\n        const chunk = arrayBuffer.subarray(i, Math.min(i + chunkSize, arrayBuffer.length));\n        binary += String.fromCharCode.apply(null, chunk);\n      }\n      const base64 = btoa(binary);\n\n      // 保存到缓存\n      FontCache.cachedFont = base64;\n      FontCache.status.isLoaded = true;\n      FontCache.status.isLoading = false;\n      FontCache.status.progress = 100;\n\n      await FontCache.saveToCache(CDN_FONT_CONFIG.id, base64);\n\n      const sizeMB = (arrayBuffer.length / 1024 / 1024).toFixed(2);\n      console.log(`[字体预加载] ✓ 字体下载成功: ${sizeMB} MB`);\n      return true;\n\n    } catch (error) {\n      console.warn(`[字体预加载] 下载失败: ${error.message}`);\n      continue;\n    }\n  }\n\n  // 所有 CDN 都失败\n  FontCache.status.isLoading = false;\n  FontCache.status.error = '所有 CDN 源都无法访问';\n  console.error('[字体预加载] ✗ 字体下载失败');\n  return false;\n}\n\n/**\n * 获取字体加载状态\n * @returns {Object} - 状态信息\n */\nexport function getFontStatus() {\n  return {\n    isLoading: FontCache.status.isLoading,\n    isLoaded: FontCache.status.isLoaded,\n    progress: FontCache.status.progress,\n    error: FontCache.status.error,\n    fontName: CDN_FONT_CONFIG.name\n  };\n}\n\n/**\n * 检查字体是否可用于导出\n * @returns {boolean}\n */\nexport function isFontReady() {\n  return FontCache.status.isLoaded && FontCache.cachedFont !== null;\n}\n\n/**\n * 系统字体配置 - 按优先级排序\n * 针对不同操作系统的常见中文字体\n */\nconst SYSTEM_FONTS = {\n  // Windows 系统字体\n  windows: [\n    { name: 'Microsoft YaHei', family: 'Microsoft YaHei, 微软雅黑' },\n    { name: 'SimHei', family: 'SimHei, 黑体' },\n    { name: 'SimSun', family: 'SimSun, 宋体' },\n    { name: 'KaiTi', family: 'KaiTi, 楷体' },\n  ],\n  // macOS 系统字体\n  macos: [\n    { name: 'PingFang SC', family: 'PingFang SC, 苹方-简' },\n    { name: 'Hiragino Sans GB', family: 'Hiragino Sans GB, 冬青黑体简体中文' },\n    { name: 'Heiti SC', family: 'Heiti SC, 黑体-简' },\n    { name: 'STHeiti', family: 'STHeiti, 华文黑体' },\n  ],\n  // iOS 系统字体\n  ios: [\n    { name: 'PingFang SC', family: 'PingFang SC' },\n    { name: 'Heiti SC', family: 'Heiti SC' },\n  ],\n  // Android 系统字体\n  android: [\n    { name: 'Noto Sans CJK SC', family: 'Noto Sans CJK SC' },\n    { name: 'Droid Sans Fallback', family: 'Droid Sans Fallback' },\n    { name: 'Source Han Sans CN', family: 'Source Han Sans CN, 思源黑体' },\n  ],\n  // 通用备选字体\n  fallback: [\n    { name: 'Noto Sans SC', family: 'Noto Sans SC' },\n    { name: 'Source Han Sans CN', family: 'Source Han Sans CN' },\n    { name: 'WenQuanYi Micro Hei', family: 'WenQuanYi Micro Hei, 文泉驿微米黑' },\n  ]\n};\n\n/**\n * 检测当前操作系统\n * @returns {string} - 'windows' | 'macos' | 'ios' | 'android' | 'linux' | 'unknown'\n */\nfunction detectOS() {\n  const userAgent = navigator.userAgent.toLowerCase();\n  const platform = navigator.platform?.toLowerCase() || '';\n\n  if (/iphone|ipad|ipod/.test(userAgent)) {\n    return 'ios';\n  }\n  if (/android/.test(userAgent)) {\n    return 'android';\n  }\n  if (/mac/.test(platform) || /macintosh/.test(userAgent)) {\n    return 'macos';\n  }\n  if (/win/.test(platform) || /windows/.test(userAgent)) {\n    return 'windows';\n  }\n  if (/linux/.test(platform)) {\n    return 'linux';\n  }\n\n  return 'unknown';\n}\n\n/**\n * 检测字体是否可用\n * 使用 Canvas 方法检测字体是否在系统中存在\n * @param {string} fontFamily - 要检测的字体家族\n * @returns {boolean} - 字体是否可用\n */\nfunction isFontAvailable(fontFamily) {\n  try {\n    // 创建测试 canvas\n    const canvas = document.createElement('canvas');\n    const context = canvas.getContext('2d');\n\n    // 测试字符 - 使用中文字符进行测试\n    const testString = '测试字体ABCabc123';\n    const fontSize = 72;\n\n    // 先用默认字体测量\n    context.font = `${fontSize}px monospace`;\n    const defaultWidth = context.measureText(testString).width;\n\n    // 再用目标字体测量\n    context.font = `${fontSize}px ${fontFamily}, monospace`;\n    const targetWidth = context.measureText(testString).width;\n\n    // 如果宽度不同，说明字体存在\n    return defaultWidth !== targetWidth;\n  } catch (error) {\n    console.warn(`[PDF字体] 字体检测失败: ${fontFamily}`, error);\n    return false;\n  }\n}\n\n/**\n * 获取可用的系统字体\n * @returns {{fontFamily: string, fontName: string} | null} - 可用的系统字体信息\n */\nfunction getAvailableSystemFont() {\n  const os = detectOS();\n  console.log(`[PDF字体] 检测到操作系统: ${os}`);\n\n  // 根据操作系统选择字体检测顺序\n  let fontsToCheck = [];\n\n  switch (os) {\n    case 'windows':\n      fontsToCheck = [...SYSTEM_FONTS.windows, ...SYSTEM_FONTS.fallback];\n      break;\n    case 'macos':\n      fontsToCheck = [...SYSTEM_FONTS.macos, ...SYSTEM_FONTS.fallback];\n      break;\n    case 'ios':\n      fontsToCheck = [...SYSTEM_FONTS.ios, ...SYSTEM_FONTS.macos, ...SYSTEM_FONTS.fallback];\n      break;\n    case 'android':\n      fontsToCheck = [...SYSTEM_FONTS.android, ...SYSTEM_FONTS.fallback];\n      break;\n    default:\n      // 对于未知系统，检测所有字体\n      fontsToCheck = [\n        ...SYSTEM_FONTS.windows,\n        ...SYSTEM_FONTS.macos,\n        ...SYSTEM_FONTS.android,\n        ...SYSTEM_FONTS.fallback\n      ];\n  }\n\n  // 检测每个字体是否可用\n  for (const font of fontsToCheck) {\n    if (isFontAvailable(font.family)) {\n      console.log(`[PDF字体] ✓ 发现可用系统字体: ${font.name}`);\n      return { fontFamily: font.family, fontName: font.name };\n    }\n  }\n\n  console.warn('[PDF字体] ✗ 未检测到可用的系统中文字体');\n  return null;\n}\n\n/**\n * 系统字体路径映射\n * 定义各操作系统中字体文件的路径\n */\nconst SYSTEM_FONT_PATHS = {\n  // Windows 字体路径\n  'Microsoft YaHei': {\n    windows: [\n      'C:/Windows/Fonts/msyh.ttc',\n      'C:/Windows/Fonts/msyh.ttf',\n      'C:/Windows/Fonts/msyhbd.ttc',\n      'C:/Windows/Fonts/msyhbd.ttf',\n    ]\n  },\n  'SimHei': {\n    windows: [\n      'C:/Windows/Fonts/simhei.ttf',\n    ]\n  },\n  'SimSun': {\n    windows: [\n      'C:/Windows/Fonts/simsun.ttc',\n    ]\n  },\n  // macOS 字体路径\n  'PingFang SC': {\n    macos: [\n      '/System/Library/Fonts/PingFang.ttc',\n      '/Library/Fonts/PingFang.ttc',\n    ]\n  },\n  'Hiragino Sans GB': {\n    macos: [\n      '/System/Library/Fonts/Hiragino Sans GB.ttc',\n      '/Library/Fonts/Hiragino Sans GB.ttc',\n    ]\n  },\n  // Android/Linux 字体路径\n  'Noto Sans CJK SC': {\n    android: [\n      '/system/fonts/NotoSansCJK-Regular.ttc',\n      '/system/fonts/NotoSansSC-Regular.otf',\n    ],\n    linux: [\n      '/usr/share/fonts/opentype/noto/NotoSansCJK-Regular.ttc',\n      '/usr/share/fonts/noto-cjk/NotoSansCJK-Regular.ttc',\n    ]\n  },\n  'Droid Sans Fallback': {\n    android: [\n      '/system/fonts/DroidSansFallback.ttf',\n    ]\n  }\n};\n\n/**\n * 尝试从系统路径加载字体\n * 注意：由于浏览器安全限制，这通常不会成功\n * 但在 Electron 或其他桌面环境中可能有效\n *\n * @param {jsPDF} pdf - jsPDF 实例\n * @param {string} fontName - 字体名称\n * @returns {Promise<{fontName: string, availableWeights: string[]} | null>}\n */\nasync function loadSystemFont(pdf, fontName) {\n  // 获取当前操作系统\n  const os = detectOS();\n\n  // 获取该字体在当前操作系统的路径\n  const fontConfig = SYSTEM_FONT_PATHS[fontName];\n  if (!fontConfig) {\n    console.log(`[PDF字体] 没有 ${fontName} 的系统路径配置`);\n    return null;\n  }\n\n  const paths = fontConfig[os] || [];\n  if (paths.length === 0) {\n    console.log(`[PDF字体] ${os} 系统没有 ${fontName} 的路径配置`);\n    return null;\n  }\n\n  // 尝试从本地路径加载字体\n  // 注意：这在浏览器环境中通常会失败，因为无法访问本地文件系统\n  // 这个功能主要用于 Electron 应用或其他有文件系统访问权限的环境\n\n  for (const fontPath of paths) {\n    try {\n      console.log(`[PDF字体] 尝试加载系统字体: ${fontPath}`);\n\n      // 在浏览器中无法直接访问本地文件\n      // 但如果是通过 Electron 或类似环境，可以使用 file:// 协议\n      const response = await fetch(`file://${fontPath}`).catch(() => null);\n\n      if (!response || !response.ok) {\n        continue;\n      }\n\n      const arrayBuffer = await response.arrayBuffer();\n\n      // 验证字体文件\n      const dataView = new DataView(arrayBuffer);\n      const magic = dataView.getUint32(0, false);\n\n      // 检查 TTC 或 TTF 文件头\n      const isTTC = magic === 0x74746366; // 'ttcf'\n      const isTTF = magic === 0x00010000 || magic === 0x74727565;\n      const isOTF = magic === 0x4F54544F; // 'OTTO'\n\n      if (!isTTC && !isTTF && !isOTF) {\n        console.warn(`[PDF字体] 文件格式不正确: ${fontPath}`);\n        continue;\n      }\n\n      // 转换为 base64\n      const bytes = new Uint8Array(arrayBuffer);\n      let binary = '';\n      const chunkSize = 8192;\n      for (let i = 0; i < bytes.byteLength; i += chunkSize) {\n        const chunk = bytes.subarray(i, Math.min(i + chunkSize, bytes.byteLength));\n        binary += String.fromCharCode.apply(null, chunk);\n      }\n      const base64 = btoa(binary);\n\n      // 添加到 jsPDF\n      const fileName = fontPath.split('/').pop();\n      pdf.addFileToVFS(fileName, base64);\n      pdf.addFont(fileName, fontName, 'normal');\n      pdf.setFont(fontName, 'normal');\n\n      console.log(`[PDF字体] ✓ 系统字体加载成功: ${fontPath}`);\n\n      return {\n        fontName,\n        availableWeights: ['normal']\n      };\n    } catch (error) {\n      // 预期会失败，因为浏览器通常无法访问本地文件\n      continue;\n    }\n  }\n\n  console.log(`[PDF字体] 无法从系统路径加载字体 ${fontName}`);\n  console.log(`[PDF字体] 这是预期的行为，浏览器无法直接访问本地文件系统`);\n\n  return null;\n}\n\n/**\n * 从 URL 加载字体文件\n * 用于从 CDN 加载开源中文字体\n *\n * @param {jsPDF} pdf - jsPDF 实例\n * @param {string} url - 字体文件 URL\n * @param {string} fontName - 字体名称\n * @param {string} fontStyle - 字体样式\n * @returns {Promise<boolean>} - 是否成功\n */\nasync function loadFontFromURL(pdf, url, fontName, fontStyle = 'normal') {\n  try {\n    // 设置超时时间（15秒，因为字体文件可能较大）\n    const controller = new AbortController();\n    const timeoutId = setTimeout(() => controller.abort(), 15000);\n\n    const response = await fetch(url, {\n      signal: controller.signal,\n      mode: 'cors'\n    });\n    clearTimeout(timeoutId);\n\n    if (!response.ok) {\n      console.warn(`[PDF字体] CDN 请求失败: ${response.status}`);\n      return false;\n    }\n\n    const arrayBuffer = await response.arrayBuffer();\n    const fileSizeKB = (arrayBuffer.byteLength / 1024).toFixed(2);\n    const fileSizeMB = (arrayBuffer.byteLength / 1024 / 1024).toFixed(2);\n\n    console.log(`[PDF字体] 字体文件大小: ${fileSizeMB} MB (${fileSizeKB} KB)`);\n\n    // 验证文件格式\n    const dataView = new DataView(arrayBuffer);\n    const magic = dataView.getUint32(0, false);\n\n    const isTTC = magic === 0x74746366; // 'ttcf'\n    const isTTF = magic === 0x00010000 || magic === 0x74727565;\n    const isOTF = magic === 0x4F54544F; // 'OTTO'\n\n    if (!isTTC && !isTTF && !isOTF) {\n      console.warn(`[PDF字体] 文件格式不正确，魔数: 0x${magic.toString(16)}`);\n      return false;\n    }\n\n    // 检查文件大小（中文字体应该至少 500KB）\n    if (arrayBuffer.byteLength < 100 * 1024) {\n      console.warn(`[PDF字体] 字体文件过小 (${fileSizeKB} KB)，可能不完整`);\n      return false;\n    }\n\n    // 转换为 base64\n    const bytes = new Uint8Array(arrayBuffer);\n    let binary = '';\n    const chunkSize = 8192;\n    for (let i = 0; i < bytes.byteLength; i += chunkSize) {\n      const chunk = bytes.subarray(i, Math.min(i + chunkSize, bytes.byteLength));\n      binary += String.fromCharCode.apply(null, chunk);\n    }\n    const base64 = btoa(binary);\n\n    // 添加到 jsPDF\n    const fileName = url.split('/').pop().split('?')[0];\n    pdf.addFileToVFS(fileName, base64);\n    pdf.addFont(fileName, fontName, fontStyle);\n\n    console.log(`[PDF字体] ✓ 字体加载成功: ${fontName}-${fontStyle}`);\n    return true;\n  } catch (error) {\n    if (error.name === 'AbortError') {\n      console.warn(`[PDF字体] CDN 加载超时: ${url}`);\n    } else {\n      console.warn(`[PDF字体] CDN 加载失败: ${error.message}`);\n    }\n    return false;\n  }\n}\n\n/**\n * 验证字体是否包含必要的 Unicode cmap\n * @param {ArrayBuffer} arrayBuffer - 字体文件内容\n * @returns {boolean} - 是否包含 cmap\n */\nfunction hasUnicodeCmap(arrayBuffer) {\n  try {\n    const dataView = new DataView(arrayBuffer);\n    \n    // TTF 文件以特定的魔数开头\n    const version = dataView.getUint32(0, false);\n    // 0x00010000 或 'true' 或 'typ1' 或 'OTTO'\n    if (version !== 0x00010000 && version !== 0x74727565) {\n      console.warn('[PDF字体] 可能不是标准TTF格式');\n    }\n    \n    // 简单检查: 查找 'cmap' 表\n    const buffer = new Uint8Array(arrayBuffer);\n    const cmapSignature = [0x63, 0x6d, 0x61, 0x70]; // 'cmap'\n    \n    for (let i = 0; i < Math.min(buffer.length - 4, 1000); i++) {\n      if (buffer[i] === cmapSignature[0] &&\n          buffer[i+1] === cmapSignature[1] &&\n          buffer[i+2] === cmapSignature[2] &&\n          buffer[i+3] === cmapSignature[3]) {\n        console.log('[PDF字体] 找到 cmap 表');\n        return true;\n      }\n    }\n    \n    console.warn('[PDF字体] 未找到 cmap 表特征');\n    return false;\n  } catch (error) {\n    console.error('[PDF字体] cmap 检查失败:', error);\n    return false;\n  }\n}\n\n/**\n * 从项目资源加载字体文件并添加到PDF\n * @param {jsPDF} pdf - jsPDF实例\n * @param {string} fontPath - 字体文件路径 (相对于public目录)\n * @param {string} fontName - 字体名称\n * @param {string} fontStyle - 字体样式 (normal, bold, light 等)\n * @returns {Promise<boolean>} - 是否成功加载字体\n */\nasync function loadFontFromProject(pdf, fontPath, fontName = 'CustomFont', fontStyle = 'normal') {\n  try {\n    console.log(`[PDF字体] 正在加载字体: ${fontPath}`);\n    \n    // 设置超时时间（5秒）\n    const controller = new AbortController();\n    const timeoutId = setTimeout(() => controller.abort(), 5000);\n    \n    try {\n      // 从 public 目录加载字体文件\n      // 添加时间戳参数破坏缓存\n      const cacheBuster = `?v=${Date.now()}`;\n      const response = await fetch(fontPath + cacheBuster, { \n        signal: controller.signal,\n        cache: 'no-store', // 禁用缓存\n        headers: {\n          'Cache-Control': 'no-cache'\n        }\n      });\n      clearTimeout(timeoutId);\n      \n      if (!response.ok) {\n        throw new Error(`加载字体失败: ${response.status}`);\n      }\n\n      // 检查 Content-Type，确保是字体文件而不是HTML错误页面\n      const contentType = response.headers.get('content-type');\n      console.log(`[PDF字体] Content-Type: ${contentType}`);\n\n      if (contentType && contentType.includes('text/html')) {\n        console.error(`[PDF字体] 返回了HTML页面而不是字体文件！`);\n        return false;\n      }\n\n      const arrayBuffer = await response.arrayBuffer();\n      const fileSizeKB = (arrayBuffer.byteLength / 1024).toFixed(2);\n      const fileSizeMB = (arrayBuffer.byteLength / 1024 / 1024).toFixed(2);\n\n      console.log(`[PDF字体] 字体文件大小: ${fileSizeMB} MB (${fileSizeKB} KB)`);\n\n      // 验证TTF魔数（文件头）\n      const dataView = new DataView(arrayBuffer);\n      const magic = dataView.getUint32(0, false);\n      // TTF文件应该以 0x00010000 或 0x74727565 ('true') 开头\n      if (magic !== 0x00010000 && magic !== 0x74727565) {\n        console.error(`[PDF字体] 文件不是有效的TTF字体！魔数: 0x${magic.toString(16)}`);\n        console.error(`[PDF字体] 这可能是一个HTML错误页面或其他非字体文件`);\n        return false;\n      }\n\n      // 检查文件是否太小\n      if (arrayBuffer.byteLength < 500 * 1024) {\n        console.error(`[PDF字体] 字体文件异常小 (仅 ${fileSizeKB} KB)！`);\n        console.error(`[PDF字体] 正常的中文字体应该至少 3MB`);\n        return false;\n      }\n      \n      // 验证字体是否包含 cmap 表\n      const hasCmap = hasUnicodeCmap(arrayBuffer);\n      if (!hasCmap) {\n        console.warn(`[PDF字体] 警告: 字体可能缺少 Unicode cmap 表`);\n        console.warn(`[PDF字体] 建议更换为 Noto Sans SC 或 Source Han Sans CN`);\n      }\n      \n      const bytes = new Uint8Array(arrayBuffer);\n      \n      // 转换为base64\n      let binary = '';\n      const len = bytes.byteLength;\n      // 批量处理以提高性能\n      const chunkSize = 8192;\n      for (let i = 0; i < len; i += chunkSize) {\n        const chunk = bytes.subarray(i, Math.min(i + chunkSize, len));\n        binary += String.fromCharCode.apply(null, chunk);\n      }\n      const base64 = btoa(binary);\n      \n      // 添加字体到jsPDF\n      const fileName = fontPath.split('/').pop();\n      \n      try {\n        pdf.addFileToVFS(fileName, base64);\n        // 添加字体时指定样式\n        pdf.addFont(fileName, fontName, fontStyle);\n\n        console.log(`[PDF字体] 字体加载成功: ${fontName}-${fontStyle}`);\n        return true;\n      } catch (addFontError) {\n        console.error(`[PDF字体] addFont 失败:`, addFontError.message);\n        console.error(`[PDF字体] 这通常意味着字体不兼容 jsPDF`);\n        console.error(`[PDF字体] 错误详情:`, addFontError);\n        return false;\n      }\n    } catch (fetchError) {\n      clearTimeout(timeoutId);\n      if (fetchError.name === 'AbortError') {\n        console.warn(`[PDF字体] 字体加载超时: ${fontPath}`);\n      } else {\n        console.warn(`[PDF字体] 获取字体文件失败: ${fetchError.message}`);\n      }\n      return false;\n    }\n  } catch (error) {\n    console.error('[PDF字体] 字体加载失败:', error);\n    return false;\n  }\n}\n\n/**\n * 为PDF添加中文字体支持\n * 优先使用系统字体，如果不可用则尝试加载项目字体\n *\n * 字体优先级：\n * 1. 系统字体（Windows: 微软雅黑, macOS: 苹方, Android: Noto Sans CJK）\n * 2. 项目自带字体（ARUDJingxihei）\n * 3. 默认字体（helvetica）\n *\n * @param {jsPDF} pdf - jsPDF实例\n * @returns {Promise<{success: boolean, fontName: string, availableWeights: string[], isSystemFont: boolean}>} - 加载结果和字体名称\n */\nexport async function addChineseFontSupport(pdf) {\n  console.log('[PDF字体] 开始检测可用字体...');\n\n  // 第一步：尝试使用系统字体\n  const systemFont = getAvailableSystemFont();\n\n  if (systemFont) {\n    console.log(`[PDF字体] ✓ 检测到系统字体: ${systemFont.fontName}`);\n    console.log(`[PDF字体] 字体家族: ${systemFont.fontFamily}`);\n\n    // 尝试加载对应的系统字体文件\n    const systemFontLoaded = await loadSystemFont(pdf, systemFont.fontName);\n\n    if (systemFontLoaded) {\n      console.log(`[PDF字体] ✓ 系统字体加载成功: ${systemFontLoaded.fontName}`);\n      return {\n        success: true,\n        fontName: systemFontLoaded.fontName,\n        availableWeights: systemFontLoaded.availableWeights,\n        isSystemFont: true,\n        systemFontInfo: systemFont\n      };\n    }\n\n    console.log(`[PDF字体] ⚠ 无法加载系统字体文件，将回退到项目字体`);\n  }\n\n  // 第二步：使用预加载的缓存字体\n  if (FontCache.cachedFont) {\n    console.log('[PDF字体] 使用预加载的缓存字体...');\n\n    try {\n      const fontName = CDN_FONT_CONFIG.name;\n      const fileName = `${fontName}.ttf`;\n\n      // 添加字体到 jsPDF\n      pdf.addFileToVFS(fileName, FontCache.cachedFont);\n      pdf.addFont(fileName, fontName, 'normal');\n      pdf.setFont(fontName, 'normal');\n\n      console.log(`[PDF字体] ✓ 缓存字体加载成功: ${fontName}`);\n\n      return {\n        success: true,\n        fontName: fontName,\n        availableWeights: ['normal'],\n        isSystemFont: false,\n        isCDNFont: true\n      };\n    } catch (error) {\n      console.error('[PDF字体] 缓存字体加载失败:', error);\n    }\n  }\n\n  // 第三步：字体未就绪，返回失败\n  console.error('[PDF字体] ✗ 字体未就绪');\n  console.error('[PDF字体] 请等待字体下载完成后再导出 PDF');\n\n  return {\n    success: false,\n    fontName: 'helvetica',\n    availableWeights: ['normal', 'bold', 'italic'],\n    isSystemFont: false,\n    fontNotReady: true\n  };\n}\n\n/**\n * 获取操作系统信息和推荐字体\n * 可用于在 UI 中显示字体状态\n * @returns {Object} - 操作系统和字体信息\n */\nexport function getFontInfo() {\n  const os = detectOS();\n  const systemFont = getAvailableSystemFont();\n\n  return {\n    os,\n    systemFont: systemFont ? systemFont.fontName : null,\n    recommendation: systemFont\n      ? `检测到系统字体: ${systemFont.fontName}`\n      : '未检测到中文字体，建议安装中文字体包'\n  };\n}\n","// utils/export/pdfExportManager.js\n// PDF导出管理器 - 基于jsPDF实现纯文本PDF导出\n//\n// 使用 ARUDJingxihei 字体家族支持中文显示（Regular、Bold、Light 三种字重）\n// 支持 Markdown 渲染（标题、粗体、斜体、列表、引用等）和 LaTeX 公式显示\nimport { jsPDF } from 'jspdf';\nimport { DateTimeUtils } from '../fileParser';\nimport { addChineseFontSupport, isFontReady, getFontStatus } from './pdfFontHelper';\n\n/**\n * PDF样式配置\n */\nconst PDF_STYLES = {\n  // 字体大小\n  FONT_SIZE_TITLE: 20,\n  FONT_SIZE_H1: 16,\n  FONT_SIZE_H2: 14,\n  FONT_SIZE_SENDER: 12,\n  FONT_SIZE_BODY: 10,\n  FONT_SIZE_CODE: 9,\n  FONT_SIZE_TIMESTAMP: 8,\n  FONT_SIZE_HEADER: 8,\n  FONT_SIZE_FOOTER: 8,\n\n  // 颜色 (RGB)\n  COLOR_SENDER_HUMAN: [0, 102, 204],      // 蓝色\n  COLOR_SENDER_ASSISTANT: [102, 102, 102], // 灰色\n  COLOR_TIMESTAMP: [150, 150, 150],        // 浅灰\n  COLOR_CODE_BG: [245, 245, 245],          // 代码背景\n  COLOR_SECTION_BG: [250, 250, 250],       // 区块背景\n  COLOR_TEXT: [0, 0, 0],                   // 黑色文本\n  COLOR_HEADER: [100, 100, 100],           // 页眉颜色\n  COLOR_FOOTER: [150, 150, 150],           // 页脚颜色\n  COLOR_BORDER: [200, 200, 200],           // 边框颜色\n\n  // 间距\n  MARGIN_LEFT: 15,\n  MARGIN_RIGHT: 15,\n  MARGIN_TOP: 15,    // 顶部边距（移除页眉，增加空间利用率）\n  MARGIN_BOTTOM: 25, // 底部边距为页脚留空间\n  LINE_HEIGHT: 5,\n  SECTION_SPACING: 8,\n  MESSAGE_SPACING: 10,\n  FOOTER_HEIGHT: 15, // 页脚高度\n\n  // 页面\n  PAGE_WIDTH: 210, // A4 宽度(mm)\n  PAGE_HEIGHT: 297, // A4 高度(mm)\n};\n\n/**\n * PDF导出管理器类\n */\nexport class PDFExportManager {\n  constructor() {\n    this.pdf = null;\n    this.currentY = PDF_STYLES.MARGIN_TOP;\n    this.config = {};\n    this.useChineseFont = false; // 是否成功加载了中文字体\n    this.chineseFontName = 'helvetica'; // 当前使用的字体名称\n    this.availableFontWeights = []; // 可用的字体变体 (normal, bold, light 等)\n    this.isSystemFont = false; // 是否使用系统字体\n    this.meta = null; // 保存元数据用于页脚\n    this.exportDate = null; // 导出时间\n    this.messageAnchors = []; // 保存每条消息的位置信息用于目录链接和书签\n  }\n\n  /**\n   * 安全地设置字体，如果字体变体不可用则自动回退\n   * @param {string} fontName - 字体名称\n   * @param {string} fontStyle - 字体样式 (normal, bold, light, italic, bolditalic)\n   * @returns {boolean} - 是否成功设置\n   */\n  safeSetFont(fontName, fontStyle = 'normal') {\n    try {\n      // 如果请求的样式可用，直接使用\n      if (this.availableFontWeights.includes(fontStyle)) {\n        this.pdf.setFont(fontName, fontStyle);\n        return true;\n      }\n\n      // 字体变体不可用，进行智能回退\n      console.warn(`[PDF导出] 字体变体 ${fontStyle} 不可用，尝试回退...`);\n\n      // 回退策略\n      if (fontStyle === 'bold' || fontStyle === 'bolditalic') {\n        // 粗体：优先尝试 normal，如果没有则用第一个可用的\n        if (this.availableFontWeights.includes('normal')) {\n          this.pdf.setFont(fontName, 'normal');\n          console.log(`[PDF导出] ✓ 回退到 normal 字体`);\n          return false; // 返回 false 表示使用了回退\n        }\n      }\n\n      if (fontStyle === 'italic' || fontStyle === 'bolditalic') {\n        // 斜体：中文字体通常没有斜体，回退到 light 或 normal\n        if (this.availableFontWeights.includes('light')) {\n          this.pdf.setFont(fontName, 'light');\n          console.log(`[PDF导出] ✓ 斜体回退到 light 字体`);\n          return false;\n        } else if (this.availableFontWeights.includes('normal')) {\n          this.pdf.setFont(fontName, 'normal');\n          console.log(`[PDF导出] ✓ 斜体回退到 normal 字体`);\n          return false;\n        }\n      }\n\n      // 默认回退：使用第一个可用的字体变体\n      if (this.availableFontWeights.length > 0) {\n        const fallbackStyle = this.availableFontWeights[0];\n        this.pdf.setFont(fontName, fallbackStyle);\n        console.log(`[PDF导出] ✓ 回退到 ${fallbackStyle} 字体`);\n        return false;\n      }\n\n      // 最终回退：使用 normal\n      this.pdf.setFont(fontName, 'normal');\n      console.log(`[PDF导出] ✓ 回退到 normal 字体`);\n      return false;\n    } catch (error) {\n      console.error(`[PDF导出] 设置字体失败:`, error);\n      // 最后的保险：使用默认字体\n      this.pdf.setFont(fontName || this.chineseFontName);\n      return false;\n    }\n  }\n\n  /**\n   * 清理和标准化文本，防止编码问题\n   * @param {string} text - 原始文本\n   * @returns {string} - 清理后的文本\n   */\n  cleanText(text) {\n    if (!text || typeof text !== 'string') {\n      return '';\n    }\n\n    try {\n      // 1. Unicode 标准化（NFC 模式）\n      let cleaned = text.normalize('NFC');\n      \n      // 2. 移除控制字符和不可打印字符（保留换行符和制表符）\n      cleaned = cleaned.replace(/[\\x00-\\x08\\x0B\\x0C\\x0E-\\x1F\\x7F-\\x9F]/g, '');\n      \n      // 3. 处理特殊Unicode字符（可能导致jsPDF问题）\n      // 移除零宽字符\n      cleaned = cleaned.replace(/[\\u200B-\\u200F\\u2060\\uFEFF]/g, '');\n      \n      // 4. 处理特殊的拉丁字符和符号（可能导致编码问题）\n      // 这些字符在PDF中可能显示不正确\n      cleaned = cleaned.replace(/[\\uE000-\\uF8FF]/g, ''); // 私人使用区\n      \n      return cleaned;\n    } catch (error) {\n      console.error('[PDF导出] 文本清理失败:', error);\n      // 如果清理失败，返回简化处理的文本\n      return text.replace(/[\\x00-\\x08\\x0B\\x0C\\x0E-\\x1F\\x7F]/g, '');\n    }\n  }\n\n  /**\n   * 主导出方法\n   * @param {Array} messages - 消息列表\n   * @param {Object} meta - 元数据(title, platform, created_at, updated_at)\n   * @param {Object} config - 导出配置\n   */\n  async exportToPDF(messages, meta, config = {}) {\n    console.log('[PDF导出] 开始导出', {\n      messageCount: messages.length,\n      config\n    });\n\n    // 检查字体是否就绪\n    if (!isFontReady()) {\n      const status = getFontStatus();\n      let errorMessage = 'PDF 字体尚未加载完成，无法导出。\\n\\n';\n\n      if (status.isLoading) {\n        errorMessage += `字体正在下载中 (${status.progress}%)，请稍后再试。`;\n      } else if (status.error) {\n        errorMessage += `字体下载失败: ${status.error}\\n\\n请检查网络连接后刷新页面重试。`;\n      } else {\n        errorMessage += '请刷新页面以开始下载字体。';\n      }\n\n      throw new Error(errorMessage);\n    }\n\n    // 保存元数据和导出时间\n    this.meta = meta;\n    this.exportDate = DateTimeUtils.formatDateTime(new Date());\n    this.messageAnchors = []; // 重置消息锚点\n\n    this.config = {\n      includeThinking: config.includeThinking ?? true,\n      includeArtifacts: config.includeArtifacts ?? true,\n      includeTimestamps: config.includeTimestamps ?? false,\n      includeTools: config.includeTools ?? true,\n      includeCitations: config.includeCitations ?? true,\n      highQuality: config.highQuality ?? false,\n      ...config\n    };\n\n    // 初始化PDF文档\n    this.pdf = new jsPDF({\n      orientation: 'portrait',\n      unit: 'mm',\n      format: 'a4',\n      compress: true\n    });\n\n    // 尝试加载中文字体（异步加载可能需要时间）\n    try {\n      console.log('[PDF导出] 开始加载中文字体...');\n      const fontLoadResult = await addChineseFontSupport(this.pdf);\n      this.useChineseFont = fontLoadResult.success;\n      this.chineseFontName = fontLoadResult.fontName;\n      this.availableFontWeights = fontLoadResult.availableWeights || [];\n      this.isSystemFont = fontLoadResult.isSystemFont || false;\n\n      if (!this.useChineseFont) {\n        console.warn('[PDF导出] 中文字体加载失败，将使用默认字体（中文可能显示为方框）');\n        if (fontLoadResult.systemFontAvailable) {\n          console.warn('[PDF导出] 提示：检测到系统有中文字体，但无法在浏览器环境中直接使用');\n          console.warn('[PDF导出] 建议：请确保项目 public/fonts/ 目录下有中文字体文件');\n        }\n      } else {\n        const fontType = this.isSystemFont ? '系统字体' : '项目字体';\n        console.log(`[PDF导出] 中文字体加载成功: ${this.chineseFontName} (${fontType})`);\n        console.log(`[PDF导出] 可用字体变体: ${this.availableFontWeights.join(', ')}`);\n        if (fontLoadResult.systemFontInfo) {\n          console.log(`[PDF导出] 系统字体信息: ${fontLoadResult.systemFontInfo.fontName}`);\n        }\n      }\n    } catch (error) {\n      console.error('[PDF导出] 字体加载异常:', error);\n      this.useChineseFont = false;\n      this.chineseFontName = 'helvetica';\n      this.availableFontWeights = [];\n      this.isSystemFont = false;\n    }\n\n    // 无论字体是否加载成功，都设置一个默认字体\n    this.pdf.setFont(this.chineseFontName);\n\n    // 渲染文档\n    this.renderTitle(meta);\n    this.renderMetadata(meta);\n    this.currentY += PDF_STYLES.SECTION_SPACING;\n\n    // 如果有多于1条消息，预留目录页\n    const hasTOC = messages.length > 1;\n    let tocPageNumber = 0;\n    if (hasTOC) {\n      this.pdf.addPage();\n      tocPageNumber = this.pdf.internal.getCurrentPageInfo().pageNumber;\n      this.currentY = PDF_STYLES.MARGIN_TOP;\n    }\n\n    // 渲染消息\n    for (let i = 0; i < messages.length; i++) {\n      // 如果有目录，第一条消息需要新开一页\n      if (hasTOC && i === 0) {\n        this.pdf.addPage();\n        this.currentY = PDF_STYLES.MARGIN_TOP;\n      }\n      this.renderMessage(messages[i], i + 1);\n    }\n\n    // 生成目录（带页码链接）\n    if (hasTOC) {\n      console.log('[PDF导出] 生成目录...');\n      this.renderTOCWithLinks(tocPageNumber, messages);\n    }\n\n    // 添加PDF书签\n    console.log('[PDF导出] 添加PDF书签...');\n    this.addBookmarks();\n\n    // 为所有页面添加页脚\n    console.log('[PDF导出] 添加页脚...');\n    this.addFooters();\n\n    // 生成文件名并保存\n    const fileName = this.generateFileName(meta);\n    this.pdf.save(fileName);\n\n    console.log('[PDF导出] 导出完成:', fileName);\n    return true;\n  }\n\n  /**\n   * 渲染标题页\n   */\n  renderTitle(meta) {\n    this.pdf.setFontSize(PDF_STYLES.FONT_SIZE_TITLE);\n    this.pdf.setTextColor(...PDF_STYLES.COLOR_TEXT);\n\n    const rawTitle = meta.name || 'Conversation';\n    const title = this.cleanText(rawTitle); // 清理标题文本\n    const maxWidth = PDF_STYLES.PAGE_WIDTH - PDF_STYLES.MARGIN_LEFT - PDF_STYLES.MARGIN_RIGHT;\n\n    // 标题可能很长,需要自动换行\n    // 注意: 如果字体加载失败,splitTextToSize可能会报错\n    let titleLines;\n    try {\n      titleLines = this.pdf.splitTextToSize(title, maxWidth);\n    } catch (error) {\n      console.error('[PDF导出] 标题分割失败,使用原始标题:', error);\n      // 如果splitTextToSize失败,直接使用原始标题\n      titleLines = [title];\n    }\n    \n    titleLines.forEach(line => {\n      this.checkPageBreak(PDF_STYLES.FONT_SIZE_TITLE);\n      const cleanLine = this.cleanText(line);\n      if (cleanLine && cleanLine.trim().length > 0) {\n        this.pdf.text(cleanLine, PDF_STYLES.MARGIN_LEFT, this.currentY);\n      }\n      this.currentY += PDF_STYLES.LINE_HEIGHT * 1.5;\n    });\n\n    this.currentY += PDF_STYLES.SECTION_SPACING;\n  }\n\n  /**\n   * 渲染元数据\n   */\n  renderMetadata(meta) {\n    this.pdf.setFontSize(PDF_STYLES.FONT_SIZE_TIMESTAMP);\n    this.pdf.setTextColor(...PDF_STYLES.COLOR_TIMESTAMP);\n\n    const lines = [];\n\n    if (meta.platform) {\n      lines.push(`Platform: ${meta.platform}`);\n    }\n\n    if (meta.created_at) {\n      lines.push(`Created: ${meta.created_at}`);\n    }\n\n    if (meta.updated_at) {\n      lines.push(`Updated: ${meta.updated_at}`);\n    }\n\n    lines.push(`Exported: ${DateTimeUtils.formatDateTime(new Date())}`);\n\n    lines.forEach(line => {\n      this.checkPageBreak(PDF_STYLES.FONT_SIZE_TIMESTAMP);\n      this.pdf.text(line, PDF_STYLES.MARGIN_LEFT, this.currentY);\n      this.currentY += PDF_STYLES.LINE_HEIGHT;\n    });\n  }\n\n  /**\n   * 渲染目录（Table of Contents）带页码链接\n   * @param {number} tocPage - 目录所在页码\n   * @param {Array} messages - 消息列表\n   */\n  renderTOCWithLinks(tocPage, messages) {\n    // 切换到目录页\n    this.pdf.setPage(tocPage);\n    this.currentY = PDF_STYLES.MARGIN_TOP;\n\n    // 渲染目录标题\n    this.pdf.setFontSize(PDF_STYLES.FONT_SIZE_H1);\n    this.pdf.setTextColor(...PDF_STYLES.COLOR_TEXT);\n    this.pdf.text('Table of Contents', PDF_STYLES.MARGIN_LEFT, this.currentY);\n    this.currentY += PDF_STYLES.LINE_HEIGHT * 2;\n\n    // 绘制标题下方的分隔线\n    this.pdf.setDrawColor(...PDF_STYLES.COLOR_BORDER);\n    this.pdf.setLineWidth(0.3);\n    this.pdf.line(\n      PDF_STYLES.MARGIN_LEFT,\n      this.currentY,\n      PDF_STYLES.PAGE_WIDTH - PDF_STYLES.MARGIN_RIGHT,\n      this.currentY\n    );\n    this.currentY += PDF_STYLES.LINE_HEIGHT;\n\n    // 渲染消息列表\n    this.pdf.setFontSize(PDF_STYLES.FONT_SIZE_BODY);\n    const maxWidth = PDF_STYLES.PAGE_WIDTH - PDF_STYLES.MARGIN_LEFT - PDF_STYLES.MARGIN_RIGHT;\n\n    this.messageAnchors.forEach((anchor, idx) => {\n      const message = messages[idx];\n      if (!message) return;\n\n      this.checkPageBreak(PDF_STYLES.FONT_SIZE_BODY * 2);\n\n      const messageNumber = `${anchor.index}.`;\n      const sender = anchor.sender === 'human' ? 'Human' : 'Assistant';\n\n      // 获取消息预览（前50个字符）\n      let preview = anchor.title || '';\n      preview = this.cleanText(preview);\n      preview = preview.replace(/\\n/g, ' ').substring(0, 50);\n      if (preview.length >= 50) {\n        preview += '...';\n      }\n\n      // 添加分支标记\n      let branchMarker = '';\n      if (message.branchInfo?.isBranchPoint) {\n        branchMarker = ` [Branch ${message.branchInfo.childCount}]`;\n      }\n\n      // 构建目录条目和页码\n      const entry = `${messageNumber} ${sender}${branchMarker}`;\n      const pageNum = `p.${anchor.page}`;\n\n      // 设置发送者颜色\n      const color = anchor.sender === 'human'\n        ? PDF_STYLES.COLOR_SENDER_HUMAN\n        : PDF_STYLES.COLOR_SENDER_ASSISTANT;\n      this.pdf.setTextColor(...color);\n\n      // 计算页码位置（右对齐）\n      const pageNumWidth = this.pdf.getTextWidth(pageNum);\n      const pageNumX = PDF_STYLES.PAGE_WIDTH - PDF_STYLES.MARGIN_RIGHT - pageNumWidth;\n\n      // 渲染条目（作为链接）\n      const entryY = this.currentY;\n      this.pdf.textWithLink(entry, PDF_STYLES.MARGIN_LEFT + 5, entryY, {\n        pageNumber: anchor.page\n      });\n\n      // 渲染页码（也作为链接）\n      this.pdf.setTextColor(...PDF_STYLES.COLOR_TIMESTAMP);\n      this.pdf.textWithLink(pageNum, pageNumX, entryY, {\n        pageNumber: anchor.page\n      });\n\n      // 渲染预览（如果有）\n      if (preview) {\n        this.pdf.setFontSize(PDF_STYLES.FONT_SIZE_TIMESTAMP);\n        this.pdf.setTextColor(...PDF_STYLES.COLOR_TIMESTAMP);\n        this.currentY += PDF_STYLES.LINE_HEIGHT;\n        this.checkPageBreak(PDF_STYLES.FONT_SIZE_TIMESTAMP);\n        this.pdf.text(preview, PDF_STYLES.MARGIN_LEFT + 10, this.currentY);\n        this.pdf.setFontSize(PDF_STYLES.FONT_SIZE_BODY);\n      }\n\n      this.currentY += PDF_STYLES.LINE_HEIGHT * 1.5;\n    });\n  }\n\n  /**\n   * 渲染单条消息\n   */\n  renderMessage(message, index) {\n    this.checkPageBreak(PDF_STYLES.FONT_SIZE_SENDER + PDF_STYLES.MESSAGE_SPACING);\n\n    // 记录消息位置用于目录链接和书签\n    const currentPage = this.pdf.internal.getCurrentPageInfo().pageNumber;\n    const currentY = this.currentY;\n    this.messageAnchors.push({\n      index,\n      page: currentPage,\n      y: currentY,\n      sender: message.sender,\n      title: message.display_text ? message.display_text.substring(0, 50) : ''\n    });\n\n    // 渲染发送者标签\n    this.renderSender(message, index);\n\n    // 渲染时间戳\n    if (this.config.includeTimestamps && message.timestamp) {\n      this.renderTimestamp(message.timestamp);\n    }\n\n    // 渲染thinking(前置)\n    if (message.thinking && this.config.includeThinking && message.sender !== 'human') {\n      this.renderThinking(message.thinking);\n    }\n\n    // 渲染正文\n    if (message.display_text) {\n      this.renderBody(message.display_text);\n    }\n\n    // 渲染附件\n    if (message.attachments?.length > 0 && message.sender === 'human') {\n      this.renderAttachments(message.attachments);\n    }\n\n    // 渲染Artifacts\n    if (message.artifacts?.length > 0 && this.config.includeArtifacts && message.sender !== 'human') {\n      message.artifacts.forEach(artifact => {\n        this.renderArtifact(artifact);\n      });\n    }\n\n    // 渲染工具调用\n    if (message.tools?.length > 0 && this.config.includeTools) {\n      message.tools.forEach(tool => {\n        this.renderTool(tool);\n      });\n    }\n\n    // 渲染引用\n    if (message.citations?.length > 0 && this.config.includeCitations) {\n      this.renderCitations(message.citations);\n    }\n\n    // 消息间距\n    this.currentY += PDF_STYLES.MESSAGE_SPACING;\n  }\n\n  /**\n   * 渲染发送者标签\n   */\n  renderSender(message, index) {\n    this.pdf.setFontSize(PDF_STYLES.FONT_SIZE_SENDER);\n\n    // 根据发送者设置颜色\n    const color = message.sender === 'human'\n      ? PDF_STYLES.COLOR_SENDER_HUMAN\n      : PDF_STYLES.COLOR_SENDER_ASSISTANT;\n\n    this.pdf.setTextColor(...color);\n\n    // 构建发送者标签\n    const senderLabel = message.sender === 'human' ? 'Human' : 'Assistant';\n    const label = `${index}. ${senderLabel}`;\n\n    // 添加分支标记\n    let finalLabel = label;\n    if (message.branchInfo?.isBranchPoint) {\n      const branchMarker = ` [Branch ${message.branchInfo.childCount}]`;\n      finalLabel = label + branchMarker;\n    }\n\n    // 清理并输出标签\n    const cleanLabel = this.cleanText(finalLabel);\n    if (cleanLabel && cleanLabel.trim().length > 0) {\n      this.pdf.text(cleanLabel, PDF_STYLES.MARGIN_LEFT, this.currentY);\n    }\n\n    this.currentY += PDF_STYLES.LINE_HEIGHT * 1.2;\n  }\n\n  /**\n   * 渲染时间戳\n   */\n  renderTimestamp(timestamp) {\n    this.pdf.setFontSize(PDF_STYLES.FONT_SIZE_TIMESTAMP);\n    this.pdf.setTextColor(...PDF_STYLES.COLOR_TIMESTAMP);\n    this.pdf.text(timestamp, PDF_STYLES.MARGIN_LEFT, this.currentY);\n    this.currentY += PDF_STYLES.LINE_HEIGHT;\n  }\n\n  /**\n   * 渲染正文\n   */\n  renderBody(text) {\n    this.pdf.setFontSize(PDF_STYLES.FONT_SIZE_BODY);\n    this.pdf.setTextColor(...PDF_STYLES.COLOR_TEXT);\n\n    const maxWidth = PDF_STYLES.PAGE_WIDTH - PDF_STYLES.MARGIN_LEFT - PDF_STYLES.MARGIN_RIGHT;\n\n    // 处理代码块和LaTeX公式\n    const parts = this.parseTextWithCodeBlocksAndLatex(text);\n\n    parts.forEach(part => {\n      if (part.type === 'code') {\n        this.renderCodeBlock(part.content, part.language);\n      } else if (part.type === 'latex-block') {\n        this.renderLatexBlock(part.content);\n      } else if (part.type === 'latex-inline') {\n        this.renderLatexInline(part.content, maxWidth);\n      } else {\n        // 渲染普通文本，支持markdown格式\n        this.renderMarkdownText(part.content, maxWidth);\n      }\n    });\n\n    this.currentY += PDF_STYLES.LINE_HEIGHT;\n  }\n\n  /**\n   * 渲染纯文本(带自动换行)\n   */\n  renderPlainText(text, maxWidth) {\n    // 处理空文本\n    if (!text || text.trim().length === 0) {\n      this.currentY += PDF_STYLES.LINE_HEIGHT;\n      return;\n    }\n\n    // 清理文本，防止编码问题\n    const cleanedText = this.cleanText(text);\n    \n    if (!cleanedText || cleanedText.trim().length === 0) {\n      console.warn('[PDF导出] 文本清理后为空，跳过');\n      this.currentY += PDF_STYLES.LINE_HEIGHT;\n      return;\n    }\n\n    // 使用 splitTextToSize 自动处理换行,支持Unicode字符\n    let lines;\n    try {\n      lines = this.pdf.splitTextToSize(cleanedText, maxWidth);\n    } catch (error) {\n      console.error('[PDF导出] splitTextToSize失败，使用简单换行:', error);\n      // 如果splitTextToSize失败,使用简单的换行逻辑\n      lines = cleanedText.split('\\n');\n    }\n\n    lines.forEach(line => {\n      this.checkPageBreak(PDF_STYLES.FONT_SIZE_BODY);\n      \n      // 再次清理单行文本（防止splitTextToSize引入问题）\n      const cleanLine = this.cleanText(line);\n      if (cleanLine && cleanLine.trim().length > 0) {\n        this.pdf.text(cleanLine, PDF_STYLES.MARGIN_LEFT, this.currentY);\n      }\n      this.currentY += PDF_STYLES.LINE_HEIGHT;\n    });\n  }\n\n  /**\n   * 渲染代码块（支持跨页）- 简化版，逐行渲染\n   */\n  renderCodeBlock(code, language = '') {\n    this.checkPageBreak(PDF_STYLES.FONT_SIZE_CODE + PDF_STYLES.SECTION_SPACING * 2);\n\n    const maxWidth = PDF_STYLES.PAGE_WIDTH - PDF_STYLES.MARGIN_LEFT - PDF_STYLES.MARGIN_RIGHT;\n    const lineNumberWidth = 8;\n    const codeWidth = maxWidth - lineNumberWidth - 8;\n    const padding = 3;\n\n    const cleanCode = this.cleanText(code);\n    const cleanLanguage = this.cleanText(language);\n\n    // 渲染语言标签\n    if (cleanLanguage) {\n      this.pdf.setFontSize(PDF_STYLES.FONT_SIZE_TIMESTAMP);\n      this.pdf.setTextColor(100, 100, 100);\n      const labelText = cleanLanguage.toUpperCase();\n      const labelWidth = this.pdf.getTextWidth(labelText) + 4;\n      this.pdf.setFillColor(220, 220, 220);\n      this.pdf.roundedRect(\n        PDF_STYLES.MARGIN_LEFT,\n        this.currentY - 3,\n        labelWidth,\n        5,\n        1,\n        1,\n        'F'\n      );\n      this.pdf.text(labelText, PDF_STYLES.MARGIN_LEFT + 2, this.currentY);\n      this.currentY += PDF_STYLES.LINE_HEIGHT * 1.2;\n    }\n\n    // 处理代码行\n    this.pdf.setFontSize(PDF_STYLES.FONT_SIZE_CODE);\n    this.pdf.setFont(this.chineseFontName);\n    const codeLines = cleanCode.split('\\n');\n    const wrappedLines = [];\n\n    codeLines.forEach(line => {\n      if (!line) {\n        wrappedLines.push({ text: '', lineNumber: wrappedLines.length + 1 });\n        return;\n      }\n      const cleanLine = this.cleanText(line);\n      if (!cleanLine) {\n        wrappedLines.push({ text: '', lineNumber: wrappedLines.length + 1 });\n        return;\n      }\n\n      try {\n        const wrapped = this.pdf.splitTextToSize(cleanLine, codeWidth);\n        wrapped.forEach((wLine, idx) => {\n          wrappedLines.push({\n            text: wLine,\n            lineNumber: idx === 0 ? wrappedLines.length + 1 : null\n          });\n        });\n      } catch (error) {\n        wrappedLines.push({ text: cleanLine, lineNumber: wrappedLines.length + 1 });\n      }\n    });\n\n    // 逐行渲染，遇到需要换页时自动换页\n    const blockStartY = this.currentY;\n    const blockStartPage = this.pdf.internal.getCurrentPageInfo().pageNumber;\n    let isFirstLine = true;\n\n    // 先绘制第一页的背景和边框起始部分\n    const firstPageHeight = Math.min(\n      wrappedLines.length * PDF_STYLES.LINE_HEIGHT + padding * 2,\n      PDF_STYLES.PAGE_HEIGHT - PDF_STYLES.MARGIN_BOTTOM - this.currentY\n    );\n    this.pdf.setFillColor(248, 248, 248);\n    this.pdf.rect(\n      PDF_STYLES.MARGIN_LEFT,\n      blockStartY - padding,\n      maxWidth,\n      firstPageHeight,\n      'F'\n    );\n\n    this.currentY = blockStartY;\n\n    wrappedLines.forEach(({ text, lineNumber }, index) => {\n      // 检查是否需要换页\n      if (this.currentY + PDF_STYLES.FONT_SIZE_CODE > PDF_STYLES.PAGE_HEIGHT - PDF_STYLES.MARGIN_BOTTOM) {\n        // 先绘制当前页的代码块底部边框\n        this.pdf.setDrawColor(200, 200, 200);\n        this.pdf.setLineWidth(0.3);\n        const currentPageBottom = this.currentY;\n        this.pdf.line(\n          PDF_STYLES.MARGIN_LEFT,\n          blockStartY - padding,\n          PDF_STYLES.MARGIN_LEFT,\n          currentPageBottom\n        );\n        this.pdf.line(\n          PDF_STYLES.MARGIN_LEFT + maxWidth,\n          blockStartY - padding,\n          PDF_STYLES.MARGIN_LEFT + maxWidth,\n          currentPageBottom\n        );\n\n        // 换页\n        this.pdf.addPage();\n        this.currentY = PDF_STYLES.MARGIN_TOP;\n        \n        // 在新页绘制代码块背景（连续样式）\n        const remainingLines = wrappedLines.length - index;\n        const newPageHeight = Math.min(\n          remainingLines * PDF_STYLES.LINE_HEIGHT + padding,\n          PDF_STYLES.PAGE_HEIGHT - PDF_STYLES.MARGIN_BOTTOM - this.currentY\n        );\n        this.pdf.setFillColor(248, 248, 248);\n        this.pdf.rect(\n          PDF_STYLES.MARGIN_LEFT,\n          this.currentY - padding,\n          maxWidth,\n          newPageHeight,\n          'F'\n        );\n        \n        isFirstLine = false;\n      }\n\n      // 渲染行号\n      if (lineNumber !== null) {\n        this.pdf.setFontSize(PDF_STYLES.FONT_SIZE_CODE - 1);\n        this.pdf.setTextColor(150, 150, 150);\n        const lineNumStr = String(lineNumber).padStart(3, ' ');\n        this.pdf.text(lineNumStr, PDF_STYLES.MARGIN_LEFT + 1, this.currentY);\n      }\n\n      // 渲染代码文本\n      this.pdf.setFontSize(PDF_STYLES.FONT_SIZE_CODE);\n      this.pdf.setTextColor(50, 50, 50);\n      const safeLine = this.cleanText(text);\n      if (safeLine !== null && safeLine !== undefined) {\n        this.pdf.text(safeLine, PDF_STYLES.MARGIN_LEFT + lineNumberWidth + 2, this.currentY);\n      }\n      this.currentY += PDF_STYLES.LINE_HEIGHT;\n    });\n\n    // 绘制最后的边框和行号分隔线\n    const endPage = this.pdf.internal.getCurrentPageInfo().pageNumber;\n    \n    // 如果跨页，需要在每一页绘制边框\n    for (let page = blockStartPage; page <= endPage; page++) {\n      this.pdf.setPage(page);\n      const isFirst = (page === blockStartPage);\n      const isLast = (page === endPage);\n      \n      let boxStartY, boxEndY;\n      if (isFirst && isLast) {\n        // 单页代码块\n        boxStartY = blockStartY - padding;\n        boxEndY = this.currentY + padding;\n      } else if (isFirst) {\n        // 第一页\n        boxStartY = blockStartY - padding;\n        boxEndY = PDF_STYLES.PAGE_HEIGHT - PDF_STYLES.MARGIN_BOTTOM;\n      } else if (isLast) {\n        // 最后一页\n        boxStartY = PDF_STYLES.MARGIN_TOP - padding;\n        boxEndY = this.currentY + padding;\n      } else {\n        // 中间页\n        boxStartY = PDF_STYLES.MARGIN_TOP - padding;\n        boxEndY = PDF_STYLES.PAGE_HEIGHT - PDF_STYLES.MARGIN_BOTTOM;\n      }\n      \n      // 绘制边框\n      this.pdf.setDrawColor(200, 200, 200);\n      this.pdf.setLineWidth(0.3);\n      if (isFirst && isLast) {\n        this.pdf.roundedRect(PDF_STYLES.MARGIN_LEFT, boxStartY, maxWidth, boxEndY - boxStartY, 1.5, 1.5, 'S');\n      } else {\n        this.pdf.line(PDF_STYLES.MARGIN_LEFT, boxStartY, PDF_STYLES.MARGIN_LEFT, boxEndY);\n        this.pdf.line(PDF_STYLES.MARGIN_LEFT + maxWidth, boxStartY, PDF_STYLES.MARGIN_LEFT + maxWidth, boxEndY);\n        if (isFirst) {\n          this.pdf.line(PDF_STYLES.MARGIN_LEFT, boxStartY, PDF_STYLES.MARGIN_LEFT + maxWidth, boxStartY);\n        }\n        if (isLast) {\n          this.pdf.line(PDF_STYLES.MARGIN_LEFT, boxEndY, PDF_STYLES.MARGIN_LEFT + maxWidth, boxEndY);\n        }\n      }\n      \n      // 绘制行号分隔线\n      this.pdf.setDrawColor(220, 220, 220);\n      this.pdf.setLineWidth(0.2);\n      this.pdf.line(\n        PDF_STYLES.MARGIN_LEFT + lineNumberWidth,\n        boxStartY,\n        PDF_STYLES.MARGIN_LEFT + lineNumberWidth,\n        boxEndY\n      );\n    }\n\n    // 确保回到最后一页\n    this.pdf.setPage(endPage);\n    \n    // 恢复默认样式\n    this.pdf.setFont(this.chineseFontName);\n    this.pdf.setTextColor(...PDF_STYLES.COLOR_TEXT);\n    this.currentY += PDF_STYLES.SECTION_SPACING;\n  }\n\n  /**\n   * 将代码行按页分组\n   * @param {Array} wrappedLines - 包装后的代码行\n   * @returns {Array} - 分组后的行 [{page, startY, lines: [...]}]\n   */\n  groupCodeLinesByPage(wrappedLines) {\n    const groups = [];\n    let currentGroup = null;\n    const bottomLimit = PDF_STYLES.PAGE_HEIGHT - PDF_STYLES.MARGIN_BOTTOM;\n\n    let simulatedY = this.currentY;\n    let simulatedPage = this.pdf.internal.getCurrentPageInfo().pageNumber;\n\n    wrappedLines.forEach((line) => {\n      // 检查是否需要换页\n      if (simulatedY + PDF_STYLES.FONT_SIZE_CODE > bottomLimit) {\n        simulatedPage++;\n        simulatedY = PDF_STYLES.MARGIN_TOP;\n        currentGroup = null; // 开始新组\n      }\n\n      // 如果没有当前组或换页了，创建新组\n      if (!currentGroup || currentGroup.page !== simulatedPage) {\n        currentGroup = {\n          page: simulatedPage,\n          startY: simulatedY,\n          lines: []\n        };\n        groups.push(currentGroup);\n      }\n\n      // 添加行到当前组\n      currentGroup.lines.push(line);\n      simulatedY += PDF_STYLES.LINE_HEIGHT;\n    });\n\n    return groups;\n  }\n\n  /**\n   * 渲染块级LaTeX公式（支持跨页）- 简化版\n   * @param {string} latex - LaTeX公式内容\n   */\n  renderLatexBlock(latex) {\n    this.checkPageBreak(PDF_STYLES.FONT_SIZE_BODY + PDF_STYLES.SECTION_SPACING * 2);\n\n    const maxWidth = PDF_STYLES.PAGE_WIDTH - PDF_STYLES.MARGIN_LEFT - PDF_STYLES.MARGIN_RIGHT;\n    const padding = 3;\n\n    // 清理并转换LaTeX符号\n    const cleanLatex = this.cleanText(latex);\n    const renderedLatex = this.convertLatexToUnicode(cleanLatex);\n\n    // 渲染\"Math\"标签\n    this.pdf.setFontSize(PDF_STYLES.FONT_SIZE_TIMESTAMP);\n    this.pdf.setTextColor(70, 130, 180);\n    const labelText = 'MATH';\n    const labelWidth = this.pdf.getTextWidth(labelText) + 4;\n    this.pdf.setFillColor(230, 240, 250);\n    this.pdf.roundedRect(\n      PDF_STYLES.MARGIN_LEFT,\n      this.currentY - 3,\n      labelWidth,\n      5,\n      1,\n      1,\n      'F'\n    );\n    this.pdf.text(labelText, PDF_STYLES.MARGIN_LEFT + 2, this.currentY);\n    this.currentY += PDF_STYLES.LINE_HEIGHT * 1.2;\n\n    // 处理公式文本\n    this.pdf.setFontSize(PDF_STYLES.FONT_SIZE_BODY);\n    this.pdf.setFont(this.chineseFontName);\n\n    let formulaLines;\n    try {\n      formulaLines = this.pdf.splitTextToSize(renderedLatex, maxWidth - 8);\n    } catch (error) {\n      formulaLines = renderedLatex.split('\\n');\n    }\n\n    // 逐行渲染\n    const blockStartY = this.currentY;\n    const blockStartPage = this.pdf.internal.getCurrentPageInfo().pageNumber;\n\n    // 绘制第一页的背景\n    const firstPageHeight = Math.min(\n      formulaLines.length * PDF_STYLES.LINE_HEIGHT + padding * 2,\n      PDF_STYLES.PAGE_HEIGHT - PDF_STYLES.MARGIN_BOTTOM - this.currentY\n    );\n    this.pdf.setFillColor(245, 250, 255);\n    this.pdf.rect(\n      PDF_STYLES.MARGIN_LEFT,\n      blockStartY - padding,\n      maxWidth,\n      firstPageHeight,\n      'F'\n    );\n\n    this.currentY = blockStartY;\n\n    formulaLines.forEach((line, index) => {\n      // 检查是否需要换页\n      if (this.currentY + PDF_STYLES.FONT_SIZE_BODY > PDF_STYLES.PAGE_HEIGHT - PDF_STYLES.MARGIN_BOTTOM) {\n        // 换页\n        this.pdf.addPage();\n        this.currentY = PDF_STYLES.MARGIN_TOP;\n\n        // 在新页绘制背景\n        const remainingLines = formulaLines.length - index;\n        const newPageHeight = Math.min(\n          remainingLines * PDF_STYLES.LINE_HEIGHT + padding,\n          PDF_STYLES.PAGE_HEIGHT - PDF_STYLES.MARGIN_BOTTOM - this.currentY\n        );\n        this.pdf.setFillColor(245, 250, 255);\n        this.pdf.rect(\n          PDF_STYLES.MARGIN_LEFT,\n          this.currentY - padding,\n          maxWidth,\n          newPageHeight,\n          'F'\n        );\n      }\n\n      // 渲染公式文本\n      this.pdf.setTextColor(30, 60, 120);\n      const safeLine = this.cleanText(line);\n      if (safeLine && safeLine.trim().length > 0) {\n        this.pdf.text(safeLine, PDF_STYLES.MARGIN_LEFT + 4, this.currentY);\n      }\n      this.currentY += PDF_STYLES.LINE_HEIGHT;\n    });\n\n    // 绘制边框\n    const endPage = this.pdf.internal.getCurrentPageInfo().pageNumber;\n\n    for (let page = blockStartPage; page <= endPage; page++) {\n      this.pdf.setPage(page);\n      const isFirst = (page === blockStartPage);\n      const isLast = (page === endPage);\n\n      let boxStartY, boxEndY;\n      if (isFirst && isLast) {\n        boxStartY = blockStartY - padding;\n        boxEndY = this.currentY + padding;\n      } else if (isFirst) {\n        boxStartY = blockStartY - padding;\n        boxEndY = PDF_STYLES.PAGE_HEIGHT - PDF_STYLES.MARGIN_BOTTOM;\n      } else if (isLast) {\n        boxStartY = PDF_STYLES.MARGIN_TOP - padding;\n        boxEndY = this.currentY + padding;\n      } else {\n        boxStartY = PDF_STYLES.MARGIN_TOP - padding;\n        boxEndY = PDF_STYLES.PAGE_HEIGHT - PDF_STYLES.MARGIN_BOTTOM;\n      }\n\n      // 绘制边框\n      this.pdf.setDrawColor(180, 210, 240);\n      this.pdf.setLineWidth(0.4);\n      if (isFirst && isLast) {\n        this.pdf.roundedRect(PDF_STYLES.MARGIN_LEFT, boxStartY, maxWidth, boxEndY - boxStartY, 1.5, 1.5, 'S');\n      } else {\n        this.pdf.line(PDF_STYLES.MARGIN_LEFT, boxStartY, PDF_STYLES.MARGIN_LEFT, boxEndY);\n        this.pdf.line(PDF_STYLES.MARGIN_LEFT + maxWidth, boxStartY, PDF_STYLES.MARGIN_LEFT + maxWidth, boxEndY);\n        if (isFirst) {\n          this.pdf.line(PDF_STYLES.MARGIN_LEFT, boxStartY, PDF_STYLES.MARGIN_LEFT + maxWidth, boxStartY);\n        }\n        if (isLast) {\n          this.pdf.line(PDF_STYLES.MARGIN_LEFT, boxEndY, PDF_STYLES.MARGIN_LEFT + maxWidth, boxEndY);\n        }\n      }\n    }\n\n    // 确保回到最后一页\n    this.pdf.setPage(endPage);\n\n    // 恢复默认样式\n    this.pdf.setTextColor(...PDF_STYLES.COLOR_TEXT);\n    this.currentY += PDF_STYLES.SECTION_SPACING;\n  }\n\n  /**\n   * 将LaTeX行按页分组\n   * @param {Array} lines - LaTeX公式行\n   * @returns {Array} - 分组后的行 [{page, startY, lines: [...]}]\n   */\n  groupLatexLinesByPage(lines) {\n    const groups = [];\n    let currentGroup = null;\n    const bottomLimit = PDF_STYLES.PAGE_HEIGHT - PDF_STYLES.MARGIN_BOTTOM;\n\n    let simulatedY = this.currentY;\n    let simulatedPage = this.pdf.internal.getCurrentPageInfo().pageNumber;\n\n    lines.forEach((line) => {\n      // 检查是否需要换页\n      if (simulatedY + PDF_STYLES.FONT_SIZE_BODY > bottomLimit) {\n        simulatedPage++;\n        simulatedY = PDF_STYLES.MARGIN_TOP;\n        currentGroup = null; // 开始新组\n      }\n\n      // 如果没有当前组或换页了，创建新组\n      if (!currentGroup || currentGroup.page !== simulatedPage) {\n        currentGroup = {\n          page: simulatedPage,\n          startY: simulatedY,\n          lines: []\n        };\n        groups.push(currentGroup);\n      }\n\n      // 添加行到当前组\n      currentGroup.lines.push(line);\n      simulatedY += PDF_STYLES.LINE_HEIGHT;\n    });\n\n    return groups;\n  }\n\n  /**\n   * 渲染行内LaTeX公式\n   * @param {string} latex - LaTeX公式内容\n   * @param {number} maxWidth - 最大宽度\n   */\n  renderLatexInline(latex, maxWidth) {\n    const cleanLatex = this.cleanText(latex);\n\n    // 转换LaTeX符号为Unicode\n    const renderedLatex = this.convertLatexToUnicode(cleanLatex);\n\n    // 设置行内公式样式\n    this.pdf.setFontSize(PDF_STYLES.FONT_SIZE_BODY);\n\n    // 添加前缀和后缀标记\n    const formulaText = `⟨${renderedLatex}⟩`;\n\n    // 使用特殊颜色标识数学公式\n    this.pdf.setTextColor(70, 130, 180); // 蓝色\n\n    try {\n      const lines = this.pdf.splitTextToSize(formulaText, maxWidth);\n      lines.forEach(line => {\n        this.checkPageBreak(PDF_STYLES.FONT_SIZE_BODY);\n        const safeLine = this.cleanText(line);\n        if (safeLine && safeLine.trim().length > 0) {\n          this.pdf.text(safeLine, PDF_STYLES.MARGIN_LEFT, this.currentY);\n        }\n        this.currentY += PDF_STYLES.LINE_HEIGHT;\n      });\n    } catch (error) {\n      this.pdf.text(formulaText, PDF_STYLES.MARGIN_LEFT, this.currentY);\n      this.currentY += PDF_STYLES.LINE_HEIGHT;\n    }\n\n    // 恢复默认颜色\n    this.pdf.setTextColor(...PDF_STYLES.COLOR_TEXT);\n  }\n\n  /**\n   * 渲染thinking区块\n   */\n  renderThinking(thinking) {\n    this.renderSection('💭 Thinking', thinking, PDF_STYLES.COLOR_SECTION_BG);\n  }\n\n  /**\n   * 渲染Artifact\n   */\n  renderArtifact(artifact) {\n    const title = `📄 Artifact: ${artifact.title || 'Untitled'}`;\n    const content = artifact.content || '';\n    this.renderSection(title, content, PDF_STYLES.COLOR_SECTION_BG);\n  }\n\n  /**\n   * 渲染工具调用\n   */\n  renderTool(tool) {\n    const title = `🔧 Tool: ${tool.name || 'Unknown'}`;\n    const content = `Input: ${JSON.stringify(tool.input, null, 2)}\\n\\nOutput: ${tool.output || 'N/A'}`;\n    this.renderSection(title, content, PDF_STYLES.COLOR_SECTION_BG);\n  }\n\n  /**\n   * 渲染引用\n   */\n  renderCitations(citations) {\n    const title = '📚 Citations';\n    const content = citations.map((cit, i) =>\n      `[${i + 1}] ${cit.title || cit.url || 'Unknown'}`\n    ).join('\\n');\n    this.renderSection(title, content, PDF_STYLES.COLOR_SECTION_BG);\n  }\n\n  /**\n   * 渲染附件\n   */\n  renderAttachments(attachments) {\n    const title = '📎 Attachments';\n    const content = attachments.map((att, i) =>\n      `[${i + 1}] ${att.file_name || att.name || 'file'} (${att.file_type || att.type || 'unknown'})`\n    ).join('\\n');\n    this.renderSection(title, content, PDF_STYLES.COLOR_SECTION_BG);\n  }\n\n  /**\n   * 通用区块渲染(带背景)\n   */\n  renderSection(title, content, bgColor) {\n    this.checkPageBreak(PDF_STYLES.FONT_SIZE_H2 + PDF_STYLES.SECTION_SPACING * 2);\n\n    const maxWidth = PDF_STYLES.PAGE_WIDTH - PDF_STYLES.MARGIN_LEFT - PDF_STYLES.MARGIN_RIGHT;\n    \n    // 清理标题和内容\n    const cleanTitle = this.cleanText(title);\n    const cleanContent = this.cleanText(content);\n    \n    // 处理内容换行,带错误处理\n    let contentLines;\n    try {\n      contentLines = this.pdf.splitTextToSize(cleanContent, maxWidth - 4);\n    } catch (error) {\n      console.error('[PDF导出] 区块内容分割失败:', error);\n      contentLines = cleanContent.split('\\n');\n    }\n    \n    const bgHeight = PDF_STYLES.LINE_HEIGHT * (contentLines.length + 2);\n\n    // 绘制背景\n    this.pdf.setFillColor(...bgColor);\n    this.pdf.rect(\n      PDF_STYLES.MARGIN_LEFT,\n      this.currentY - 3,\n      maxWidth,\n      bgHeight,\n      'F'\n    );\n\n    // 渲染标题\n    this.pdf.setFontSize(PDF_STYLES.FONT_SIZE_H2);\n    this.pdf.setTextColor(...PDF_STYLES.COLOR_TEXT);\n    if (cleanTitle && cleanTitle.trim().length > 0) {\n      this.pdf.text(cleanTitle, PDF_STYLES.MARGIN_LEFT + 2, this.currentY);\n    }\n    this.currentY += PDF_STYLES.LINE_HEIGHT * 1.2;\n\n    // 渲染内容\n    this.pdf.setFontSize(PDF_STYLES.FONT_SIZE_BODY);\n    contentLines.forEach(line => {\n      this.checkPageBreak(PDF_STYLES.FONT_SIZE_BODY);\n      const cleanLine = this.cleanText(line);\n      if (cleanLine && cleanLine.trim().length > 0) {\n        this.pdf.text(cleanLine, PDF_STYLES.MARGIN_LEFT + 2, this.currentY);\n      }\n      this.currentY += PDF_STYLES.LINE_HEIGHT;\n    });\n\n    this.currentY += PDF_STYLES.SECTION_SPACING;\n  }\n\n  /**\n   * 渲染页脚\n   * @param {number} pageNumber - 当前页码\n   * @param {number} totalPages - 总页数\n   */\n  renderFooter(pageNumber, totalPages) {\n    const originalY = this.currentY;\n    const originalFontSize = this.pdf.internal.getFontSize();\n\n    // 设置页脚样式\n    this.pdf.setFontSize(PDF_STYLES.FONT_SIZE_FOOTER);\n    this.pdf.setTextColor(...PDF_STYLES.COLOR_FOOTER);\n\n    const footerY = PDF_STYLES.PAGE_HEIGHT - 10;\n\n    // 绘制页脚上方的分隔线\n    this.pdf.setDrawColor(...PDF_STYLES.COLOR_BORDER);\n    this.pdf.setLineWidth(0.1);\n    this.pdf.line(\n      PDF_STYLES.MARGIN_LEFT,\n      PDF_STYLES.PAGE_HEIGHT - PDF_STYLES.FOOTER_HEIGHT,\n      PDF_STYLES.PAGE_WIDTH - PDF_STYLES.MARGIN_RIGHT,\n      PDF_STYLES.PAGE_HEIGHT - PDF_STYLES.FOOTER_HEIGHT\n    );\n\n    // 左侧显示导出时间\n    const exportText = `Exported: ${this.exportDate}`;\n    this.pdf.text(exportText, PDF_STYLES.MARGIN_LEFT, footerY);\n\n    // 右侧显示页码\n    const pageText = `${pageNumber} / ${totalPages}`;\n    const pageTextWidth = this.pdf.getTextWidth(pageText);\n    this.pdf.text(pageText, PDF_STYLES.PAGE_WIDTH - PDF_STYLES.MARGIN_RIGHT - pageTextWidth, footerY);\n\n    // 恢复原始设置\n    this.pdf.setFontSize(originalFontSize);\n    this.pdf.setTextColor(...PDF_STYLES.COLOR_TEXT);\n    this.currentY = originalY;\n  }\n\n  /**\n   * 添加PDF书签（outline）\n   */\n  addBookmarks() {\n    if (this.messageAnchors.length === 0) return;\n\n    // jsPDF的outline功能\n    // 创建书签树结构\n    try {\n      this.messageAnchors.forEach((anchor) => {\n        const sender = anchor.sender === 'human' ? 'Human' : 'Assistant';\n        const title = `${anchor.index}. ${sender}`;\n\n        // 使用jsPDF的outline API\n        // 注意：jsPDF的outline功能可能需要插件支持\n        if (this.pdf.outline) {\n          this.pdf.outline.add(null, title, { pageNumber: anchor.page });\n        }\n      });\n    } catch (error) {\n      console.warn('[PDF导出] 书签添加失败（可能不支持）:', error);\n    }\n  }\n\n  /**\n   * 为所有页面添加页脚\n   */\n  addFooters() {\n    const totalPages = this.pdf.internal.getNumberOfPages();\n\n    for (let i = 1; i <= totalPages; i++) {\n      this.pdf.setPage(i);\n      this.renderFooter(i, totalPages);\n    }\n  }\n\n  /**\n   * 检查是否需要分页\n   */\n  checkPageBreak(requiredSpace = 20) {\n    const bottomLimit = PDF_STYLES.PAGE_HEIGHT - PDF_STYLES.MARGIN_BOTTOM;\n\n    if (this.currentY + requiredSpace > bottomLimit) {\n      this.pdf.addPage();\n      this.currentY = PDF_STYLES.MARGIN_TOP;\n    }\n  }\n\n  /**\n   * 解析文本中的代码块和LaTeX公式\n   * 优先级：代码块 > LaTeX块级公式 > LaTeX行内公式\n   */\n  parseTextWithCodeBlocksAndLatex(text) {\n    const parts = [];\n    const elements = [];\n\n    // 1. 首先提取所有代码块\n    const codeBlockRegex = /```(\\w*)\\n([\\s\\S]*?)```/g;\n    let match;\n    let lastIndex = 0;\n\n    while ((match = codeBlockRegex.exec(text)) !== null) {\n      elements.push({\n        start: match.index,\n        end: match.index + match[0].length,\n        type: 'code',\n        language: match[1] || '',\n        content: match[2]\n      });\n    }\n\n    // 2. 提取块级LaTeX公式（$$...$$）\n    const latexBlockRegex = /\\$\\$([\\s\\S]*?)\\$\\$/g;\n    while ((match = latexBlockRegex.exec(text)) !== null) {\n      // 检查是否与代码块重叠\n      const overlaps = elements.some(el =>\n        (match.index >= el.start && match.index < el.end) ||\n        (match.index + match[0].length > el.start && match.index + match[0].length <= el.end)\n      );\n      if (!overlaps) {\n        elements.push({\n          start: match.index,\n          end: match.index + match[0].length,\n          type: 'latex-block',\n          content: match[1].trim()\n        });\n      }\n    }\n\n    // 3. 提取行内LaTeX公式（$...$，但不是$$）\n    const latexInlineRegex = /(?<!\\$)\\$(?!\\$)((?:\\\\.|[^$\\\\])+?)\\$(?!\\$)/g;\n    while ((match = latexInlineRegex.exec(text)) !== null) {\n      // 检查是否与已有元素重叠\n      const overlaps = elements.some(el =>\n        (match.index >= el.start && match.index < el.end) ||\n        (match.index + match[0].length > el.start && match.index + match[0].length <= el.end)\n      );\n      if (!overlaps) {\n        elements.push({\n          start: match.index,\n          end: match.index + match[0].length,\n          type: 'latex-inline',\n          content: match[1].trim()\n        });\n      }\n    }\n\n    // 4. 按位置排序所有元素\n    elements.sort((a, b) => a.start - b.start);\n\n    // 5. 构建最终的parts数组\n    lastIndex = 0;\n    elements.forEach(element => {\n      // 添加元素前的文本\n      if (element.start > lastIndex) {\n        const plainText = text.substring(lastIndex, element.start);\n        if (plainText.trim()) {\n          parts.push({ type: 'text', content: plainText });\n        }\n      }\n\n      // 添加元素本身\n      parts.push(element);\n      lastIndex = element.end;\n    });\n\n    // 添加最后的文本\n    if (lastIndex < text.length) {\n      const plainText = text.substring(lastIndex);\n      if (plainText.trim()) {\n        parts.push({ type: 'text', content: plainText });\n      }\n    }\n\n    // 如果没有特殊元素,返回整个文本\n    if (parts.length === 0) {\n      parts.push({ type: 'text', content: text });\n    }\n\n    return parts;\n  }\n\n  /**\n   * 解析文本中的代码块（旧方法，保留以兼容）\n   */\n  parseTextWithCodeBlocks(text) {\n    return this.parseTextWithCodeBlocksAndLatex(text);\n  }\n\n  /**\n   * 解析markdown格式的文本并渲染\n   * 支持：粗体、斜体、行内代码、链接、列表、引用等\n   */\n  renderMarkdownText(text, maxWidth) {\n    if (!text || text.trim().length === 0) {\n      this.currentY += PDF_STYLES.LINE_HEIGHT;\n      return;\n    }\n\n    const cleanedText = this.cleanText(text);\n    if (!cleanedText || cleanedText.trim().length === 0) {\n      this.currentY += PDF_STYLES.LINE_HEIGHT;\n      return;\n    }\n\n    // 按行处理文本\n    const lines = cleanedText.split('\\n');\n\n    lines.forEach(line => {\n      this.checkPageBreak(PDF_STYLES.FONT_SIZE_BODY);\n\n      // 处理不同类型的行\n      if (line.trim() === '') {\n        // 空行\n        this.currentY += PDF_STYLES.LINE_HEIGHT;\n      } else if (line.match(/^#{1,6}\\s/)) {\n        // 标题\n        this.renderMarkdownHeading(line, maxWidth);\n      } else if (line.match(/^>\\s/)) {\n        // 引用\n        this.renderMarkdownQuote(line, maxWidth);\n      } else if (line.match(/^[-*+]\\s/) || line.match(/^\\d+\\.\\s/)) {\n        // 列表\n        this.renderMarkdownList(line, maxWidth);\n      } else {\n        // 普通文本（可能包含行内格式）\n        this.renderMarkdownInlineFormats(line, maxWidth);\n      }\n    });\n  }\n\n  /**\n   * 渲染markdown标题\n   */\n  renderMarkdownHeading(line, maxWidth) {\n    const match = line.match(/^(#{1,6})\\s+(.+)$/);\n    if (!match) {\n      this.renderPlainText(line, maxWidth);\n      return;\n    }\n\n    const level = match[1].length;\n    const text = match[2];\n\n    // 根据标题级别设置字体大小\n    const fontSize = PDF_STYLES.FONT_SIZE_BODY + (7 - level) * 2;\n    const oldFontSize = this.pdf.internal.getFontSize();\n\n    this.pdf.setFontSize(fontSize);\n    // 使用粗体字体（如果可用）\n    this.safeSetFont(this.chineseFontName, 'bold');\n\n    try {\n      const lines = this.pdf.splitTextToSize(text, maxWidth);\n      lines.forEach(l => {\n        this.checkPageBreak(fontSize);\n        const cleanLine = this.cleanText(l);\n        if (cleanLine && cleanLine.trim().length > 0) {\n          this.pdf.text(cleanLine, PDF_STYLES.MARGIN_LEFT, this.currentY);\n        }\n        this.currentY += PDF_STYLES.LINE_HEIGHT * 1.2;\n      });\n    } catch (error) {\n      console.error('[PDF导出] 标题渲染失败:', error);\n      this.pdf.text(text, PDF_STYLES.MARGIN_LEFT, this.currentY);\n      this.currentY += PDF_STYLES.LINE_HEIGHT * 1.2;\n    }\n\n    // 恢复字体\n    this.pdf.setFontSize(oldFontSize);\n    this.safeSetFont(this.chineseFontName, 'normal');\n\n    this.currentY += PDF_STYLES.LINE_HEIGHT * 0.5; // 标题后额外间距\n  }\n\n  /**\n   * 渲染markdown引用\n   */\n  renderMarkdownQuote(line, maxWidth) {\n    const text = line.replace(/^>\\s*/, '');\n    const quoteWidth = maxWidth - 8;\n    const quoteX = PDF_STYLES.MARGIN_LEFT + 6;\n\n    // 绘制左侧竖线\n    this.pdf.setDrawColor(150, 150, 150);\n    this.pdf.setLineWidth(0.5);\n\n    const startY = this.currentY - 2;\n\n    // 渲染文本\n    this.pdf.setFontSize(PDF_STYLES.FONT_SIZE_BODY);\n    this.pdf.setTextColor(100, 100, 100);\n\n    try {\n      const lines = this.pdf.splitTextToSize(text, quoteWidth);\n      lines.forEach(l => {\n        this.checkPageBreak(PDF_STYLES.FONT_SIZE_BODY);\n        const cleanLine = this.cleanText(l);\n        if (cleanLine && cleanLine.trim().length > 0) {\n          this.pdf.text(cleanLine, quoteX, this.currentY);\n        }\n        this.currentY += PDF_STYLES.LINE_HEIGHT;\n      });\n\n      // 绘制引用线\n      this.pdf.line(\n        PDF_STYLES.MARGIN_LEFT + 2,\n        startY,\n        PDF_STYLES.MARGIN_LEFT + 2,\n        this.currentY - 2\n      );\n    } catch (error) {\n      console.error('[PDF导出] 引用渲染失败:', error);\n      this.pdf.text(text, quoteX, this.currentY);\n      this.currentY += PDF_STYLES.LINE_HEIGHT;\n    }\n\n    // 恢复颜色\n    this.pdf.setTextColor(...PDF_STYLES.COLOR_TEXT);\n  }\n\n  /**\n   * 渲染markdown列表\n   */\n  renderMarkdownList(line, maxWidth) {\n    let bullet = '';\n    let text = '';\n\n    // 检测列表类型\n    const unorderedMatch = line.match(/^([-*+])\\s+(.+)$/);\n    const orderedMatch = line.match(/^(\\d+)\\.\\s+(.+)$/);\n\n    if (unorderedMatch) {\n      bullet = '•'; // 使用圆点作为项目符号\n      text = unorderedMatch[2];\n    } else if (orderedMatch) {\n      bullet = orderedMatch[1] + '.';\n      text = orderedMatch[2];\n    } else {\n      this.renderPlainText(line, maxWidth);\n      return;\n    }\n\n    const bulletWidth = this.pdf.getTextWidth(bullet + '  ');\n    const textWidth = maxWidth - bulletWidth;\n    const textX = PDF_STYLES.MARGIN_LEFT + bulletWidth;\n\n    // 渲染项目符号\n    this.pdf.setFontSize(PDF_STYLES.FONT_SIZE_BODY);\n    this.pdf.text(bullet, PDF_STYLES.MARGIN_LEFT + 2, this.currentY);\n\n    // 渲染文本\n    try {\n      const lines = this.pdf.splitTextToSize(text, textWidth);\n      lines.forEach((l, idx) => {\n        if (idx > 0) {\n          this.checkPageBreak(PDF_STYLES.FONT_SIZE_BODY);\n        }\n        const cleanLine = this.cleanText(l);\n        if (cleanLine && cleanLine.trim().length > 0) {\n          this.pdf.text(cleanLine, textX, this.currentY);\n        }\n        this.currentY += PDF_STYLES.LINE_HEIGHT;\n      });\n    } catch (error) {\n      console.error('[PDF导出] 列表渲染失败:', error);\n      this.pdf.text(text, textX, this.currentY);\n      this.currentY += PDF_STYLES.LINE_HEIGHT;\n    }\n  }\n\n  /**\n   * 渲染包含行内格式的markdown文本\n   * 支持：**粗体**、*斜体*、`代码`、[链接](url)\n   */\n  renderMarkdownInlineFormats(line, maxWidth) {\n    if (!line || line.trim().length === 0) {\n      this.currentY += PDF_STYLES.LINE_HEIGHT;\n      return;\n    }\n\n    // 解析行内格式\n    const segments = this.parseInlineMarkdown(line);\n\n    // 按行渲染segments\n    this.renderInlineSegments(segments, maxWidth);\n  }\n\n  /**\n   * 解析行内markdown格式\n   * 返回格式化的文本片段数组\n   */\n  parseInlineMarkdown(text) {\n    const segments = [];\n    let currentPos = 0;\n\n    // 正则表达式模式（按优先级）\n    const patterns = [\n      { type: 'code', regex: /`([^`]+)`/g },              // 行内代码\n      { type: 'bold-italic', regex: /\\*\\*\\*(.+?)\\*\\*\\*/g }, // 粗斜体\n      { type: 'bold-italic', regex: /___(.+?)___/g },     // 粗斜体\n      { type: 'bold', regex: /\\*\\*(.+?)\\*\\*/g },          // 粗体\n      { type: 'bold', regex: /__(.+?)__/g },              // 粗体\n      { type: 'italic', regex: /\\*(.+?)\\*/g },            // 斜体\n      { type: 'italic', regex: /_(.+?)_/g },              // 斜体\n      { type: 'link', regex: /\\[([^\\]]+)\\]\\(([^)]+)\\)/g } // 链接\n    ];\n\n    // 查找所有匹配\n    const matches = [];\n    patterns.forEach(pattern => {\n      let match;\n      const regex = new RegExp(pattern.regex.source, 'g');\n      while ((match = regex.exec(text)) !== null) {\n        matches.push({\n          type: pattern.type,\n          start: match.index,\n          end: regex.lastIndex,\n          text: match[1],\n          url: match[2] // 仅用于链接\n        });\n      }\n    });\n\n    // 按位置排序\n    matches.sort((a, b) => a.start - b.start);\n\n    // 移除重叠的匹配（保留最外层）\n    const filteredMatches = [];\n    matches.forEach(match => {\n      const overlaps = filteredMatches.some(existing =>\n        (match.start >= existing.start && match.start < existing.end) ||\n        (match.end > existing.start && match.end <= existing.end)\n      );\n      if (!overlaps) {\n        filteredMatches.push(match);\n      }\n    });\n\n    // 构建segments数组\n    let lastEnd = 0;\n    filteredMatches.forEach(match => {\n      // 添加普通文本\n      if (match.start > lastEnd) {\n        segments.push({\n          type: 'normal',\n          text: text.substring(lastEnd, match.start)\n        });\n      }\n\n      // 添加格式化文本\n      segments.push({\n        type: match.type,\n        text: match.text,\n        url: match.url\n      });\n\n      lastEnd = match.end;\n    });\n\n    // 添加剩余文本\n    if (lastEnd < text.length) {\n      segments.push({\n        type: 'normal',\n        text: text.substring(lastEnd)\n      });\n    }\n\n    // 如果没有匹配，返回整个文本\n    if (segments.length === 0) {\n      segments.push({\n        type: 'normal',\n        text: text\n      });\n    }\n\n    return segments;\n  }\n\n  /**\n   * 渲染行内格式的文本片段\n   */\n  renderInlineSegments(segments, maxWidth) {\n    let currentX = PDF_STYLES.MARGIN_LEFT;\n    let currentLineText = '';\n    let currentLineSegments = [];\n\n    segments.forEach((segment, idx) => {\n      const text = this.cleanText(segment.text || '');\n      if (!text) return;\n\n      // 设置样式并测量宽度\n      this.applySegmentStyle(segment.type);\n      const textWidth = this.pdf.getTextWidth(text);\n\n      // 检查是否需要换行\n      if (currentX + textWidth > PDF_STYLES.PAGE_WIDTH - PDF_STYLES.MARGIN_RIGHT && currentLineSegments.length > 0) {\n        // 渲染当前行\n        this.renderSegmentLine(currentLineSegments);\n        this.currentY += PDF_STYLES.LINE_HEIGHT;\n        this.checkPageBreak(PDF_STYLES.FONT_SIZE_BODY);\n\n        // 重置行状态\n        currentX = PDF_STYLES.MARGIN_LEFT;\n        currentLineSegments = [];\n      }\n\n      // 添加到当前行\n      currentLineSegments.push({\n        ...segment,\n        x: currentX,\n        text: text\n      });\n      currentX += textWidth;\n    });\n\n    // 渲染最后一行\n    if (currentLineSegments.length > 0) {\n      this.renderSegmentLine(currentLineSegments);\n      this.currentY += PDF_STYLES.LINE_HEIGHT;\n    }\n\n    // 恢复默认样式\n    this.pdf.setFont(this.chineseFontName, 'normal');\n    this.pdf.setTextColor(...PDF_STYLES.COLOR_TEXT);\n  }\n\n  /**\n   * 渲染一行segment\n   */\n  renderSegmentLine(segments) {\n    segments.forEach(segment => {\n      this.applySegmentStyle(segment.type);\n\n      if (segment.type === 'link') {\n        // 渲染链接（添加下划线）\n        this.pdf.textWithLink(segment.text, segment.x, this.currentY, {\n          url: segment.url || '#'\n        });\n        // 绘制下划线\n        const textWidth = this.pdf.getTextWidth(segment.text);\n        this.pdf.line(segment.x, this.currentY + 0.5, segment.x + textWidth, this.currentY + 0.5);\n      } else if (segment.type === 'code') {\n        // 渲染行内代码（添加背景色）\n        const textWidth = this.pdf.getTextWidth(segment.text);\n        const padding = 1;\n        this.pdf.setFillColor(245, 245, 245);\n        this.pdf.rect(segment.x - padding, this.currentY - 3, textWidth + padding * 2, 4, 'F');\n        this.pdf.setTextColor(220, 50, 50);\n        this.pdf.text(segment.text, segment.x, this.currentY);\n      } else {\n        // 普通文本\n        this.pdf.text(segment.text, segment.x, this.currentY);\n      }\n    });\n  }\n\n  /**\n   * 应用segment样式\n   */\n  applySegmentStyle(type) {\n    this.pdf.setFontSize(PDF_STYLES.FONT_SIZE_BODY);\n    this.pdf.setTextColor(...PDF_STYLES.COLOR_TEXT);\n\n    switch (type) {\n      case 'bold':\n        // 使用粗体字体（如果可用，否则自动回退）\n        this.safeSetFont(this.chineseFontName, 'bold');\n        break;\n      case 'italic':\n        // 使用斜体字体（如果可用，否则回退到 light 或 normal）\n        // 同时设置颜色以区分\n        const italicSuccess = this.safeSetFont(this.chineseFontName, 'italic');\n        if (!italicSuccess) {\n          // 如果没有斜体，用颜色区分\n          this.pdf.setTextColor(70, 130, 180); // 蓝色表示强调\n        }\n        break;\n      case 'bold-italic':\n        // 粗斜体：尝试使用 bold，如果没有则用 normal + 颜色\n        const boldItalicSuccess = this.safeSetFont(this.chineseFontName, 'bolditalic');\n        if (!boldItalicSuccess) {\n          // 回退：使用 bold（如果有）+ 颜色\n          this.safeSetFont(this.chineseFontName, 'bold');\n          this.pdf.setTextColor(70, 130, 180); // 蓝色表示斜体\n        }\n        break;\n      case 'code':\n        this.pdf.setFont('courier', 'normal');\n        this.pdf.setFontSize(PDF_STYLES.FONT_SIZE_CODE);\n        this.pdf.setTextColor(220, 50, 50);\n        break;\n      case 'link':\n        this.safeSetFont(this.chineseFontName, 'normal');\n        this.pdf.setTextColor(0, 102, 204); // 蓝色\n        break;\n      default:\n        this.safeSetFont(this.chineseFontName, 'normal');\n    }\n  }\n\n  /**\n   * 将LaTeX命令转换为Unicode数学符号\n   * 这使得PDF中的数学公式更易读\n   */\n  convertLatexToUnicode(latex) {\n    if (!latex) return '';\n\n    let result = latex;\n\n    // 希腊字母\n    const greekLetters = {\n      '\\\\alpha': 'α', '\\\\Alpha': 'Α',\n      '\\\\beta': 'β', '\\\\Beta': 'Β',\n      '\\\\gamma': 'γ', '\\\\Gamma': 'Γ',\n      '\\\\delta': 'δ', '\\\\Delta': 'Δ',\n      '\\\\epsilon': 'ε', '\\\\Epsilon': 'Ε',\n      '\\\\varepsilon': 'ε',\n      '\\\\zeta': 'ζ', '\\\\Zeta': 'Ζ',\n      '\\\\eta': 'η', '\\\\Eta': 'Η',\n      '\\\\theta': 'θ', '\\\\Theta': 'Θ',\n      '\\\\vartheta': 'ϑ',\n      '\\\\iota': 'ι', '\\\\Iota': 'Ι',\n      '\\\\kappa': 'κ', '\\\\Kappa': 'Κ',\n      '\\\\lambda': 'λ', '\\\\Lambda': 'Λ',\n      '\\\\mu': 'μ', '\\\\Mu': 'Μ',\n      '\\\\nu': 'ν', '\\\\Nu': 'Ν',\n      '\\\\xi': 'ξ', '\\\\Xi': 'Ξ',\n      '\\\\omicron': 'ο', '\\\\Omicron': 'Ο',\n      '\\\\pi': 'π', '\\\\Pi': 'Π',\n      '\\\\rho': 'ρ', '\\\\Rho': 'Ρ',\n      '\\\\sigma': 'σ', '\\\\Sigma': 'Σ',\n      '\\\\tau': 'τ', '\\\\Tau': 'Τ',\n      '\\\\upsilon': 'υ', '\\\\Upsilon': 'Υ',\n      '\\\\phi': 'φ', '\\\\Phi': 'Φ',\n      '\\\\varphi': 'ϕ',\n      '\\\\chi': 'χ', '\\\\Chi': 'Χ',\n      '\\\\psi': 'ψ', '\\\\Psi': 'Ψ',\n      '\\\\omega': 'ω', '\\\\Omega': 'Ω'\n    };\n\n    // 数学运算符和符号\n    const mathSymbols = {\n      // 关系符号\n      '\\\\leq': '≤', '\\\\le': '≤',\n      '\\\\geq': '≥', '\\\\ge': '≥',\n      '\\\\neq': '≠', '\\\\ne': '≠',\n      '\\\\approx': '≈',\n      '\\\\equiv': '≡',\n      '\\\\sim': '∼',\n      '\\\\simeq': '≃',\n      '\\\\cong': '≅',\n      '\\\\propto': '∝',\n      '\\\\ll': '≪',\n      '\\\\gg': '≫',\n      '\\\\subset': '⊂',\n      '\\\\supset': '⊃',\n      '\\\\subseteq': '⊆',\n      '\\\\supseteq': '⊇',\n      '\\\\in': '∈',\n      '\\\\notin': '∉',\n      '\\\\ni': '∋',\n      '\\\\emptyset': '∅',\n\n      // 箭头\n      '\\\\rightarrow': '→', '\\\\to': '→',\n      '\\\\leftarrow': '←',\n      '\\\\leftrightarrow': '↔',\n      '\\\\Rightarrow': '⇒',\n      '\\\\Leftarrow': '⇐',\n      '\\\\Leftrightarrow': '⇔',\n      '\\\\uparrow': '↑',\n      '\\\\downarrow': '↓',\n      '\\\\mapsto': '↦',\n\n      // 运算符\n      '\\\\times': '×',\n      '\\\\div': '÷',\n      '\\\\pm': '±',\n      '\\\\mp': '∓',\n      '\\\\cdot': '·',\n      '\\\\ast': '∗',\n      '\\\\star': '⋆',\n      '\\\\circ': '∘',\n      '\\\\bullet': '•',\n      '\\\\oplus': '⊕',\n      '\\\\ominus': '⊖',\n      '\\\\otimes': '⊗',\n      '\\\\odot': '⊙',\n      '\\\\oslash': '⊘',\n      '\\\\cup': '∪',\n      '\\\\cap': '∩',\n      '\\\\vee': '∨',\n      '\\\\wedge': '∧',\n\n      // 微积分\n      '\\\\partial': '∂',\n      '\\\\nabla': '∇',\n      '\\\\infty': '∞',\n      '\\\\int': '∫',\n      '\\\\iint': '∬',\n      '\\\\iiint': '∭',\n      '\\\\oint': '∮',\n      '\\\\sum': '∑',\n      '\\\\prod': '∏',\n      '\\\\coprod': '∐',\n\n      // 逻辑符号\n      '\\\\forall': '∀',\n      '\\\\exists': '∃',\n      '\\\\nexists': '∄',\n      '\\\\neg': '¬',\n      '\\\\lnot': '¬',\n      '\\\\land': '∧',\n      '\\\\lor': '∨',\n      '\\\\implies': '⇒',\n      '\\\\iff': '⇔',\n\n      // 其他符号\n      '\\\\angle': '∠',\n      '\\\\degree': '°',\n      '\\\\prime': '′',\n      '\\\\dprime': '″',\n      '\\\\infty': '∞',\n      '\\\\aleph': 'ℵ',\n      '\\\\hbar': 'ℏ',\n      '\\\\ell': 'ℓ',\n      '\\\\wp': '℘',\n      '\\\\Re': 'ℜ',\n      '\\\\Im': 'ℑ',\n      '\\\\bot': '⊥',\n      '\\\\top': '⊤',\n      '\\\\perp': '⊥',\n      '\\\\parallel': '∥',\n      '\\\\triangle': '△',\n      '\\\\square': '□',\n      '\\\\checkmark': '✓',\n\n      // 特殊函数和文本\n      '\\\\dots': '…',\n      '\\\\ldots': '…',\n      '\\\\cdots': '⋯',\n      '\\\\vdots': '⋮',\n      '\\\\ddots': '⋱',\n\n      // 括号（虽然通常不需要转换，但有些特殊情况）\n      '\\\\langle': '⟨',\n      '\\\\rangle': '⟩',\n      '\\\\lfloor': '⌊',\n      '\\\\rfloor': '⌋',\n      '\\\\lceil': '⌈',\n      '\\\\rceil': '⌉',\n    };\n\n    // 上下标简化处理\n    // 将 ^{...} 和 _{...} 简化为 ^(...) 和 _(...) 以便阅读\n    result = result.replace(/\\^{([^}]+)}/g, '^($1)');\n    result = result.replace(/_{([^}]+)}/g, '_($1)');\n\n    // 分数简化\n    result = result.replace(/\\\\frac{([^}]+)}{([^}]+)}/g, '($1)/($2)');\n\n    // 平方根\n    result = result.replace(/\\\\sqrt{([^}]+)}/g, '√($1)');\n    result = result.replace(/\\\\sqrt\\[(\\d+)\\]{([^}]+)}/g, '[$1]√($2)');\n\n    // 替换希腊字母\n    Object.keys(greekLetters).forEach(latex => {\n      const regex = new RegExp(latex.replace(/\\\\/g, '\\\\\\\\'), 'g');\n      result = result.replace(regex, greekLetters[latex]);\n    });\n\n    // 替换数学符号\n    Object.keys(mathSymbols).forEach(latex => {\n      const regex = new RegExp(latex.replace(/\\\\/g, '\\\\\\\\'), 'g');\n      result = result.replace(regex, mathSymbols[latex]);\n    });\n\n    // 移除常见的LaTeX命令（保留内容）\n    result = result.replace(/\\\\text{([^}]+)}/g, '$1');\n    result = result.replace(/\\\\mathrm{([^}]+)}/g, '$1');\n    result = result.replace(/\\\\mathbf{([^}]+)}/g, '$1');\n    result = result.replace(/\\\\mathit{([^}]+)}/g, '$1');\n    result = result.replace(/\\\\mathcal{([^}]+)}/g, '$1');\n    result = result.replace(/\\\\mathbb{([^}]+)}/g, '$1');\n\n    // 移除对齐和换行命令\n    result = result.replace(/\\\\\\\\(?:\\[[^\\]]*\\])?/g, '\\n');\n    result = result.replace(/&/g, ' ');\n\n    // 移除空格命令\n    result = result.replace(/\\\\,/g, ' ');\n    result = result.replace(/\\\\;/g, ' ');\n    result = result.replace(/\\\\quad/g, '  ');\n    result = result.replace(/\\\\qquad/g, '    ');\n    result = result.replace(/\\\\ /g, ' ');\n\n    // 移除多余的花括号\n    result = result.replace(/{([^{}]+)}/g, '$1');\n\n    // 清理多余空格\n    result = result.replace(/\\s+/g, ' ').trim();\n\n    return result;\n  }\n\n  /**\n   * 生成文件名\n   */\n  generateFileName(meta) {\n    const date = DateTimeUtils.getCurrentDate();\n    const cleanTitle = (meta.name || 'conversation').replace(/[^a-zA-Z0-9\\u4e00-\\u9fa5]/g, '_');\n    return `${cleanTitle}_${date}.pdf`;\n  }\n\n  /**\n   * 获取平台前缀\n   */\n  getPlatformPrefix(platform) {\n    const platformLower = (platform || '').toLowerCase();\n\n    if (platformLower.includes('chatgpt')) return 'chatgpt';\n    if (platformLower.includes('gemini')) return 'gemini';\n    if (platformLower.includes('notebooklm')) return 'notebooklm';\n    if (platformLower.includes('aistudio')) return 'aistudio';\n    if (platformLower.includes('sillytavern')) return 'sillytavern';\n\n    return 'claude';\n  }\n}\n\n// 导出单例实例\nexport const pdfExportManager = new PDFExportManager();\n"],"names":["FontCache","DB_NAME","STORE_NAME","DB_VERSION","status","isLoading","isLoaded","error","progress","cachedFont","openDB","Promise","resolve","reject","request","indexedDB","open","this","onerror","onsuccess","result","onupgradeneeded","event","db","target","objectStoreNames","contains","createObjectStore","keyPath","getFromCache","fontId","transaction","objectStore","get","console","warn","saveToCache","fontData","put","id","data","timestamp","Date","now","isCached","cached","undefined","CDN_FONT_CONFIG","SYSTEM_FONTS","windows","name","family","macos","ios","android","fallback","detectOS","_navigator$platform","userAgent","navigator","toLowerCase","platform","test","isFontAvailable","fontFamily","context","document","createElement","getContext","testString","fontSize","font","concat","defaultWidth","measureText","width","getAvailableSystemFont","os","log","fontsToCheck","fontName","SYSTEM_FONT_PATHS","linux","async","addChineseFontSupport","pdf","systemFont","systemFontLoaded","fontConfig","paths","length","fontPath","response","fetch","catch","ok","arrayBuffer","magic","DataView","getUint32","bytes","Uint8Array","binary","chunkSize","i","byteLength","chunk","subarray","Math","min","String","fromCharCode","apply","base64","btoa","fileName","split","pop","addFileToVFS","addFont","setFont","availableWeights","loadSystemFont","success","isSystemFont","systemFontInfo","isCDNFont","fontNotReady","PDF_STYLES","FONT_SIZE_TITLE","FONT_SIZE_H1","FONT_SIZE_H2","FONT_SIZE_SENDER","FONT_SIZE_BODY","FONT_SIZE_CODE","FONT_SIZE_TIMESTAMP","FONT_SIZE_HEADER","FONT_SIZE_FOOTER","COLOR_SENDER_HUMAN","COLOR_SENDER_ASSISTANT","COLOR_TIMESTAMP","COLOR_CODE_BG","COLOR_SECTION_BG","COLOR_TEXT","COLOR_HEADER","COLOR_FOOTER","COLOR_BORDER","MARGIN_LEFT","MARGIN_RIGHT","MARGIN_TOP","MARGIN_BOTTOM","LINE_HEIGHT","SECTION_SPACING","MESSAGE_SPACING","FOOTER_HEIGHT","PAGE_WIDTH","PAGE_HEIGHT","PDFExportManager","constructor","currentY","config","useChineseFont","chineseFontName","availableFontWeights","meta","exportDate","messageAnchors","safeSetFont","fontStyle","arguments","includes","fallbackStyle","cleanText","text","cleaned","normalize","replace","exportToPDF","messages","_config$includeThinki","_config$includeArtifa","_config$includeTimest","_config$includeTools","_config$includeCitati","_config$highQuality","messageCount","errorMessage","Error","DateTimeUtils","formatDateTime","_objectSpread","includeThinking","includeArtifacts","includeTimestamps","includeTools","includeCitations","highQuality","jsPDF","orientation","unit","format","compress","fontLoadResult","fontType","join","systemFontAvailable","renderTitle","renderMetadata","hasTOC","tocPageNumber","addPage","internal","getCurrentPageInfo","pageNumber","renderMessage","renderTOCWithLinks","addBookmarks","addFooters","generateFileName","save","setFontSize","setTextColor","rawTitle","title","maxWidth","titleLines","splitTextToSize","forEach","line","checkPageBreak","cleanLine","trim","lines","push","created_at","updated_at","tocPage","setPage","setDrawColor","setLineWidth","anchor","idx","_message$branchInfo","message","messageNumber","index","sender","preview","substring","branchMarker","branchInfo","isBranchPoint","childCount","entry","pageNum","page","color","pageNumWidth","getTextWidth","pageNumX","entryY","textWithLink","_message$attachments","_message$artifacts","_message$tools","_message$citations","currentPage","y","display_text","renderSender","renderTimestamp","thinking","renderThinking","renderBody","attachments","renderAttachments","artifacts","artifact","renderArtifact","tools","tool","renderTool","citations","renderCitations","_message$branchInfo2","senderLabel","label","finalLabel","cleanLabel","parseTextWithCodeBlocksAndLatex","part","type","renderCodeBlock","content","language","renderLatexBlock","renderLatexInline","renderMarkdownText","renderPlainText","cleanedText","code","codeWidth","cleanCode","cleanLanguage","labelText","toUpperCase","labelWidth","setFillColor","roundedRect","codeLines","wrappedLines","lineNumber","wLine","blockStartY","blockStartPage","isFirstLine","firstPageHeight","padding","rect","_ref","currentPageBottom","remainingLines","newPageHeight","lineNumStr","padStart","safeLine","endPage","isFirst","isLast","boxStartY","boxEndY","groupCodeLinesByPage","groups","currentGroup","bottomLimit","simulatedY","simulatedPage","startY","latex","cleanLatex","renderedLatex","convertLatexToUnicode","formulaLines","groupLatexLinesByPage","formulaText","renderSection","JSON","stringify","input","output","map","cit","url","att","file_name","file_type","bgColor","cleanTitle","cleanContent","contentLines","bgHeight","renderFooter","totalPages","originalY","originalFontSize","getFontSize","footerY","exportText","pageText","pageTextWidth","outline","add","getNumberOfPages","requiredSpace","parts","elements","codeBlockRegex","match","lastIndex","exec","start","end","latexBlockRegex","some","el","latexInlineRegex","sort","a","b","element","plainText","parseTextWithCodeBlocks","renderMarkdownHeading","renderMarkdownQuote","renderMarkdownList","renderMarkdownInlineFormats","level","oldFontSize","l","quoteWidth","quoteX","bullet","unorderedMatch","orderedMatch","bulletWidth","textWidth","textX","segments","parseInlineMarkdown","renderInlineSegments","matches","regex","pattern","RegExp","source","filteredMatches","existing","lastEnd","currentX","currentLineSegments","segment","applySegmentStyle","renderSegmentLine","x","greekLetters","mathSymbols","Object","keys","date","getCurrentDate","getPlatformPrefix","platformLower"],"sourceRoot":""}