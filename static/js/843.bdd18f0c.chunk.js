"use strict";(self.webpackChunklyra_exporter=self.webpackChunklyra_exporter||[]).push([[843],{843:(t,e,n)=>{n.d(e,{handleExport:()=>u});var i=n(555),a=n(224),o=n(144),r=n(529),s=(n(362),n(185));const c={includeThinking:!0,includeTools:!0,includeArtifacts:!0,includeCitations:!0,includeAttachments:!0,includeTimestamps:!1,exportObsidianMetadata:!1,exportMarkedOnly:!1,excludeDeleted:!0,includeCompleted:!1,includeImportant:!1,obsidianProperties:[],obsidianTags:[]};class l{constructor(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};this.config=(0,i.A)((0,i.A)({},c),t)}generate(t){return[this.generateMetadata(t),this.generateHeader(t),this.generateMessages(t),this.generateFooter(t)].filter(Boolean).join("\n")}generateMetadata(t){var e,n,i;if(!this.config.exportObsidianMetadata)return"";const o=["---","title: ".concat((null===(e=t.meta_info)||void 0===e?void 0:e.title)||"\u5bf9\u8bdd\u8bb0\u5f55"),"date: ".concat(a.Nq.getCurrentDate()),"export_time: ".concat(a.Nq.formatDateTime(new Date))];return(null===(n=this.config.obsidianProperties)||void 0===n?void 0:n.length)>0&&this.config.obsidianProperties.forEach(t=>{if(t.value.includes(",")){const e=t.value.split(",").map(t=>t.trim());o.push("".concat(t.name,":")),e.forEach(t=>o.push("  - ".concat(t)))}else o.push("".concat(t.name,": ").concat(t.value))}),(null===(i=this.config.obsidianTags)||void 0===i?void 0:i.length)>0&&(o.push("tags:"),this.config.obsidianTags.forEach(t=>o.push("  - ".concat(t)))),o.push("---",""),o.join("\n")}generateHeader(t){const{meta_info:e={}}=t,n=["# ".concat(e.title||"\u5bf9\u8bdd\u8bb0\u5f55"),"*\u521b\u5efa\u65f6\u95f4: ".concat(e.created_at||"\u672a\u77e5","*"),"*\u5bfc\u51fa\u65f6\u95f4: ".concat(a.Nq.formatDateTime(new Date),"*")];if(this.config.excludeDeleted||this.config.includeCompleted||this.config.includeImportant){const t=this.getFilterDescription();t&&n.push("*\u7b5b\u9009\u6761\u4ef6: ".concat(t,"*"))}return n.push("","---",""),n.join("\n")}generateMessages(t){const{chat_history:e=[]}=t,n=this.filterMessages(e);return 0===n.length?"*\u6ca1\u6709\u7b26\u5408\u6761\u4ef6\u7684\u6d88\u606f*\n":n.map((t,e)=>this.formatMessage(t,e+1)).join("\n---\n\n")}generateFooter(t){const{chat_history:e=[]}=t,n=this.filterMessages(e),i=e.length;return n.length<i?"\n*\u6839\u636e\u7b5b\u9009\u6761\u4ef6\uff0c\u4ece ".concat(i," \u6761\u6d88\u606f\u4e2d\u5bfc\u51fa\u4e86 ").concat(n.length," \u6761\u6d88\u606f*"):""}filterMessages(t){let e=[...t];const n=this.config.marks||{completed:new Set,important:new Set,deleted:new Set};return this.config.excludeDeleted&&(e=e.filter(t=>!n.deleted.has(t.index))),this.config.includeCompleted&&!this.config.includeImportant&&(e=e.filter(t=>n.completed.has(t.index))),this.config.includeImportant&&!this.config.includeCompleted&&(e=e.filter(t=>n.important.has(t.index))),this.config.includeCompleted&&this.config.includeImportant&&(e=e.filter(t=>n.completed.has(t.index)&&n.important.has(t.index))),e}formatMessage(t,e){var n,i,a,o;const r=[],s=this.getBranchMarker(t),c=this.formatMessageTitle(t,e,s);r.push(c),this.config.includeTimestamps&&t.timestamp&&r.push("*".concat(t.timestamp,"*")),r.push("");const l=this.config.thinkingFormat||"codeblock";return t.thinking&&this.config.includeThinking&&"human"!==t.sender&&("codeblock"===l||"xml"===l)&&r.push(this.formatThinking(t.thinking)),t.display_text&&r.push(t.display_text,""),(null===(n=t.attachments)||void 0===n?void 0:n.length)>0&&this.config.includeAttachments&&"human"===t.sender&&r.push(this.formatAttachments(t.attachments)),t.thinking&&this.config.includeThinking&&"human"!==t.sender&&"emoji"===l&&r.push(this.formatThinking(t.thinking)),(null===(i=t.artifacts)||void 0===i?void 0:i.length)>0&&this.config.includeArtifacts&&"human"!==t.sender&&t.artifacts.forEach(t=>{r.push(this.formatArtifact(t))}),(null===(a=t.tools)||void 0===a?void 0:a.length)>0&&this.config.includeTools&&t.tools.forEach(t=>{r.push(this.formatTool(t))}),(null===(o=t.citations)||void 0===o?void 0:o.length)>0&&this.config.includeCitations&&r.push(this.formatCitations(t.citations)),r.join("\n")}formatThinking(t){switch(this.config.thinkingFormat||"codeblock"){case"codeblock":return["```thinking",t,"```",""].join("\n");case"xml":return["<anthropic_thinking>",t,"</anthropic_thinking>",""].join("\n");default:return["\ud83d\udcad \u601d\u8003\u8fc7\u7a0b:","```",t,"```",""].join("\n")}}formatAttachments(t){const e=["<details>","<summary>\ud83d\udcce \u9644\u52a0\u6587\u4ef6</summary>",""];return t.forEach(t=>{const n=this.formatFileSize(t.file_size);if(e.push("- **".concat(t.file_name,"** (").concat(n,")")),t.file_type&&e.push("  - \u7c7b\u578b: ".concat(t.file_type)),t.extracted_content){const n=t.extracted_content.substring(0,200),i=n.length<t.extracted_content.length?"".concat(n,"..."):n;e.push("  - \u5185\u5bb9\u9884\u89c8: ".concat(i))}}),e.push("","</details>",""),e.join("\n")}formatFileSize(t){if(0===t)return"0 Bytes";const e=Math.floor(Math.log(t)/Math.log(1024));return parseFloat((t/Math.pow(1024,e)).toFixed(2))+" "+["Bytes","KB","MB","GB"][e]}formatArtifact(t){const e=["<details>","<summary>\ud83d\udd27 Artifact: ".concat(t.title||"\u65e0\u6807\u9898","</summary>"),"","**\u7c7b\u578b**: `".concat(t.type||"\u672a\u77e5","`"),""];return"create"===t.command&&t.content&&(t.language&&e.push("**\u8bed\u8a00**: `".concat(t.language,"`")),e.push("","**\u5185\u5bb9**:"),e.push("```".concat(t.language||"")),e.push(t.content),e.push("```")),e.push("</details>",""),e.join("\n")}formatTool(t){var e;const n=["<details>","<summary>\ud83d\udd0d \u5de5\u5177: ".concat(t.name,"</summary>"),""];return t.query&&n.push("**\u641c\u7d22\u67e5\u8be2**: `".concat(t.query,"`"),""),null!==(e=t.result)&&void 0!==e&&e.content&&"web_search"===t.name&&(n.push("**\u641c\u7d22\u7ed3\u679c**:",""),t.result.content.slice(0,5).forEach((t,e)=>{n.push("".concat(e+1,". [").concat(t.title||"\u65e0\u6807\u9898","](").concat(t.url||"#",")"))})),n.push("</details>",""),n.join("\n")}formatCitations(t){const e=["<details>","<summary>\ud83d\udcce \u5f15\u7528\u6765\u6e90</summary>","","| \u6807\u9898 | \u6765\u6e90 |","| --- | --- |"];return t.forEach(t=>{const n=t.title||"\u672a\u77e5\u6765\u6e90",i=t.url||"#",a=i.includes("/")?i.split("/")[2]:"\u672a\u77e5\u7f51\u7ad9";e.push("| [".concat(n,"](").concat(i,") | ").concat(a," |"))}),e.push("</details>",""),e.join("\n")}getBranchMarker(t){return t.is_branch_point?" \ud83d\udd00":t.branch_level>0?" \u21b3".concat(t.branch_level):""}formatMessageTitle(t,e,n){let i="";if(this.config.includeHeaderPrefix&&(i+="#".repeat(this.config.headerLevel||2)+" "),this.config.includeNumbering){const t=this.config.numberingFormat||"numeric";"numeric"===t?i+="".concat(e,". "):"letter"===t?i+="".concat(this.toExcelColumn(e),". "):"roman"===t&&(i+="".concat(this.toRoman(e),". "))}return i+=this.getSenderLabel(t)+n,i}getSenderLabel(t){const e="human"===t.sender||"\u4eba\u7c7b"===t.sender_label||"Human"===t.sender_label;return this.config.humanLabel&&this.config.assistantLabel?e?this.config.humanLabel:this.config.assistantLabel:t.sender_label||(e?"\u4eba\u7c7b":"Claude")}toExcelColumn(t){let e="";for(;t>0;)t--,e=String.fromCharCode(65+t%26)+e,t=Math.floor(t/26);return e}toRoman(t){if(t<=0||t>=4e3)return t.toString();const e=[1e3,900,500,400,100,90,50,40,10,9,5,4,1],n=["M","CM","D","CD","C","XC","L","XL","X","IX","V","IV","I"];let i="";for(let a=0;a<e.length;a++)for(;t>=e[a];)i+=n[a],t-=e[a];return i}getFilterDescription(){const t=[];return this.config.excludeDeleted&&t.push("\u6392\u9664\u5df2\u5220\u9664"),this.config.includeCompleted&&this.config.includeImportant?t.push("\u4ec5\u5df2\u5b8c\u6210\u4e14\u91cd\u8981\u7684\u6d88\u606f"):this.config.includeCompleted?t.push("\u4ec5\u5df2\u5b8c\u6210\u7684\u6d88\u606f"):this.config.includeImportant&&t.push("\u4ec5\u91cd\u8981\u7684\u6d88\u606f"),t.join("\uff0c")}}class h{static saveTextFile(t,e){try{const n=new Blob([t],{type:"text/markdown;charset=utf-8"}),i=URL.createObjectURL(n),a=document.createElement("a");return a.href=i,a.download=e,document.body.appendChild(a),a.click(),document.body.removeChild(a),URL.revokeObjectURL(i),!0}catch(n){return console.error("\u4fdd\u5b58\u6587\u4ef6\u5931\u8d25:",n),alert("\u4fdd\u5b58\u6587\u4ef6\u5931\u8d25\uff0c\u8bf7\u91cd\u8bd5"),!1}}static async exportSingleFile(t){const e=new l(arguments.length>1&&void 0!==arguments[1]?arguments[1]:{}).generate(t),n=this.generateFileName(t,"single");return this.saveTextFile(e,n)}static async exportMultipleFiles(t){let e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};const n=t.map((t,n)=>{const a=(0,i.A)((0,i.A)({},e),{},{marks:{completed:new Set,important:new Set,deleted:new Set}});return new l(a).generate(t)}).join("\n\n---\n---\n\n"),a=this.generateFileName(null,"multiple");return this.saveTextFile(n,a)}static generateFileName(t){var e;let n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"single";const i=a.Nq.getCurrentDate();if("single"===n&&null!==t&&void 0!==t&&null!==(e=t.meta_info)&&void 0!==e&&e.title){const e=t.meta_info.title.replace(/[^a-zA-Z0-9\u4e00-\u9fa5]/g,"_");return"".concat(e,"_").concat(i,".md")}return"export_".concat(i,".md")}}async function u(t){let{exportOptions:e,processedData:n,sortManagerRef:c,sortedMessages:l,markManagerRef:u,currentBranchState:d,operatedFiles:m,files:g,currentFileIndex:f}=t;try{const t=a.bu.getLocalStorage("export-config",{includeNumbering:!0,numberingFormat:"numeric",senderFormat:"default",humanLabel:"\u4eba\u7c7b",assistantLabel:"Claude",includeHeaderPrefix:!0,headerLevel:2});let f=[];switch(e.scope){case"current":if(n){var p;const t=null!==c&&void 0!==c&&null!==(p=c.current)&&void 0!==p&&p.hasCustomSort()?l:n.chat_history||[];f=[(0,i.A)((0,i.A)({},n),{},{chat_history:t})]}break;case"currentBranch":if(n&&d&&!d.showAllBranches){var v;let t=n.chat_history||[];d.currentBranchIndexes&&d.currentBranchIndexes.size>0&&(t=t.filter(t=>{if(!t.is_branch_point)return!0;const e=d.currentBranchIndexes.get(t.uuid);return void 0===e||(t.branch_id===e||null===t.branch_id)}));const e=null!==c&&void 0!==c&&null!==(v=c.current)&&void 0!==v&&v.hasCustomSort()?c.current.getSortedMessages().filter(e=>t.some(t=>t.uuid===e.uuid)):t;f=[(0,i.A)((0,i.A)({},n),{},{chat_history:e})]}break;case"operated":const t=new Set;for(const e of m){const n=(0,o.Xw)(e);let a=-1,c=!1,l=null;if(n.conversationUuid?(c=!0,l=n.conversationUuid,a=n.fileIndex):a=g.findIndex((t,n)=>(0,o.zj)(n,t)===e||e.includes((0,o.wr)(t))),-1!==a&&!t.has(a)){const n=g[a];try{const h=await n.text(),u=JSON.parse(h);let d=(0,r.uE)(u,n.name);if(d=(0,r.IQ)(d),"claude_full_export"===d.format&&c&&l){var _,x;const t=null===(_=d.views)||void 0===_||null===(x=_.conversationList)||void 0===x?void 0:x.find(t=>t.uuid===l);if(t){var b;const e=(null===(b=d.chat_history)||void 0===b?void 0:b.filter(t=>t.conversation_uuid===l&&!t.is_conversation_header))||[],r=(0,o.mE)(a,l,n),c=new s.k(e,r).getSortedMessages();f.push((0,i.A)((0,i.A)({},d),{},{meta_info:(0,i.A)((0,i.A)({},d.meta_info),{},{title:t.name||"\u672a\u547d\u540d\u5bf9\u8bdd"}),chat_history:c,views:{conversationList:[t]}}))}}else{const n=new s.k(d.chat_history||[],e).getSortedMessages();f.push((0,i.A)((0,i.A)({},d),{},{chat_history:n})),t.add(a)}}catch(y){console.error("\u65e0\u6cd5\u5904\u7406\u6587\u4ef6 ".concat(n.name,":"),y)}}}break;case"all":for(let e=0;e<g.length;e++){const t=g[e];try{const n=await t.text(),a=JSON.parse(n);let c=(0,r.uE)(a,t.name);c=(0,r.IQ)(c);const l=(0,o.zj)(e,t),h=new s.k(c.chat_history||[],l).getSortedMessages();f.push((0,i.A)((0,i.A)({},c),{},{chat_history:h}))}catch(y){console.error("\u65e0\u6cd5\u5904\u7406\u6587\u4ef6 ".concat(t.name,":"),y)}}}if(0===f.length)return alert("\u6ca1\u6709\u53ef\u5bfc\u51fa\u7684\u6570\u636e"),!1;return await async function(t){const{scope:e="current",data:n=null,dataList:i=[],config:a={}}=t;try{switch(e){case"current":if(!n)throw new Error("\u6ca1\u6709\u53ef\u5bfc\u51fa\u7684\u6570\u636e");return h.exportSingleFile(n,a);case"multiple":if(0===i.length)throw new Error("\u6ca1\u6709\u53ef\u5bfc\u51fa\u7684\u6570\u636e");return h.exportMultipleFiles(i,a);default:throw new Error("\u672a\u77e5\u7684\u5bfc\u51fa\u8303\u56f4: ".concat(e))}}catch(o){return console.error("\u5bfc\u51fa\u5931\u8d25:",o),alert("\u5bfc\u51fa\u5931\u8d25: ".concat(o.message)),!1}}({scope:1===f.length?"current":"multiple",data:1===f.length?f[0]:null,dataList:f,config:(0,i.A)((0,i.A)((0,i.A)({},e),t),{},{marks:null!==u&&void 0!==u&&u.current?u.current.getMarks():{completed:new Set,important:new Set,deleted:new Set}})})}catch(w){return console.error("\u5bfc\u51fa\u5931\u8d25:",w),alert("\u5bfc\u51fa\u5931\u8d25\uff1a"+w.message),!1}}}}]);
//# sourceMappingURL=843.bdd18f0c.chunk.js.map